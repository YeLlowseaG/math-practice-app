<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆè¯­å¡«ç©º - è¯­æ–‡å­¦ä¹ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script defer src="./assets/achievements.js"></script>
    <script defer src="./wellness.js"></script>
    
    <!-- é…ç½®Tailwindè‡ªå®šä¹‰é¢œè‰²å’Œå­—ä½“ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                        neutral: '#F7FFF7',
                        text: '#1F2937'
                    },
                    fontFamily: {
                        kids: ['"Comic Sans MS"', '"Marker Felt"', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            }
            .bounce-light {
                animation: bounce-light 0.5s ease infinite alternate;
            }
            .pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .scale-hover {
                transition: transform 0.2s;
            }
            .scale-hover:hover {
                transform: scale(1.05);
            }
            .correct-animation {
                animation: correct 0.6s ease-in-out;
            }
            .wrong-animation {
                animation: wrong 0.6s ease-in-out;
            }
            .level-complete {
                animation: levelComplete 1s ease-in-out;
            }
            @keyframes bounce-light {
                from { transform: translateY(0); }
                to { transform: translateY(-5px); }
            }
            @keyframes correct {
                0% { transform: scale(1); background-color: #10B981; }
                50% { transform: scale(1.1); background-color: #34D399; }
                100% { transform: scale(1); background-color: #10B981; }
            }
            @keyframes wrong {
                0% { transform: translateX(0); background-color: #EF4444; }
                25% { transform: translateX(-5px); background-color: #F87171; }
                75% { transform: translateX(5px); background-color: #F87171; }
                100% { transform: translateX(0); background-color: #EF4444; }
            }
            @keyframes levelComplete {
                0% { transform: scale(1) rotate(0deg); }
                25% { transform: scale(1.2) rotate(5deg); }
                75% { transform: scale(1.2) rotate(-5deg); }
                100% { transform: scale(1) rotate(0deg); }
            }
            @keyframes button-press {
                0% { transform: scale(1); }
                50% { transform: scale(0.95); }
                100% { transform: scale(1); }
            }
            
            .button-press {
                animation: button-press 0.2s ease-in-out;
            }
            
            /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
            @media (max-width: 768px) {
                .option-btn {
                    min-height: 64px;
                    font-size: 1.1rem;
                    padding: 16px 12px;
                }
                .float-animation {
                    animation: none;
                }
            }
            
            @media (max-width: 480px) {
                .option-btn {
                    min-height: 72px;
                    font-size: 1rem;
                    padding: 20px 12px;
                }
                #question-text {
                    font-size: 1.5rem;
                }
            }
            
            .ripple {
                position: absolute;
                border-radius: 50%;
                background: rgba(59, 130, 246, 0.3);
                transform: scale(0);
                animation: ripple-animation 0.6s linear;
                pointer-events: none;
            }
            
            @keyframes ripple-animation {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-kids text-text overflow-hidden">
    <!-- å¼€å§‹ç•Œé¢ -->
    <div id="startPage" class="flex flex-col items-center justify-center h-screen p-6 py-6 relative">
        <!-- è¿”å›é¦–é¡µæŒ‰é’® -->
        <button onclick="window.location.href='index.html'" class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm px-4 py-2 rounded-full shadow-lg transition-all duration-300 hover:scale-105 active:scale-95 text-sm font-bold text-gray-600 hover:text-gray-800 z-40">
            <i class="fa fa-home mr-2"></i>é¦–é¡µ
        </button>
        <div class="text-center max-w-2xl mx-auto bg-white rounded-3xl shadow-2xl p-4 transform transition-all duration-500">
            <h1 class="text-[clamp(1.5rem,4vw,2.2rem)] font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary mb-3">æˆè¯­å¡«ç©º</h1>
            <p class="text-sm mb-3 text-gray-600">å¡«è¡¥æˆè¯­ä¸­çš„ç©ºç¼º<br>å­¦ä¹ ä¸­åæ–‡åŒ–ç²¾é«“ï¼</p>
            
            <div class="flex justify-center mb-3">
                <div class="w-12 h-12 bg-gradient-to-br from-primary to-secondary rounded-full flex items-center justify-center text-white text-2xl shadow-lg relative overflow-hidden">
                    <i class="fa fa-book"></i>
                    <div class="absolute inset-0 bg-white opacity-20 rounded-full animate-ping"></div>
                </div>
            </div>
            
            <!-- éš¾åº¦é€‰æ‹© -->
            <div class="mb-2">
                <h3 class="text-sm font-bold mb-2">é€‰æ‹©éš¾åº¦</h3>
                <div class="flex justify-center gap-2">
                    <button class="difficulty-btn active" data-difficulty="easy">
                        <span class="text-sm">ğŸŒ± ç®€å•</span>
                    </button>
                    <button class="difficulty-btn" data-difficulty="medium">
                        <span class="text-sm">ğŸŒ¿ ä¸­ç­‰</span>
                    </button>
                    <button class="difficulty-btn" data-difficulty="hard">
                        <span class="text-sm">ğŸŒ³ å›°éš¾</span>
                    </button>
                </div>
            </div>
            
            <!-- ä¸»é¢˜é€‰æ‹© -->
            <div class="mb-2">
                <h3 class="text-sm font-bold mb-2">é€‰æ‹©ä¸»é¢˜</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button class="theme-btn active" data-theme="nature">
                        <span class="text-sm">ğŸŒ² è‡ªç„¶</span>
                    </button>
                    <button class="theme-btn" data-theme="wisdom">
                        <span class="text-sm">ğŸ§  æ™ºæ…§</span>
                    </button>
                    <button class="theme-btn" data-theme="story">
                        <span class="text-sm">ğŸ“š æ•…äº‹</span>
                    </button>
                    <button class="theme-btn" data-theme="mixed">
                        <span class="text-sm">ğŸ² æ··åˆ</span>
                    </button>
                </div>
            </div>
            
            <!-- å€’è®¡æ—¶å¼€å…³ -->
            <div class="mb-2 flex items-center justify-center gap-2 bg-gray-50 rounded-xl p-2">
                <i class="fa fa-clock-o text-gray-600"></i>
                <span class="text-gray-700 font-medium text-xs">å€’è®¡æ—¶æ¨¡å¼</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="timer-toggle" class="sr-only peer" checked>
                    <div class="w-10 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
                <span class="text-xs text-gray-500" id="timer-description">æ ¹æ®éš¾åº¦é™æ—¶</span>
            </div>

            <!-- å¾½ç« é¢„è§ˆ -->
            <div id="badge-preview" class="mb-2">
                <h3 class="text-xs font-bold mb-1">æˆ‘çš„å¾½ç« </h3>
                <div id="badgePreview" class="flex justify-center gap-2 flex-wrap"></div>
                <div class="text-xs text-gray-400 mt-1">æœ¬æ¸¸æˆå¾½ç« é¢„è§ˆï¼ˆå·²è·é«˜äº®ï¼Œæœªè·ç°æ˜¾ï¼‰</div>
            </div>
            
            <button id="startBtn" class="bg-accent hover:bg-yellow-400 text-white font-bold py-2 px-6 rounded-full text-base shadow-lg transform transition-all duration-300 hover:scale-105 active:scale-95 opacity-50 cursor-not-allowed" disabled>
                å¼€å§‹æŒ‘æˆ˜ <i class="fa fa-play ml-2"></i>
            </button>
            
            <div class="mt-3 text-xs text-gray-500">
                <p>é€‚åˆå¹´é¾„ï¼š6-12å²</p>
                <p>ç›®æ ‡ï¼šå¡«è¡¥æˆè¯­ç©ºç¼ºè·å¾—é«˜åˆ†ï¼</p>
            </div>
        </div>
        
        <!-- è£…é¥°å…ƒç´  -->
        <div class="absolute top-10 left-10 text-5xl text-primary/30">
            <i class="fa fa-star bounce-light"></i>
        </div>
        <div class="absolute bottom-10 right-10 text-5xl text-secondary/30">
            <i class="fa fa-heart bounce-light" style="animation-delay: 0.3s"></i>
        </div>
        <div class="absolute top-1/4 right-20 text-4xl text-accent/30">
            <i class="fa fa-trophy bounce-light" style="animation-delay: 0.6s"></i>
        </div>
    </div>

    <!-- æ¸¸æˆç•Œé¢ -->
    <div id="gamePage" class="hidden h-screen flex flex-col">
        <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
        <div class="flex justify-between items-center p-3 bg-white/80 backdrop-blur-sm shadow-md">
            <!-- å·¦ä¾§ä¿¡æ¯ -->
            <div class="flex items-center gap-3">
                <!-- è¿”å›é¦–é¡µæŒ‰é’® -->
                <button onclick="window.location.href='index.html'" class="bg-white/90 backdrop-blur-sm px-3 py-2 rounded-full shadow-md transition-all duration-300 hover:scale-105 active:scale-95 text-sm font-bold text-gray-600 hover:text-gray-800">
                    <i class="fa fa-home mr-1"></i><span class="hidden sm:inline">é¦–é¡µ</span>
                </button>
                <div class="bg-primary px-4 py-2 rounded-full text-white font-bold shadow-md">
                    <span>å…³å¡ </span><span id="currentLevel">1</span><span>/20</span>
                </div>
                <div class="bg-secondary px-4 py-2 rounded-full text-white font-bold shadow-md">
                    <span>è¿å‡» </span><span id="combo">0</span>
                </div>
                <div class="bg-accent px-4 py-2 rounded-full text-white font-bold shadow-md">
                    <span>æœ¬å…³è¿›åº¦ </span><span id="progressDisplay">1/3</span>
                </div>
            </div>
            
            <!-- ä¸­é—´è®¡æ—¶å™¨ -->
            <div id="timer" class="bg-accent text-white px-6 py-3 rounded-full shadow-md">
                <i class="fa fa-clock-o mr-2"></i>
                <span id="countdown" class="text-xl font-bold">å€’è®¡æ—¶ 30.0</span>
            </div>
            
            <!-- å³ä¾§åˆ†æ•° -->
            <div class="bg-gradient-to-r from-purple-500 to-pink-500 px-4 py-2 rounded-full text-white font-bold shadow-md">
                <i class="fa fa-star mr-2"></i>
                <span id="currentScore">0</span>
            </div>
        </div>
        
        <!-- å…³å¡è¿›åº¦æ¡ -->
        <div class="bg-gray-100 border-b border-gray-200">
            <div class="px-4 py-2">

                <div class="bg-gray-200 h-3 rounded-full overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-primary to-secondary h-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
            </div>
        </div>
        
        <!-- ä¸»è¦æ¸¸æˆåŒºåŸŸ -->
        <div class="flex-1 flex flex-col items-center p-6">
            <!-- åé¦ˆä¿¡æ¯ - ç§»åˆ°é¡¶éƒ¨ -->
            <div id="feedback" class="mb-4 text-center text-lg font-medium min-h-[2rem] flex items-center justify-center px-4">
                <!-- åé¦ˆä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
            </div>
            
            <!-- æˆè¯­é¢˜ç›®æ˜¾ç¤º -->
            <div class="bg-white rounded-3xl shadow-2xl p-8 text-center mb-6 transform transition-all duration-500">
                <p class="text-gray-500 text-lg mb-2">è¯·å¡«è¡¥æˆè¯­ä¸­çš„ç©ºç¼º</p>
                <div id="idiomQuestion" class="text-[clamp(2.5rem,6vw,4rem)] font-bold text-text mb-2 tracking-wider">
                    <!-- æˆè¯­é¢˜ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div id="idiomPinyin" class="text-lg text-gray-600 mb-4">
                    <!-- æˆè¯­æ‹¼éŸ³å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <p class="text-gray-400 text-lg" id="questionHint">é€‰æ‹©ä¸€ä¸ªå­—å¡«å…¥ç©ºç¼ºå¤„</p>
            </div>
            
            <!-- é€‰é¡¹åŒºåŸŸ -->
            <div id="optionsContainer" class="grid grid-cols-2 gap-4 max-w-xl w-full mt-auto mb-4">
                <!-- é€‰é¡¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- ç»“æœç•Œé¢ -->
    <div id="resultPage" class="hidden flex flex-col items-center justify-center h-screen p-6 bg-white/90 backdrop-blur-md">
        <div class="text-center max-w-lg mx-auto">
            <div id="result-icon" class="text-8xl mb-6">ğŸ‰</div>
            <h2 id="result-title" class="text-[clamp(2rem,5vw,3rem)] font-bold mb-6">å¤ªæ£’äº†ï¼</h2>
            
            <div class="bg-neutral rounded-2xl shadow-lg p-8 mb-8">
                <div class="grid grid-cols-2 gap-6">
                    <div class="text-center">
                        <div class="text-primary text-3xl font-bold" id="finalScore">0</div>
                        <div class="text-gray-600">æ€»åˆ†æ•°</div>
                    </div>
                    <div class="text-center">
                        <div class="text-secondary text-3xl font-bold" id="final-level">5</div>
                        <div class="text-gray-600">å®Œæˆé¢˜ç›®</div>
                    </div>
                    <div class="text-center">
                        <div class="text-accent text-3xl font-bold" id="final-accuracy">0%</div>
                        <div class="text-gray-600">å‡†ç¡®ç‡</div>
                    </div>
                    <div class="text-center">
                        <div class="text-purple-500 text-3xl font-bold" id="maxCombo">0</div>
                        <div class="text-gray-600">æœ€é«˜è¿å‡»</div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4 justify-center">
                <button id="nextLevel" class="bg-secondary hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full transition-all duration-300 hover:scale-105">
                    ä¸‹ä¸€å…³ <i class="fa fa-arrow-right ml-2"></i>
                </button>
                <button id="playAgain" class="bg-accent hover:bg-yellow-400 text-white font-bold py-3 px-6 rounded-full transition-all duration-300 hover:scale-105">
                    å†ç©ä¸€æ¬¡ <i class="fa fa-refresh ml-2"></i>
                </button>
                <button id="backToHome" class="bg-primary hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full transition-all duration-300 hover:scale-105">
                    è¿”å›é¦–é¡µ <i class="fa fa-home ml-2"></i>
                </button>
            </div>
            
            <!-- æˆå°±å±•ç¤ºåŒºåŸŸ -->
            <div id="achievements" class="mt-8">
                <!-- æˆå°±ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>



    <!-- Toast æç¤º -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur-sm text-gray-800 px-6 py-3 rounded-full shadow-lg transition-all duration-300 opacity-0 pointer-events-none z-50">
        <!-- Toast å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <script>
        // æˆè¯­æ•°æ®åº“ï¼ˆå«æ‹¼éŸ³ï¼‰
        const idiomDatabase = {
            easy: {
                nature: [
                    { idiom: "å®ˆæ ªå¾…å…”", pinyin: "shÇ’u zhÅ« dÃ i tÃ¹", missing: "æ ª", missingPinyin: "zhÅ«", options: ["æ ª", "æ ‘", "æœ¨", "è‰"], optionPinyins: ["zhÅ«", "shÃ¹", "mÃ¹", "cÇo"], hint: "æ¯”å–»æ­»å®ˆç‹­éš˜ç»éªŒï¼Œä¸çŸ¥å˜é€š" },
                    { idiom: "ç”»è›‡æ·»è¶³", pinyin: "huÃ  shÃ© tiÄn zÃº", missing: "è¶³", missingPinyin: "zÃº", options: ["è¶³", "è„š", "è…¿", "æ‰‹"], optionPinyins: ["zÃº", "jiÇo", "tuÇ", "shÇ’u"], hint: "æ¯”å–»åšäº†å¤šä½™çš„äº‹ï¼Œåè€Œæœ‰å®³æ— ç›Š" },
                    { idiom: "å¯¹ç‰›å¼¹ç´", pinyin: "duÃ¬ niÃº tÃ¡n qÃ­n", missing: "ç´", missingPinyin: "qÃ­n", options: ["ç´", "ç­", "ç¬›", "ç®«"], optionPinyins: ["qÃ­n", "zhÄ“ng", "dÃ­", "xiÄo"], hint: "æ¯”å–»å¯¹ä¸æ‡‚çš„äººè¯´æ·±å¥¥çš„é“ç†" },
                    { idiom: "äº¡ç¾Šè¡¥ç‰¢", pinyin: "wÃ¡ng yÃ¡ng bÇ” lÃ¡o", missing: "ç‰¢", missingPinyin: "lÃ¡o", options: ["ç‰¢", "åœˆ", "æ ", "é—¨"], optionPinyins: ["lÃ¡o", "quÄn", "lÃ¡n", "mÃ©n"], hint: "æ¯”å–»å‡ºäº†é—®é¢˜åŠæ—¶è¡¥æ•‘" },
                    { idiom: "äº•åº•ä¹‹è›™", pinyin: "jÇng dÇ zhÄ« wÄ", missing: "è›™", missingPinyin: "wÄ", options: ["è›™", "é±¼", "è™¾", "èŸ¹"], optionPinyins: ["wÄ", "yÃº", "xiÄ", "xiÃ¨"], hint: "æ¯”å–»è§è¯†çŸ­æµ…çš„äºº" }
                ],
                wisdom: [
                    { idiom: "å­¦è€Œä¸åŒ", pinyin: "xuÃ© Ã©r bÃ¹ yÃ n", missing: "åŒ", missingPinyin: "yÃ n", options: ["åŒ", "çƒ¦", "ç´¯", "å€¦"], optionPinyins: ["yÃ n", "fÃ¡n", "lÃ¨i", "juÃ n"], hint: "å­¦ä¹ æ€»æ„Ÿåˆ°ä¸æ»¡è¶³" },
                    { idiom: "è¯²äººä¸å€¦", pinyin: "huÃ¬ rÃ©n bÃ¹ juÃ n", missing: "å€¦", missingPinyin: "juÃ n", options: ["å€¦", "ç´¯", "åŒ", "çƒ¦"], optionPinyins: ["juÃ n", "lÃ¨i", "yÃ n", "fÃ¡n"], hint: "æ•™å¯¼åˆ«äººä¸çŸ¥ç–²å€¦" },
                    { idiom: "æ¸©æ•…çŸ¥æ–°", pinyin: "wÄ“n gÃ¹ zhÄ« xÄ«n", missing: "æ–°", missingPinyin: "xÄ«n", options: ["æ–°", "æ—§", "è€", "å¤"], optionPinyins: ["xÄ«n", "jiÃ¹", "lÇo", "gÇ”"], hint: "æ¸©ä¹ æ—§çŸ¥è¯†ï¼Œå¾—åˆ°æ–°çš„ç†è§£å’Œä½“ä¼š" },
                    { idiom: "ä¸¾ä¸€åä¸‰", pinyin: "jÇ” yÄ« fÇn sÄn", missing: "ä¸‰", missingPinyin: "sÄn", options: ["ä¸‰", "äºŒ", "å››", "äº”"], optionPinyins: ["sÄn", "Ã¨r", "sÃ¬", "wÇ”"], hint: "ä»ä¸€ä»¶äº‹æƒ…ç±»æ¨è€ŒçŸ¥é“è®¸å¤šäº‹æƒ…" },
                    { idiom: "ä¸è€»ä¸‹é—®", pinyin: "bÃ¹ chÇ xiÃ  wÃ¨n", missing: "é—®", missingPinyin: "wÃ¨n", options: ["é—®", "å­¦", "æ±‚", "æ•™"], optionPinyins: ["wÃ¨n", "xuÃ©", "qiÃº", "jiÃ o"], hint: "ä¸ä»¥å‘åœ°ä½ä½çš„äººè¯·æ•™ä¸ºè€»" }
                ],
                story: [
                    { idiom: "åˆ»èˆŸæ±‚å‰‘", pinyin: "kÃ¨ zhÅu qiÃº jiÃ n", missing: "å‰‘", missingPinyin: "jiÃ n", options: ["å‰‘", "åˆ€", "æª", "çŸ›"], optionPinyins: ["jiÃ n", "dÄo", "qiÄng", "mÃ¡o"], hint: "æ¯”å–»æ­»å®ˆæ•™æ¡ï¼Œä¸çŸ¥å˜é€š" },
                    { idiom: "æ©è€³ç›—é“ƒ", pinyin: "yÇn Ä›r dÃ o lÃ­ng", missing: "é“ƒ", missingPinyin: "lÃ­ng", options: ["é“ƒ", "é’Ÿ", "é¼“", "é”£"], optionPinyins: ["lÃ­ng", "zhÅng", "gÇ”", "luÃ³"], hint: "æ¯”å–»è‡ªå·±æ¬ºéª—è‡ªå·±" },
                    { idiom: "æ‹”è‹—åŠ©é•¿", pinyin: "bÃ¡ miÃ¡o zhÃ¹ zhÇng", missing: "é•¿", missingPinyin: "zhÇng", options: ["é•¿", "é«˜", "å¤§", "å¿«"], optionPinyins: ["zhÇng", "gÄo", "dÃ ", "kuÃ i"], hint: "æ¯”å–»è¿åäº‹ç‰©å‘å±•è§„å¾‹" },
                    { idiom: "ç‹å‡è™å¨", pinyin: "hÃº jiÇ hÇ” wÄ“i", missing: "å¨", missingPinyin: "wÄ“i", options: ["å¨", "åŠ¿", "åŠ›", "æƒ"], optionPinyins: ["wÄ“i", "shÃ¬", "lÃ¬", "quÃ¡n"], hint: "æ¯”å–»å€šä»—åˆ«äººçš„æƒåŠ¿æ¥æ¬ºå‹äºº" },
                    { idiom: "å—è¾•åŒ—è¾™", pinyin: "nÃ¡n yuÃ¡n bÄ›i zhÃ©", missing: "å­—", missingPinyin: "zhÃ©", options: ["è¾™", "è·¯", "é“", "å¾„"], optionPinyins: ["zhÃ©", "lÃ¹", "dÃ o", "jÃ¬ng"], hint: "æ¯”å–»è¡ŒåŠ¨å’Œç›®çš„ç›¸å" }
                ],
                mixed: [
                    { idiom: "ä¸€ç®­åŒé›•", pinyin: "yÄ« jiÃ n shuÄng diÄo", missing: "é›•", missingPinyin: "diÄo", options: ["é›•", "é¸Ÿ", "é¹°", "é›"], optionPinyins: ["diÄo", "niÇo", "yÄ«ng", "yÃ n"], hint: "æ¯”å–»ä¸€ä¸¾ä¸¤å¾—" },
                    { idiom: "å››é¢æ¥šæ­Œ", pinyin: "sÃ¬ miÃ n chÇ” gÄ“", missing: "æ­Œ", missingPinyin: "gÄ“", options: ["æ­Œ", "å£°", "éŸ³", "æ›²"], optionPinyins: ["gÄ“", "shÄ“ng", "yÄ«n", "qÇ”"], hint: "æ¯”å–»å››é¢å—æ•Œï¼Œå­¤ç«‹æ— æ´" },
                    { idiom: "æœ›æ¢…æ­¢æ¸´", pinyin: "wÃ ng mÃ©i zhÇ kÄ›", missing: "æ¢…", missingPinyin: "mÃ©i", options: ["æ¢…", "æ¡ƒ", "æ", "æ"], optionPinyins: ["mÃ©i", "tÃ¡o", "lÇ", "xÃ¬ng"], hint: "æ¯”å–»ç”¨ç©ºæƒ³æ¥å®‰æ…°è‡ªå·±" },
                    { idiom: "æ¯å¼“è›‡å½±", pinyin: "bÄ“i gÅng shÃ© yÇng", missing: "å½±", missingPinyin: "yÇng", options: ["å½±", "åƒ", "å½¢", "çŠ¶"], optionPinyins: ["yÇng", "xiÃ ng", "xÃ­ng", "zhuÃ ng"], hint: "æ¯”å–»ç–‘ç¥ç–‘é¬¼ï¼Œè‡ªç›¸æƒŠæ‰°" },
                    { idiom: "è‰æœ¨çš†å…µ", pinyin: "cÇo mÃ¹ jiÄ“ bÄ«ng", missing: "å…µ", missingPinyin: "bÄ«ng", options: ["å…µ", "å°†", "å£«", "å’"], optionPinyins: ["bÄ«ng", "jiÃ ng", "shÃ¬", "zÃº"], hint: "å½¢å®¹æƒŠæ…Œæ—¶ç–‘ç¥ç–‘é¬¼" }
                ]
            },
            medium: {
                nature: [
                    { idiom: "æ˜¥æš–èŠ±å¼€", pinyin: "chÅ«n nuÇn huÄ kÄi", missing: "èŠ±", missingPinyin: "huÄ", options: ["èŠ±", "è‰", "æ ‘", "å¶"], optionPinyins: ["huÄ", "cÇo", "shÃ¹", "yÃ¨"], hint: "å½¢å®¹æ˜¥å¤©æ¸©æš–ï¼Œç™¾èŠ±ç››å¼€" },
                    { idiom: "ç§‹é«˜æ°”çˆ½", pinyin: "qiÅ« gÄo qÃ¬ shuÇng", missing: "æ°”", missingPinyin: "qÃ¬", options: ["æ°”", "é£", "äº‘", "å¤©"], optionPinyins: ["qÃ¬", "fÄ“ng", "yÃºn", "tiÄn"], hint: "å½¢å®¹ç§‹å¤©å¤©ç©ºé«˜è¿œï¼Œæ°”å€™æ¸…çˆ½" },
                    { idiom: "å†°å¤©é›ªåœ°", pinyin: "bÄ«ng tiÄn xuÄ› dÃ¬", missing: "é›ª", missingPinyin: "xuÄ›", options: ["é›ª", "å†°", "éœœ", "éœ²"], optionPinyins: ["xuÄ›", "bÄ«ng", "shuÄng", "lÃ¹"], hint: "å½¢å®¹å†°é›ªè¦†ç›–çš„å¯’å†·æ™¯è±¡" },
                    { idiom: "å±±æ¸…æ°´ç§€", pinyin: "shÄn qÄ«ng shuÇ xiÃ¹", missing: "æ°´", missingPinyin: "shuÇ", options: ["æ°´", "å±±", "æ—", "çŸ³"], optionPinyins: ["shuÇ", "shÄn", "lÃ­n", "shÃ­"], hint: "å½¢å®¹å±±æ°´é£æ™¯ä¼˜ç¾" },
                    { idiom: "é¸Ÿè¯­èŠ±é¦™", pinyin: "niÇo yÇ” huÄ xiÄng", missing: "é¦™", missingPinyin: "xiÄng", options: ["é¦™", "å‘³", "æ°”", "éŸµ"], optionPinyins: ["xiÄng", "wÃ¨i", "qÃ¬", "yÃ¹n"], hint: "å½¢å®¹æ˜¥å¤©ç¾å¥½çš„æ™¯è±¡" }
                ],
                wisdom: [
                    { idiom: "çŸ¥è¶³å¸¸ä¹", pinyin: "zhÄ« zÃº chÃ¡ng lÃ¨", missing: "ä¹", missingPinyin: "lÃ¨", options: ["ä¹", "å–œ", "æ¬¢", "æ„‰"], optionPinyins: ["lÃ¨", "xÇ", "huÄn", "yÃº"], hint: "çŸ¥é“æ»¡è¶³å°±ä¼šç»å¸¸å¿«ä¹" },
                    { idiom: "åšå¾·è½½ç‰©", pinyin: "hÃ²u dÃ© zÃ i wÃ¹", missing: "ç‰©", missingPinyin: "wÃ¹", options: ["ç‰©", "äºº", "äº‹", "ç†"], optionPinyins: ["wÃ¹", "rÃ©n", "shÃ¬", "lÇ"], hint: "å“å¾·é«˜å°šçš„äººèƒ½æ‰¿æ‹…é‡ä»»" },
                    { idiom: "è‡ªå¼ºä¸æ¯", pinyin: "zÃ¬ qiÃ¡ng bÃ¹ xÄ«", missing: "æ¯", missingPinyin: "xÄ«", options: ["æ¯", "æ­¢", "åœ", "æ–­"], optionPinyins: ["xÄ«", "zhÇ", "tÃ­ng", "duÃ n"], hint: "è‡ªå·±åŠªåŠ›å‘ä¸Šï¼Œæ°¸ä¸åœæ¯" },
                    { idiom: "è§è´¤æ€é½", pinyin: "jiÃ n xiÃ¡n sÄ« qÃ­", missing: "é½", missingPinyin: "qÃ­", options: ["é½", "åŒ", "ç­‰", "å¹³"], optionPinyins: ["qÃ­", "tÃ³ng", "dÄ›ng", "pÃ­ng"], hint: "è§åˆ°æœ‰æ‰å¾·çš„äººå°±æƒ³è¦å‘ä»–çœ‹é½" },
                    { idiom: "å·±æ‰€ä¸æ¬²", pinyin: "jÇ suÇ’ bÃ¹ yÃ¹", missing: "æ¬²", missingPinyin: "yÃ¹", options: ["æ¬²", "æƒ³", "è¦", "æ„¿"], optionPinyins: ["yÃ¹", "xiÇng", "yÃ o", "yuÃ n"], hint: "è‡ªå·±ä¸æ„¿æ„çš„ï¼Œä¸è¦å¼ºåŠ ç»™åˆ«äºº" }
                ],
                story: [
                    { idiom: "å§è–ªå°èƒ†", pinyin: "wÃ² xÄ«n chÃ¡ng dÇn", missing: "èƒ†", missingPinyin: "dÇn", options: ["èƒ†", "è‹¦", "è¾›", "é…¸"], optionPinyins: ["dÇn", "kÇ”", "xÄ«n", "suÄn"], hint: "å½¢å®¹äººåˆ»è‹¦è‡ªåŠ±ï¼Œå‘å¥‹å›¾å¼º" },
                    { idiom: "ç ´é‡œæ²‰èˆŸ", pinyin: "pÃ² fÇ” chÃ©n zhÅu", missing: "èˆŸ", missingPinyin: "zhÅu", options: ["èˆŸ", "èˆ¹", "èˆ°", "è‰‡"], optionPinyins: ["zhÅu", "chuÃ¡n", "jiÃ n", "tÇng"], hint: "æ¯”å–»ä¸‹å®šå†³å¿ƒï¼Œä¸ç•™é€€è·¯" },
                    { idiom: "èƒŒæ°´ä¸€æˆ˜", pinyin: "bÃ¨i shuÇ yÄ« zhÃ n", missing: "æˆ˜", missingPinyin: "zhÃ n", options: ["æˆ˜", "æ–—", "äº‰", "æ"], optionPinyins: ["zhÃ n", "dÃ²u", "zhÄ“ng", "bÃ³"], hint: "æ¯”å–»åœ¨ç»å¢ƒä¸­ä½œæœ€åçš„æ–—äº‰" },
                    { idiom: "å››é¢æ¥šæ­Œ", pinyin: "sÃ¬ miÃ n chÇ” gÄ“", missing: "æ­Œ", missingPinyin: "gÄ“", options: ["æ­Œ", "å£°", "éŸ³", "æ›²"], optionPinyins: ["gÄ“", "shÄ“ng", "yÄ«n", "qÇ”"], hint: "æ¯”å–»å››é¢å—æ•Œï¼Œå­¤ç«‹æ— æ´" },
                    { idiom: "è‰æœ¨çš†å…µ", pinyin: "cÇo mÃ¹ jiÄ“ bÄ«ng", missing: "å…µ", missingPinyin: "bÄ«ng", options: ["å…µ", "å°†", "å£«", "å’"], optionPinyins: ["bÄ«ng", "jiÃ ng", "shÃ¬", "zÃº"], hint: "å½¢å®¹æƒŠæ…Œæ—¶ç–‘ç¥ç–‘é¬¼" }
                ],
                mixed: [
                    { idiom: "ä¸€é¸£æƒŠäºº", pinyin: "yÄ« mÃ­ng jÄ«ng rÃ©n", missing: "æƒŠ", missingPinyin: "jÄ«ng", options: ["æƒŠ", "åŠ¨", "éœ‡", "å“"], optionPinyins: ["jÄ«ng", "dÃ²ng", "zhÃ¨n", "xiÇng"], hint: "æ¯”å–»å¹³æ—¶é»˜é»˜æ— é—»ï¼Œçªç„¶åšå‡ºæƒŠäººçš„æˆç»©" },
                    { idiom: "ç™¾å‘ç™¾ä¸­", pinyin: "bÇi fÄ bÇi zhÃ²ng", missing: "å­—", missingPinyin: "zhÃ²ng", options: ["ä¸­", "å‡†", "å¯¹", "æ­£"], optionPinyins: ["zhÃ²ng", "zhÇ”n", "duÃ¬", "zhÃ¨ng"], hint: "å½¢å®¹å°„ç®­æˆ–å°„å‡»éå¸¸å‡†ç¡®" },
                    { idiom: "åƒé’§ä¸€å‘", pinyin: "qiÄn jÅ«n yÄ« fÃ ", missing: "å‘", missingPinyin: "fÃ ", options: ["å‘", "ä¸", "çº¿", "ç»³"], optionPinyins: ["fÃ ", "sÄ«", "xiÃ n", "shÃ©ng"], hint: "æ¯”å–»æƒ…å†µä¸‡åˆ†å±æ€¥" },
                    { idiom: "ä¸‡æ— ä¸€å¤±", pinyin: "wÃ n wÃº yÄ« shÄ«", missing: "å¤±", missingPinyin: "shÄ«", options: ["å¤±", "é”™", "è¯¯", "å·®"], optionPinyins: ["shÄ«", "cuÃ²", "wÃ¹", "chÄ"], hint: "å½¢å®¹éå¸¸æœ‰æŠŠæ¡ï¼Œç»å¯¹ä¸ä¼šå‡ºå·®é”™" },
                    { idiom: "åå…¨åç¾", pinyin: "shÃ­ quÃ¡n shÃ­ mÄ›i", missing: "ç¾", missingPinyin: "mÄ›i", options: ["ç¾", "å¥½", "å–„", "ä½³"], optionPinyins: ["mÄ›i", "hÇo", "shÃ n", "jiÄ"], hint: "å½¢å®¹å®Œç¾æ— ç¼º" }
                ]
            },
            hard: {
                nature: [
                    { idiom: "æµ·é˜”å¤©ç©º", pinyin: "hÇi kuÃ² tiÄn kÅng", missing: "ç©º", missingPinyin: "kÅng", options: ["ç©º", "é˜”", "å¹¿", "å¤§"], optionPinyins: ["kÅng", "kuÃ²", "guÇng", "dÃ "], hint: "å½¢å®¹ç©ºé—´å¹¿é˜”ï¼Œæ¯”å–»å¿ƒèƒ¸å¼€é˜”" },
                    { idiom: "å±±é‡æ°´å¤", pinyin: "shÄn chÃ³ng shuÇ fÃ¹", missing: "å¤", missingPinyin: "fÃ¹", options: ["å¤", "é‡", "å ", "å±‚"], optionPinyins: ["fÃ¹", "chÃ³ng", "diÃ©", "cÃ©ng"], hint: "å½¢å®¹å±±å³¦é‡å ï¼Œæ°´æµæ›²æŠ˜" },
                    { idiom: "é£èµ·äº‘æ¶Œ", pinyin: "fÄ“ng qÇ yÃºn yÇ’ng", missing: "æ¶Œ", missingPinyin: "yÇ’ng", options: ["æ¶Œ", "èµ·", "å‡", "è…¾"], optionPinyins: ["yÇ’ng", "qÇ", "shÄ“ng", "tÃ©ng"], hint: "å½¢å®¹äº‹ç‰©è¿…é€Ÿå‘å±•ï¼Œå£°åŠ¿æµ©å¤§" },
                    { idiom: "æ—¥æ–°æœˆå¼‚", pinyin: "rÃ¬ xÄ«n yuÃ¨ yÃ¬", missing: "å¼‚", missingPinyin: "yÃ¬", options: ["å¼‚", "æ–°", "å˜", "æ”¹"], optionPinyins: ["yÃ¬", "xÄ«n", "biÃ n", "gÇi"], hint: "å½¢å®¹å‘å±•å˜åŒ–å¾ˆå¿«" },
                    { idiom: "å¤©ç¿»åœ°è¦†", pinyin: "tiÄn fÄn dÃ¬ fÃ¹", missing: "è¦†", missingPinyin: "fÃ¹", options: ["è¦†", "ç¿»", "è½¬", "å˜"], optionPinyins: ["fÃ¹", "fÄn", "zhuÇn", "biÃ n"], hint: "å½¢å®¹å˜åŒ–å·¨å¤§è€Œå½»åº•" }
                ],
                wisdom: [
                    { idiom: "å­¦æµ·æ— æ¶¯", pinyin: "xuÃ© hÇi wÃº yÃ¡", missing: "æ¶¯", missingPinyin: "yÃ¡", options: ["æ¶¯", "è¾¹", "é™…", "é™"], optionPinyins: ["yÃ¡", "biÄn", "jÃ¬", "xiÃ n"], hint: "å­¦é—®çš„æµ·æ´‹æ²¡æœ‰è¾¹é™…" },
                    { idiom: "ä¹¦å±±æœ‰è·¯", pinyin: "shÅ« shÄn yÇ’u lÃ¹", missing: "å­—", missingPinyin: "lÃ¹", options: ["è·¯", "å¾„", "é“", "é€”"], optionPinyins: ["lÃ¹", "jÃ¬ng", "dÃ o", "tÃº"], hint: "ä¹¦å±±æœ‰è·¯å‹¤ä¸ºå¾„" },
                    { idiom: "ä¸šç²¾äºå‹¤", pinyin: "yÃ¨ jÄ«ng yÃº qÃ­n", missing: "å‹¤", missingPinyin: "qÃ­n", options: ["å‹¤", "å¥‹", "åŠª", "åŠ›"], optionPinyins: ["qÃ­n", "fÃ¨n", "nÇ”", "lÃ¬"], hint: "å­¦ä¸šç²¾æ·±æ˜¯ç”±äºå‹¤å¥‹" },
                    { idiom: "è¡Œæˆäºæ€", pinyin: "xÃ­ng chÃ©ng yÃº sÄ«", missing: "æ€", missingPinyin: "sÄ«", options: ["æ€", "è€ƒ", "æƒ³", "è™‘"], optionPinyins: ["sÄ«", "kÇo", "xiÇng", "lÇœ"], hint: "è¡ŒåŠ¨çš„æˆåŠŸåœ¨äºæ€è€ƒ" },
                    { idiom: "å¾·é«˜æœ›é‡", pinyin: "dÃ© gÄo wÃ ng zhÃ²ng", missing: "æœ›", missingPinyin: "wÃ ng", options: ["æœ›", "é‡", "é«˜", "å°Š"], optionPinyins: ["wÃ ng", "zhÃ²ng", "gÄo", "zÅ«n"], hint: "é“å¾·é«˜å°šï¼Œå£°æœ›å¾ˆé«˜" }
                ],
                story: [
                    { idiom: "ç²¾å«å¡«æµ·", pinyin: "jÄ«ng wÃ¨i tiÃ¡n hÇi", missing: "æµ·", missingPinyin: "hÇi", options: ["æµ·", "æ´‹", "æ¹–", "æ²³"], optionPinyins: ["hÇi", "yÃ¡ng", "hÃº", "hÃ©"], hint: "æ¯”å–»æ„å¿—åšå†³ï¼Œä¸ç•è‰°éš¾" },
                    { idiom: "æ„šå…¬ç§»å±±", pinyin: "yÃº gÅng yÃ­ shÄn", missing: "å±±", missingPinyin: "shÄn", options: ["å±±", "å³°", "å²­", "ä¸˜"], optionPinyins: ["shÄn", "fÄ“ng", "lÇng", "qiÅ«"], hint: "æ¯”å–»åšäº‹æœ‰æ¯…åŠ›ï¼Œä¸æ€•å›°éš¾" },
                    { idiom: "å¤¸çˆ¶è¿½æ—¥", pinyin: "kuÄ fÃ¹ zhuÄ« rÃ¬", missing: "æ—¥", missingPinyin: "rÃ¬", options: ["æ—¥", "é˜³", "å…‰", "æ˜"], optionPinyins: ["rÃ¬", "yÃ¡ng", "guÄng", "mÃ­ng"], hint: "æ¯”å–»äººæœ‰å¤§å¿—ï¼Œä¹Ÿæ¯”å–»ä¸è‡ªé‡åŠ›" },
                    { idiom: "å¥³å¨²è¡¥å¤©", pinyin: "nÇš wÄ bÇ” tiÄn", missing: "å¤©", missingPinyin: "tiÄn", options: ["å¤©", "ç©º", "ç©¹", "å®‡"], optionPinyins: ["tiÄn", "kÅng", "qiÃ³ng", "yÇ”"], hint: "æ¯”å–»äººæœ‰å¤§å¿—ï¼Œä¹Ÿæ¯”å–»ä¸è‡ªé‡åŠ›" },
                    { idiom: "ç›˜å¤å¼€å¤©", pinyin: "pÃ¡n gÇ” kÄi tiÄn", missing: "å¤©", missingPinyin: "tiÄn", options: ["å¤©", "åœ°", "å®‡", "å®™"], optionPinyins: ["tiÄn", "dÃ¬", "yÇ”", "zhÃ²u"], hint: "æ¯”å–»å¼€åˆ›äº‹ä¸š" }
                ],
                mixed: [
                    { idiom: "ä¸€é©¬å½“å…ˆ", pinyin: "yÄ« mÇ dÄng xiÄn", missing: "å…ˆ", missingPinyin: "xiÄn", options: ["å…ˆ", "å‰", "é¦–", "å‰"], optionPinyins: ["xiÄn", "qiÃ¡n", "shÇ’u", "qiÃ¡n"], hint: "å½¢å®¹é¢†å…ˆï¼Œå¸¦å¤´" },
                    { idiom: "ç™¾å°ºç«¿å¤´", pinyin: "bÇi chÇ gÄn tÃ³u", missing: "å¤´", missingPinyin: "tÃ³u", options: ["å¤´", "ç«¯", "é¡¶", "å°–"], optionPinyins: ["tÃ³u", "duÄn", "dÇng", "jiÄn"], hint: "æ¯”å–»å­¦é—®ã€æˆç»©ç­‰è¾¾åˆ°äº†å¾ˆé«˜çš„ç¨‹åº¦" },
                    { idiom: "åƒè½½éš¾é€¢", pinyin: "qiÄn zÇi nÃ¡n fÃ©ng", missing: "é€¢", missingPinyin: "fÃ©ng", options: ["é€¢", "é‡", "è§", "é‡"], optionPinyins: ["fÃ©ng", "yÃ¹", "jiÃ n", "yÃ¹"], hint: "å½¢å®¹æœºä¼šæå…¶éš¾å¾—" },
                    { idiom: "ä¸‡å¤é•¿é’", pinyin: "wÃ n gÇ” chÃ¡ng qÄ«ng", missing: "é’", missingPinyin: "qÄ«ng", options: ["é’", "ç»¿", "ç¿ ", "ç¢§"], optionPinyins: ["qÄ«ng", "lÇœ", "cuÃ¬", "bÃ¬"], hint: "æ¯”å–»ç²¾ç¥æˆ–å‹è°Šæ°¸è¿œå­˜åœ¨" },
                    { idiom: "åƒç§‹ä¸‡ä»£", pinyin: "qiÄn qiÅ« wÃ n dÃ i", missing: "ä»£", missingPinyin: "dÃ i", options: ["ä»£", "ä¸–", "å¹´", "å²"], optionPinyins: ["dÃ i", "shÃ¬", "niÃ¡n", "suÃ¬"], hint: "å½¢å®¹æ—¶é—´å¾ˆé•¿" }
                ]
            }
        };

        // éš¾åº¦é…ç½®
        const difficultyConfig = {
            easy: { timeLimit: 30 },
            medium: { timeLimit: 25 },
            hard: { timeLimit: 20 }
        };

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            difficulty: 'easy',
            theme: 'nature',
            currentLevel: 1,
            currentQuestionIndex: 0, // å½“å‰å…³å¡å†…çš„é¢˜ç›®ç´¢å¼•
            score: 0,
            combo: 0,
            maxCombo: 0,
            correctCount: 0,
            totalQuestions: 5,
            timeLeft: 30,
            isTimerEnabled: true,
            timer: null,
            currentQuestion: null,
            levelQuestions: {} // æ¯å…³çš„é¢˜ç›®
        };

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
            renderBadgePreview();
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        function initializeGame() {
            // éš¾åº¦é€‰æ‹©
            document.querySelectorAll('.difficulty-btn').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.difficulty-btn').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    gameState.difficulty = this.dataset.difficulty;
                    checkStartButton();
                });
            });

            // ä¸»é¢˜é€‰æ‹©
            document.querySelectorAll('.theme-btn').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.theme-btn').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    gameState.theme = this.dataset.theme;
                    checkStartButton();
                });
            });

            // å¼€å§‹æŒ‰é’®
            const startBtn = document.getElementById('startBtn');
            startBtn.addEventListener('click', startGame);

            // è¿”å›æŒ‰é’®
            document.getElementById('playAgain').addEventListener('click', startGame);
            document.getElementById('backToHome').addEventListener('click', () => window.location.href = 'index.html');

            // é»˜è®¤é€‰æ‹©
            document.querySelector('[data-difficulty="easy"]').click();
            document.querySelector('[data-theme="nature"]').click();
        }

        // æ£€æŸ¥å¼€å§‹æŒ‰é’®çŠ¶æ€
        function checkStartButton() {
            const startBtn = document.getElementById('startBtn');
            if (gameState.difficulty && gameState.theme) {
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                startBtn.disabled = true;
                startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // æ¸²æŸ“å¾½ç« é¢„è§ˆ
        function renderBadgePreview() {
            if (!window.achievements || !window.achievements.getByScope) {
                setTimeout(renderBadgePreview, 150);
                return;
            }

            const badges = window.achievements.getByScope('game:idiom_fill');
            const container = document.getElementById('badgePreview');
            container.innerHTML = '';

            badges.forEach(badge => {
                const earned = !!badge.earned;
                const badgeEl = document.createElement('div');
                badgeEl.className = `relative flex-shrink-0 w-20 h-20 rounded-2xl border-2 bg-gradient-to-br ${earned ? 'from-yellow-100 to-orange-100 border-yellow-300' : 'from-gray-50 to-gray-100 border-gray-200 opacity-80'} shadow-sm flex flex-col items-center justify-center overflow-hidden`;
                
                // å¾½ç« å†…å®¹
                badgeEl.innerHTML = `
                    <div class="text-2xl mb-1">${badge.icon}</div>
                    <div class="text-[10px] font-bold text-center leading-tight px-1 ${earned ? 'text-amber-900' : 'text-gray-400'}">${badge.name}</div>
                    <div class="absolute right-1 top-1 ${earned ? 'bg-amber-400' : 'bg-gray-400'} text-white text-[10px] px-1 rounded-full shadow">${earned ? 'å·²è·' : 'æœªè·'}</div>
                `;
                
                badgeEl.title = `${badge.name}: ${badge.desc} ${earned ? 'âœ… å·²è·å¾—' : 'âŒ æœªè·å¾—'}`;
                container.appendChild(badgeEl);
            });
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            // è®¾ç½®æ¯å…³æˆè¯­æ•°
            gameState.questionsPerLevel = 3; // æ¯å…³3ä¸ªæˆè¯­
            gameState.totalQuestions = 20;
            
            // ç”Ÿæˆé¢˜ç›®
            generateQuestions();
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.currentLevel = 1;
            gameState.currentQuestionIndex = 0; // å½“å‰å…³å¡å†…çš„é¢˜ç›®ç´¢å¼•
            gameState.score = 0;
            gameState.combo = 0;
            gameState.maxCombo = 0;
            gameState.correctCount = 0;
            gameState.timeLeft = difficultyConfig[gameState.difficulty].timeLimit;
            
            // æ˜¾ç¤ºæ¸¸æˆé¡µé¢
            showGamePage();
            
            // æ˜¾ç¤ºç¬¬ä¸€é¢˜
            showQuestion();
            
            // æ›´æ–°è¿›åº¦æ¡
            updateProgress();
            
            // å¼€å§‹è®¡æ—¶
            if (gameState.isTimerEnabled) {
                startTimer();
            }
            
            // é‡ç½®æˆå°±æ˜¾ç¤º
            document.getElementById('achievements').innerHTML = '';
        }

        // ç”Ÿæˆé¢˜ç›®
        function generateQuestions() {
            const difficulty = gameState.difficulty;
            const theme = gameState.theme;
            const allQuestions = idiomDatabase[difficulty][theme];
            
            // ä¸ºæ¯å…³ç”Ÿæˆä¸åŒçš„é¢˜ç›®
            gameState.levelQuestions = {};
            
            // ä¸ºæ¯ä¸ªå…³å¡ç”Ÿæˆ3ä¸ªä¸é‡å¤çš„æˆè¯­
            for (let level = 1; level <= gameState.totalQuestions; level++) {
                const shuffled = [...allQuestions].sort(() => Math.random() - 0.5);
                gameState.levelQuestions[level] = shuffled.slice(0, gameState.questionsPerLevel);
            }
        }

        // æ˜¾ç¤ºæ¸¸æˆé¡µé¢
        function showGamePage() {
            document.getElementById('startPage').classList.add('hidden');
            document.getElementById('resultPage').classList.add('hidden');
            document.getElementById('gamePage').classList.remove('hidden');
            
            // é‡ç½®åé¦ˆä¿¡æ¯
            document.getElementById('feedback').innerHTML = '';
            
            // é‡ç½®è¿›åº¦æ¡
            document.getElementById('progressBar').style.width = '0%';
        }

        // æ˜¾ç¤ºå¼€å§‹é¡µé¢
        function showStartPage() {
            document.getElementById('gamePage').classList.add('hidden');
            document.getElementById('resultPage').classList.add('hidden');
            document.getElementById('startPage').classList.remove('hidden');
            
            // åœæ­¢è®¡æ—¶
            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }
        }
        
        // è¿›å…¥ä¸‹ä¸€å…³
        function nextLevel() {
            gameState.currentLevel++;
            gameState.currentQuestionIndex = 0; // é‡ç½®å…³å¡å†…é¢˜ç›®ç´¢å¼•
            gameState.combo = 0;
            gameState.timeLeft = difficultyConfig[gameState.difficulty].timeLimit;
            
            // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
            showGamePage();
            
            // æ˜¾ç¤ºä¸‹ä¸€é¢˜
            showQuestion();
            
            // æ›´æ–°è¿›åº¦æ¡
            updateProgress();
            
            // æ›´æ–°æ˜¾ç¤ºï¼ˆåŒ…æ‹¬å…³å¡æ˜¾ç¤ºï¼‰
            updateDisplay();
            
            // å¼€å§‹è®¡æ—¶
            if (gameState.isTimerEnabled) {
                startTimer();
            }
        }
        
        // æ›´æ–°è®¡æ—¶å™¨æè¿°
        function updateTimerDescription() {
            const description = document.getElementById('timer-description');
            if (!gameState.isTimerEnabled) {
                description.textContent = 'ä¸é™æ—¶æ¨¡å¼';
            } else {
                const config = difficultyConfig[gameState.difficulty];
                description.textContent = `æ ¹æ®éš¾åº¦é™æ—¶`;
            }
        }

        // æ˜¾ç¤ºé¢˜ç›®
        function showQuestion() {
            if (gameState.currentLevel > gameState.totalQuestions) {
                endGame();
                return;
            }

            // è·å–å½“å‰å…³å¡çš„é¢˜ç›®
            const currentLevelQuestions = gameState.levelQuestions[gameState.currentLevel];
            if (!currentLevelQuestions || gameState.currentQuestionIndex >= currentLevelQuestions.length) {
                endGame();
                return;
            }

            gameState.currentQuestion = currentLevelQuestions[gameState.currentQuestionIndex];
            
            // æ¸…ç©ºåé¦ˆåŒºåŸŸ
            document.getElementById('feedback').innerHTML = '';
            
            // æ›´æ–°é¢˜ç›®æ˜¾ç¤º
            const questionEl = document.getElementById('idiomQuestion');
            const pinyinEl = document.getElementById('idiomPinyin');
            const idiom = gameState.currentQuestion.idiom;
            const missing = gameState.currentQuestion.missing;
            const missingIndex = idiom.indexOf(missing);
            const pinyin = gameState.currentQuestion.pinyin;
            
            let displayText = '';
            let displayPinyin = '';
            for (let i = 0; i < idiom.length; i++) {
                if (i === missingIndex) {
                    displayText += '<span class="text-orange-400 border-b-2 border-transparent px-1">_</span>';
                    displayPinyin += '<span class="text-orange-400 border-b-2 border-transparent px-1">_</span>';
                } else {
                    displayText += idiom[i];
                    displayPinyin += pinyin.split(' ')[i];
                }
                if (i < idiom.length - 1) {
                    displayPinyin += ' ';
                }
            }
            questionEl.innerHTML = displayText;
            pinyinEl.innerHTML = displayPinyin;

            // æ›´æ–°æç¤º
            document.getElementById('questionHint').textContent = gameState.currentQuestion.hint;

            // ç”Ÿæˆé€‰é¡¹
            generateOptions();

            // æ›´æ–°è¿›åº¦
            updateProgress();
        }

        // ç”Ÿæˆé€‰é¡¹
        function generateOptions() {
            const container = document.getElementById('optionsContainer');
            const options = gameState.currentQuestion.options;
            const optionPinyins = gameState.currentQuestion.optionPinyins;
            const correctAnswer = gameState.currentQuestion.missing;
            
            container.innerHTML = '';
            
            // æ‰“ä¹±é€‰é¡¹é¡ºåº
            const shuffledOptions = [...options].sort(() => Math.random() - 0.5);
            const shuffledPinyins = [...optionPinyins].sort(() => Math.random() - 0.5);
            
            shuffledOptions.forEach((option, index) => {
                const optionEl = document.createElement('div');
                optionEl.className = 'bg-white rounded-2xl p-4 text-center cursor-pointer transition-all duration-300 text-xl font-bold text-text shadow-lg hover:shadow-xl hover:scale-105';
                
                // æ‰¾åˆ°å¯¹åº”çš„æ‹¼éŸ³
                const originalIndex = options.indexOf(option);
                const pinyin = optionPinyins[originalIndex];
                
                optionEl.innerHTML = `
                    <div class="text-2xl mb-1">${option}</div>
                    <div class="text-sm text-gray-500">${pinyin}</div>
                `;
                
                optionEl.addEventListener('click', () => selectOption(option, optionEl));
                container.appendChild(optionEl);
            });
        }

        // é€‰æ‹©é€‰é¡¹
        function selectOption(selected, optionEl) {
            const correctAnswer = gameState.currentQuestion.missing;
            const isCorrect = selected === correctAnswer;
            
            if (isCorrect) {
                // æ­£ç¡®ç­”æ¡ˆ
                optionEl.classList.add('correct-animation');
                
                // è®¡ç®—åˆ†æ•°ï¼šåŸºç¡€åˆ†10åˆ† + è¿å‡»å¥–åŠ± + æ—¶é—´å¥–åŠ±
                const baseScore = 10;
                const comboBonus = gameState.combo * 2;
                const timeBonus = Math.max(0, Math.floor(gameState.timeLeft / 5)); // å‰©ä½™æ—¶é—´å¥–åŠ±
                const totalScore = baseScore + comboBonus + timeBonus;
                
                gameState.score += totalScore;
                gameState.combo++;
                gameState.correctCount++;
                gameState.maxCombo = Math.max(gameState.maxCombo, gameState.combo);
                
                // æ¸…ç©ºæ¸¸æˆç•Œé¢åé¦ˆåŒºåŸŸ
                document.getElementById('feedback').innerHTML = '';
                
                // åœ¨toastä¸­æ˜¾ç¤ºè¿å‡»ä¿¡æ¯
                let toastMessage = 'å¤ªæ£’äº†ï¼ç­”å¯¹äº†ï¼';
                if (gameState.combo >= 3) {
                    toastMessage += ` ğŸ”¥ ${gameState.combo}è¿å‡»ï¼`;
                } else if (gameState.combo >= 2) {
                    toastMessage += ` âš¡ ${gameState.combo}è¿å‡»ï¼`;
                }
                showToast(toastMessage, 'success');
                
                // æ£€æŸ¥æ˜¯å¦å®Œæˆå½“å‰å…³å¡
                gameState.currentQuestionIndex++;
                if (gameState.currentQuestionIndex >= gameState.questionsPerLevel) {
                    // å®Œæˆå½“å‰å…³å¡ï¼Œæ˜¾ç¤ºç»“æœé¡µé¢
                    setTimeout(() => {
                        showResultPage();
                    }, 1000);
                } else {
                    // ç»§ç»­å½“å‰å…³å¡çš„ä¸‹ä¸€é¢˜
                    setTimeout(() => {
                        showQuestion();
                        updateProgress();
                    }, 1000);
                }
            } else {
                // é”™è¯¯ç­”æ¡ˆ
                optionEl.classList.add('wrong-animation');
                gameState.combo = 0;
                
                // æ¸…ç©ºæ¸¸æˆç•Œé¢åé¦ˆåŒºåŸŸ
                document.getElementById('feedback').innerHTML = '';
                showToast(`æ²¡å…³ç³»ï¼Œç»§ç»­åŠ æ²¹ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${correctAnswer}`, 'error');
                
                // æ£€æŸ¥æ˜¯å¦å®Œæˆå½“å‰å…³å¡
                gameState.currentQuestionIndex++;
                if (gameState.currentQuestionIndex >= gameState.questionsPerLevel) {
                    // å®Œæˆå½“å‰å…³å¡ï¼Œæ˜¾ç¤ºç»“æœé¡µé¢
                    setTimeout(() => {
                        showResultPage();
                    }, 1000);
                } else {
                    // ç»§ç»­å½“å‰å…³å¡çš„ä¸‹ä¸€é¢˜
                    setTimeout(() => {
                        showQuestion();
                        updateProgress();
                    }, 1000);
                }
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updateDisplay();
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            document.getElementById('currentLevel').textContent = gameState.currentLevel;
            document.getElementById('currentScore').textContent = gameState.score;
            document.getElementById('combo').textContent = gameState.combo;
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            // è®¡ç®—æœ¬å…³è¿›åº¦ï¼šå½“å‰å…³å¡å†…çš„é¢˜ç›®è¿›åº¦
            const currentLevelProgress = gameState.currentQuestionIndex / gameState.questionsPerLevel * 100;
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            console.log('æ›´æ–°è¿›åº¦:', {
                currentQuestionIndex: gameState.currentQuestionIndex,
                questionsPerLevel: gameState.questionsPerLevel,
                progress: currentLevelProgress + '%'
            });
            
            document.getElementById('progressBar').style.width = currentLevelProgress + '%';
            
            // æ›´æ–°è¿›åº¦æ˜¾ç¤º - æ˜¾ç¤ºå·²å®Œæˆçš„é¢˜ç›®æ•° / æ€»é¢˜ç›®æ•°
            document.getElementById('progressDisplay').textContent = `${gameState.currentQuestionIndex}/${gameState.questionsPerLevel}`;
        }

        // å¼€å§‹è®¡æ—¶
        function startTimer() {
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('countdown').textContent = `å€’è®¡æ—¶ ${gameState.timeLeft}.0`;
                
                // æ—¶é—´ä¸è¶³æ—¶çš„è­¦å‘Š
                if (gameState.timeLeft <= 5) {
                    document.getElementById('countdown').classList.add('text-red-500', 'animate-pulse');
                } else {
                    document.getElementById('countdown').classList.remove('text-red-500', 'animate-pulse');
                }
                
                                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    // æ¸…ç©ºæ¸¸æˆç•Œé¢åé¦ˆåŒºåŸŸ
                    document.getElementById('feedback').innerHTML = '';
                    showToast('æ—¶é—´åˆ°ï¼', 'error');
                    
                    // å»¶è¿Ÿ1ç§’åè‡ªåŠ¨è¿›å…¥ç»“æœé¡µ
                    setTimeout(() => {
                        showResultPage();
                    }, 1000);
                }
            }, 1000);
        }

        // ç»“æŸæ¸¸æˆ
        function endGame() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }
            
            // è§£é”æˆå°±
            const achievements = [];
            if (window.achievements && window.achievements.unlockAchievement) {
                if (gameState.correctCount > 0) {
                    if (window.achievements.unlockAchievement('idm_first_finish')) {
                        achievements.push({ icon: 'ğŸ“š', name: 'æˆè¯­åˆä½“éªŒ' });
                    }
                    // è§£é”ç³»ç»Ÿçº§å¾½ç« 
                    window.achievements.unlockAchievement('global_first_game');
                }
                if (gameState.score >= 50) {
                    if (window.achievements.unlockAchievement('idm_high_score')) {
                        achievements.push({ icon: 'â­', name: 'æˆè¯­é«˜æ‰‹' });
                    }
                }
                if (gameState.maxCombo >= 3) {
                    if (window.achievements.unlockAchievement('idm_combo_master')) {
                        achievements.push({ icon: 'ğŸ”¥', name: 'è¿å‡»å¤§å¸ˆ' });
                    }
                }
            }
            
            // è®°å½•åˆ°å­¦ä¹ ä¸­å¿ƒï¼ˆè¯­æ–‡-æˆè¯­ï¼‰
            try {
                if (window.recordLearningProgress) {
                    const accuracy = Math.round((gameState.correctCount / gameState.totalQuestions) * 100);
                    const totalTime = gameState.totalQuestions * 30; // æ€»ç”¨æ—¶
                    window.recordLearningProgress('chinese', 'idioms', accuracy, totalTime);
                }
            } catch (_) {}
            
            // æ˜¾ç¤ºç»“æœé¡µé¢
            showResultPage();
            
            // æ˜¾ç¤ºæˆå°±
            if (achievements.length > 0) {
                const achievementsEl = document.getElementById('achievements');
                achievementsEl.innerHTML = `
                    <h3 class="text-lg font-bold mb-4">è·å¾—æˆå°±</h3>
                    <div class="flex flex-wrap justify-center gap-3">
                        ${achievements.map(achievement => `
                            <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-4 py-2 rounded-full text-sm">
                                <span class="mr-2">${achievement.icon}</span>
                                <span>${achievement.name}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºç»“æœé¡µé¢
        function showResultPage() {
            document.getElementById('gamePage').classList.add('hidden');
            document.getElementById('startPage').classList.add('hidden');
            document.getElementById('resultPage').classList.remove('hidden');
            
            // æ›´æ–°ç»“æœ
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('final-level').textContent = gameState.currentLevel;
            document.getElementById('final-accuracy').textContent = `${Math.round((gameState.correctCount / gameState.currentLevel) * 100)}%`;
            document.getElementById('maxCombo').textContent = gameState.maxCombo;
            
            // æ ¹æ®è¡¨ç°æ˜¾ç¤ºä¸åŒçš„ç»“æœ
            const resultIcon = document.getElementById('result-icon');
            const resultTitle = document.getElementById('result-title');
            const accuracy = Math.round((gameState.correctCount / gameState.currentLevel) * 100);
            
            if (accuracy >= 90) {
                resultIcon.textContent = 'ğŸ†';
                resultTitle.textContent = 'å®Œç¾è¡¨ç°ï¼';
            } else if (accuracy >= 70) {
                resultIcon.textContent = 'ğŸ‰';
                resultTitle.textContent = 'å¾ˆæ£’ï¼';
            } else if (accuracy >= 50) {
                resultIcon.textContent = 'ğŸ‘';
                resultTitle.textContent = 'ä¸é”™å“¦ï¼';
            } else {
                resultIcon.textContent = 'ğŸ’ª';
                resultTitle.textContent = 'ç»§ç»­åŠªåŠ›ï¼';
            }
            
            // æ§åˆ¶"ä¸‹ä¸€å…³"æŒ‰é’®çš„æ˜¾ç¤º
            const nextLevelBtn = document.getElementById('nextLevel');
            if (gameState.currentLevel >= 20) {
                // æœ€åä¸€å…³ï¼Œéšè—"ä¸‹ä¸€å…³"æŒ‰é’®
                nextLevelBtn.style.display = 'none';
            } else {
                // ä¸æ˜¯æœ€åä¸€å…³ï¼Œæ˜¾ç¤º"ä¸‹ä¸€å…³"æŒ‰é’®
                nextLevelBtn.style.display = 'inline-flex';
            }
        }

        // æ˜¾ç¤ºToastæç¤º
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur-sm text-gray-800 px-6 py-3 rounded-full shadow-lg transition-all duration-300 z-50`;
            
            if (type === 'success') {
                toast.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                toast.classList.add('bg-red-500', 'text-white');
            } else {
                toast.classList.add('bg-blue-500', 'text-white');
            }
            
            toast.classList.remove('opacity-0');
            
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 2000);
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
            gameState = {
                difficulty: 'easy',
                theme: 'nature',
                isTimerEnabled: true
            };
            
            // æ·»åŠ æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('nextLevel').addEventListener('click', nextLevel);
            document.getElementById('playAgain').addEventListener('click', () => {
                gameState.currentLevel = 1;
                gameState.score = 0;
                gameState.combo = 0;
                gameState.maxCombo = 0;
                gameState.correctCount = 0;
                startGame();
            });
            document.getElementById('backToHome').addEventListener('click', () => {
                window.location.href = 'index.html';
            });
            
            // å¼€å§‹æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('startBtn').addEventListener('click', startGame);
            
            // éš¾åº¦é€‰æ‹©æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    gameState.difficulty = this.dataset.difficulty;
                    checkStartButton();
                });
            });
            
            // ä¸»é¢˜é€‰æ‹©æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    gameState.theme = this.dataset.theme;
                    checkStartButton();
                });
            });
            
            // å€’è®¡æ—¶å¼€å…³äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('timer-toggle').addEventListener('change', function() {
                gameState.isTimerEnabled = this.checked;
                updateTimerDescription();
            });
            
            // é»˜è®¤é€‰æ‹©
            document.querySelector('[data-difficulty="easy"]').click();
            document.querySelector('[data-theme="nature"]').click();
            
            // æ·»åŠ æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .difficulty-btn {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 0.75rem;
                    border-radius: 0.75rem;
                    border: 2px solid #e5e7eb;
                    background: white;
                    cursor: pointer;
                    transition: all 0.3s;
                }
                .difficulty-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
                }
                .difficulty-btn.active {
                    border-color: #4F46E5;
                    background: linear-gradient(135deg, #4F46E5, #10B981);
                    color: white;
                }
                .theme-btn {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 0.75rem;
                    border-radius: 0.75rem;
                    border: 2px solid #e5e7eb;
                    background: white;
                    cursor: pointer;
                    transition: all 0.3s;
                }
                .theme-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
                }
                .theme-btn.active {
                    border-color: #4F46E5;
                    background: linear-gradient(135deg, #4F46E5, #10B981);
                    color: white;
                }
            `;
            document.head.appendChild(style);
            
            // æ¸²æŸ“å¾½ç« é¢„è§ˆ
            renderBadgePreview();
        });
    </script>
</body>
</html>