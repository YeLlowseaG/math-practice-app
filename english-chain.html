<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语接龙 - 连线游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                        neutral: '#F7FFF7',
                        text: '#1F2937'
                    },
                    fontFamily: {
                        kids: ['"Comic Sans MS"', '"Marker Felt"', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            }
            .bounce-light {
                animation: bounce-light 0.5s ease infinite alternate;
            }
            
            /* 游戏画布 */
            #game-canvas {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 20px;
                position: relative;
                overflow: hidden;
                border: 4px solid #4F46E5;
            }
            
            /* 单词卡片 */
            .word-card {
                position: absolute;
                background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
                border: 3px solid #e2e8f0;
                border-radius: 20px;
                padding: 12px 16px;
                text-align: center;
                cursor: pointer;
                user-select: none;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                min-width: 130px;
                min-height: 80px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                position: relative;
            }
            
            /* 分类徽章 */
            .category-badge {
                position: absolute;
                top: 4px;
                right: 4px;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                opacity: 0.8;
            }
            
            .category-badge.animals { background: #22C55E; }
            .category-badge.nature { background: #3B82F6; }
            .category-badge.objects { background: #F59E0B; }
            .category-badge.food { background: #EF4444; }
            .category-badge.others { background: #8B5CF6; }
            
            .word-card:hover {
                transform: scale(1.1);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
                border-color: #4F46E5;
            }
            
            .word-card.selected {
                background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
                color: white;
                border-color: #FCD34D;
                transform: scale(1.1);
                box-shadow: 0 0 0 4px rgba(252, 211, 77, 0.4);
            }
            
            .word-card.connected {
                background: linear-gradient(135deg, #10B981 0%, #059669 100%);
                color: white;
                border-color: #34D399;
                animation: pulseGreen 2s ease-in-out infinite;
            }
            
            .word-card.wrong {
                background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
                color: white;
                border-color: #F87171;
                animation: shakeWrong 0.5s ease-in-out;
            }
            
            @keyframes pulseGreen {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            
            @keyframes shakeWrong {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
            
            /* 连接线 */
            .connection-line {
                position: absolute;
                height: 6px;
                background: linear-gradient(90deg, #FCD34D 0%, #F59E0B 100%);
                border-radius: 3px;
                transform-origin: left center;
                opacity: 0.9;
                z-index: 5;
                pointer-events: none;
                box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
            }
            
            .connection-line.success {
                background: linear-gradient(90deg, #22C55E 0%, #16A34A 100%);
                animation: lineGlow 1s ease-in-out;
                box-shadow: 0 0 15px rgba(34, 197, 94, 0.7);
            }
            
            @keyframes lineGlow {
                0%, 100% { opacity: 0.9; }
                50% { opacity: 1; transform: scale(1, 1.5); }
            }
            
            /* 得分动画 */
            .score-popup {
                position: absolute;
                font-size: 2rem;
                font-weight: bold;
                color: #22C55E;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
                animation: scoreFloat 1.5s ease-out forwards;
                pointer-events: none;
                z-index: 20;
            }
            
            @keyframes scoreFloat {
                0% { 
                    transform: translateY(0) scale(1);
                    opacity: 1;
                }
                100% { 
                    transform: translateY(-80px) scale(1.3);
                    opacity: 0;
                }
            }
            
            /* 粒子效果 */
            .particle {
                position: absolute;
                width: 8px;
                height: 8px;
                background: #FCD34D;
                border-radius: 50%;
                pointer-events: none;
                animation: particleFly 2s ease-out forwards;
            }
            
            @keyframes particleFly {
                0% { 
                    transform: scale(1) rotate(0deg);
                    opacity: 1;
                }
                100% { 
                    transform: scale(0) rotate(360deg) translateY(-100px);
                    opacity: 0;
                }
            }
            
            @keyframes bounce-light {
                from { transform: translateY(0); }
                to { transform: translateY(-5px); }
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 min-h-screen font-kids text-text">
    
    <!-- 开始界面 -->
    <div id="start-screen" class="flex flex-col items-center justify-center min-h-screen p-4 relative">
        <!-- 返回首页按钮 -->
        <button onclick="window.location.href='index.html'" class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm px-4 py-2 rounded-full shadow-lg transition-all duration-300 hover:scale-105 active:scale-95 text-sm font-bold text-gray-600 hover:text-gray-800 z-40">
            <i class="fa fa-home mr-2"></i>首页
        </button>
        
        <div class="text-center w-full max-w-lg mx-auto bg-white rounded-3xl shadow-2xl p-8 transform transition-all duration-500">
            <div class="flex justify-center mb-4">
                <div class="w-16 h-16 bg-gradient-to-br from-primary to-purple-600 rounded-full flex items-center justify-center text-white text-2xl shadow-lg relative overflow-hidden">
                    <i class="fa fa-link"></i>
                    <div class="absolute inset-0 bg-white opacity-20 rounded-full animate-ping"></div>
                </div>
            </div>
            
            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary via-purple-600 to-blue-600 mb-3">英语接龙</h1>
            
            <div class="bg-purple-50 rounded-2xl p-3 mb-4 text-sm">
                <p class="text-purple-800 text-sm font-medium mb-2">
                    <i class="fa fa-gamepad mr-2 text-blue-500"></i>学习目标
                </p>
                <p class="text-purple-700 text-sm">
                    📚 学习300+常用英语单词<br>
                    🎯 掌握单词拼写和字母顺序<br>
                    💡 了解单词含义和分类<br>
                    🔗 例如: CAT(猫) → TREE(树) → ELEPHANT(大象)
                </p>
            </div>
            
            <div class="grid grid-cols-2 gap-3 text-sm text-gray-600 mb-4">
                <div class="flex items-center">
                    <i class="fa fa-graduation-cap text-blue-500 mr-2"></i>
                    <span>词汇学习</span>
                </div>
                <div class="flex items-center">
                    <i class="fa fa-heart text-pink-500 mr-2"></i>
                    <span>适合8-16岁</span>
                </div>
                <div class="flex items-center">
                    <i class="fa fa-clock-o text-purple-500 mr-2"></i>
                    <span>限时挑战</span>
                </div>
                <div class="flex items-center">
                    <i class="fa fa-star text-yellow-500 mr-2"></i>
                    <span>超有趣</span>
                </div>
            </div>
            
            <!-- 徽章预览 -->
            <div id="badge-preview" class="mb-6">
                <h3 class="text-sm font-bold mb-2">我的徽章</h3>
                <div id="badge-preview-grid" class="flex justify-center gap-3 flex-wrap"></div>
                <div class="text-xs text-gray-400 mt-1">本游戏徽章预览（已获高亮，未获灰显）</div>
            </div>

            <button onclick="startGame()" class="w-full bg-gradient-to-r from-primary to-purple-600 hover:from-purple-600 hover:to-primary text-white font-bold py-3 px-6 rounded-2xl text-base shadow-lg transform transition-all duration-300 hover:scale-105 active:scale-95">
                开始接龙 <i class="fa fa-play ml-2"></i>
            </button>
        </div>
        
        <!-- 装饰元素 -->
        <div class="absolute top-10 left-10 text-4xl text-primary/30 hidden md:block bounce-light">
            <i class="fa fa-link"></i>
        </div>
        <div class="absolute bottom-10 right-10 text-4xl text-purple-400/30 hidden md:block bounce-light" style="animation-delay: 0.3s">
            <i class="fa fa-chain"></i>
        </div>
    </div>

    <script>
    (function(){
      const GAME_KEY = 'englishChain';
      const badgeDefs = [
        { id: 'first_chain', name: '首链完成', icon: '🎯' },
        { id: 'combo_chain', name: '连锁达人', icon: '🔥' },
        { id: 'speed_link', name: '极速接龙', icon: '⚡' },
        { id: 'level_reach', name: '闯关能手', icon: '🏆' },
        { id: 'perfect_round', name: '完美回合', icon: '💎' }
      ];
      function getEarnedIds(){
        try { return JSON.parse(localStorage.getItem('earnedAchievements_' + GAME_KEY) || '[]'); } catch(_) { return []; }
      }
      function renderBadgePreview(){
        const grid = document.getElementById('badge-preview-grid');
        if(!grid) return;
        const owned = new Set(getEarnedIds());
        grid.innerHTML = badgeDefs.map(a => {
          const earned = owned.has(a.id);
          const base = earned ? 'from-yellow-100 to-orange-100 border-yellow-300 text-amber-900' : 'from-gray-50 to-gray-100 border-gray-200 text-gray-400 opacity-80';
          return `
            <div class="relative w-20 h-20 rounded-2xl border-2 bg-gradient-to-br ${base} shadow-sm flex flex-col items-center justify-center overflow-hidden" title="${a.name}">
              <div class="text-2xl mb-1">${a.icon}</div>
              <div class="text-[10px] font-bold text-center leading-tight px-1">${a.name}</div>
              ${earned ? '<div class=\"absolute -right-1 -top-1 bg-amber-400 text-white text-[10px] px-1 rounded-full shadow\">已获</div>' : ''}
            </div>`;
        }).join('');
      }
      document.addEventListener('DOMContentLoaded', renderBadgePreview);
    })();
    </script>

    <!-- 游戏界面 -->
    <div id="game-screen" class="hidden min-h-screen p-4">
        <!-- 顶部信息栏 -->
        <div class="flex justify-between items-center mb-4">
            <button onclick="pauseGame()" class="bg-white/90 backdrop-blur-sm px-4 py-2 rounded-full shadow-lg transition-all duration-300 hover:scale-105 active:scale-95 text-sm font-bold text-gray-600">
                <i class="fa fa-pause mr-2"></i>暂停
            </button>
            
            <div class="flex items-center space-x-4">
                <div class="bg-gradient-to-r from-primary to-purple-600 text-white px-4 py-2 rounded-full shadow-lg font-bold">
                    <i class="fa fa-clock-o mr-1"></i>
                    <span id="time-left">60</span>秒
                </div>
                <div class="bg-gradient-to-r from-secondary to-green-600 text-white px-4 py-2 rounded-full shadow-lg font-bold">
                    <i class="fa fa-star mr-1"></i>
                    <span id="score">0</span>
                </div>
                <div class="bg-gradient-to-r from-accent to-orange-600 text-white px-4 py-2 rounded-full shadow-lg font-bold">
                    <i class="fa fa-link mr-1"></i>
                    <span id="chain-length">0</span> 链
                </div>
            </div>
        </div>

        <!-- 游戏画布 -->
        <div class="max-w-6xl mx-auto">
            <div id="game-canvas" style="width: 100%; height: 600px; margin: 0 auto; position: relative;">
                <!-- 单词卡片和连接线将通过JavaScript动态生成 -->
            </div>
            
            <!-- 控制说明 -->
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-4 mt-4 text-center text-sm text-gray-600">
                <p><i class="fa fa-hand-pointer-o mr-2"></i>拖拽单词卡片进行连线，组成接龙链条</p>
                <p class="mt-1">当前目标: <span id="current-target" class="font-bold text-purple-600">连接任意两个单词开始</span></p>
            </div>
            
            <!-- 已连接的链条显示 -->
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-4 mt-4">
                <h3 class="font-bold text-purple-600 mb-2">
                    <i class="fa fa-chain mr-2"></i>接龙链条
                </h3>
                <div id="chain-display" class="flex flex-wrap items-center gap-2">
                    <span class="text-gray-500">开始连接单词...</span>
                </div>
            </div>
            
            <!-- 学习统计面板 -->
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-4 mt-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center text-sm">
                    <div class="flex flex-col items-center">
                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs mb-1">
                            <i class="fa fa-paw"></i>
                        </div>
                        <div class="font-bold text-green-600" id="animals-count">0</div>
                        <div class="text-gray-600">动物</div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs mb-1">
                            <i class="fa fa-leaf"></i>
                        </div>
                        <div class="font-bold text-blue-600" id="nature-count">0</div>
                        <div class="text-gray-600">自然</div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center text-white text-xs mb-1">
                            <i class="fa fa-cube"></i>
                        </div>
                        <div class="font-bold text-yellow-600" id="objects-count">0</div>
                        <div class="text-gray-600">物品</div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white text-xs mb-1">
                            <i class="fa fa-apple"></i>
                        </div>
                        <div class="font-bold text-red-600" id="food-count">0</div>
                        <div class="text-gray-600">食物</div>
                    </div>
                </div>
                <div class="mt-3 text-center text-sm text-gray-600">
                    已学习 <span class="font-bold text-purple-600" id="words-learned">0</span> 个单词
                    · 当前难度: <span class="font-bold text-blue-600" id="current-difficulty">初级</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 暂停界面 -->
    <div id="pause-screen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-3xl shadow-2xl p-8 text-center max-w-sm mx-auto">
            <h3 class="text-2xl font-bold mb-6">游戏暂停</h3>
            <div class="space-y-4">
                <button onclick="resumeGame()" class="w-full bg-gradient-to-r from-primary to-purple-600 text-white font-bold py-3 px-6 rounded-2xl transition-all duration-300 hover:scale-105 active:scale-95">
                    <i class="fa fa-play mr-2"></i>继续游戏
                </button>
                <button onclick="restartGame()" class="w-full bg-gradient-to-r from-accent to-orange-600 text-white font-bold py-3 px-6 rounded-2xl transition-all duration-300 hover:scale-105 active:scale-95">
                    <i class="fa fa-refresh mr-2"></i>重新开始
                </button>
                <button onclick="window.location.href='index.html'" class="w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold py-3 px-6 rounded-2xl transition-all duration-300 hover:scale-105 active:scale-95">
                    <i class="fa fa-home mr-2"></i>返回首页
                </button>
            </div>
        </div>
    </div>

    <!-- 完成界面 -->
    <div id="complete-screen" class="hidden flex flex-col items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 text-center max-w-md mx-auto">
            <div class="text-6xl mb-4">🎉</div>
            <h2 class="text-2xl font-bold mb-4 text-purple-600">时间到！</h2>
            <div class="bg-purple-50 rounded-2xl p-6 mb-6">
                <p class="text-purple-800 text-lg mb-2">你的接龙成绩：</p>
                <div class="text-4xl font-bold text-purple-600 mb-2" id="final-score">0</div>
                <div class="text-2xl font-bold text-blue-600" id="final-chain">链长: 0</div>
                <p class="text-sm text-gray-600 mt-2">最长链条: <span id="longest-chain"></span></p>
            </div>
            <div class="flex space-x-4">
                <button onclick="restartGame()" class="flex-1 bg-gradient-to-r from-primary to-purple-600 text-white font-bold py-3 px-6 rounded-2xl transition-all duration-300 hover:scale-105 active:scale-95">
                    <i class="fa fa-refresh mr-2"></i>再玩一次
                </button>
                <button onclick="window.location.href='index.html'" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold py-3 px-6 rounded-2xl transition-all duration-300 hover:scale-105 active:scale-95">
                    <i class="fa fa-home mr-2"></i>返回首页
                </button>
            </div>
        </div>
    </div>

    <script>
        // 游戏单词库 - 按类别分组，包含中文翻译和难度等级
        const gameWords = [
            // 动物类 (Animals) - 基础
            { word: 'CAT', translation: '猫', category: 'animals', level: 1 },
            { word: 'DOG', translation: '狗', category: 'animals', level: 1 },
            { word: 'ELEPHANT', translation: '大象', category: 'animals', level: 2 },
            { word: 'TIGER', translation: '老虎', category: 'animals', level: 2 },
            { word: 'RABBIT', translation: '兔子', category: 'animals', level: 1 },
            { word: 'WHALE', translation: '鲸鱼', category: 'animals', level: 2 },
            { word: 'EAGLE', translation: '老鹰', category: 'animals', level: 2 },
            { word: 'LION', translation: '狮子', category: 'animals', level: 2 },
            { word: 'DOLPHIN', translation: '海豚', category: 'animals', level: 3 },
            { word: 'KANGAROO', translation: '袋鼠', category: 'animals', level: 3 },
            
            // 自然类 (Nature)
            { word: 'TREE', translation: '树', category: 'nature', level: 1 },
            { word: 'EARTH', translation: '地球', category: 'nature', level: 2 },
            { word: 'SUN', translation: '太阳', category: 'nature', level: 1 },
            { word: 'RIVER', translation: '河流', category: 'nature', level: 2 },
            { word: 'OCEAN', translation: '海洋', category: 'nature', level: 2 },
            { word: 'RAINBOW', translation: '彩虹', category: 'nature', level: 2 },
            { word: 'STAR', translation: '星星', category: 'nature', level: 1 },
            { word: 'NIGHT', translation: '夜晚', category: 'nature', level: 1 },
            { word: 'ICE', translation: '冰', category: 'nature', level: 1 },
            
            // 物品类 (Objects)
            { word: 'TABLE', translation: '桌子', category: 'objects', level: 1 },
            { word: 'HOUSE', translation: '房子', category: 'objects', level: 1 },
            { word: 'WINDOW', translation: '窗户', category: 'objects', level: 2 },
            { word: 'TELEPHONE', translation: '电话', category: 'objects', level: 2 },
            { word: 'NOTEBOOK', translation: '笔记本', category: 'objects', level: 2 },
            { word: 'ENVELOPE', translation: '信封', category: 'objects', level: 3 },
            { word: 'ERASER', translation: '橡皮', category: 'objects', level: 2 },
            { word: 'TELEVISION', translation: '电视', category: 'objects', level: 3 },
            { word: 'ROCKET', translation: '火箭', category: 'objects', level: 2 },
            { word: 'TOWER', translation: '塔', category: 'objects', level: 2 },
            
            // 食物类 (Food)
            { word: 'EGG', translation: '鸡蛋', category: 'food', level: 1 },
            { word: 'TOMATO', translation: '番茄', category: 'food', level: 2 },
            { word: 'ORANGE', translation: '橙子', category: 'food', level: 1 },
            { word: 'WATERMELON', translation: '西瓜', category: 'food', level: 3 },
            { word: 'EGGPLANT', translation: '茄子', category: 'food', level: 3 },
            { word: 'NOODLE', translation: '面条', category: 'food', level: 2 },
            
            // 其他类 (Others)
            { word: 'GAME', translation: '游戏', category: 'others', level: 1 },
            { word: 'NET', translation: '网', category: 'others', level: 1 },
            { word: 'TEACHER', translation: '老师', category: 'others', level: 1 },
            { word: 'ROBOT', translation: '机器人', category: 'others', level: 2 },
            { word: 'NICE', translation: '好的', category: 'others', level: 1 },
            { word: 'EAR', translation: '耳朵', category: 'others', level: 1 },
            { word: 'ENERGY', translation: '能量', category: 'others', level: 3 },
            { word: 'YELLOW', translation: '黄色', category: 'others', level: 1 },
            { word: 'TAXI', translation: '出租车', category: 'others', level: 2 },
            { word: 'NOSE', translation: '鼻子', category: 'others', level: 1 },
            { word: 'RADIO', translation: '收音机', category: 'others', level: 2 },
            { word: 'OWL', translation: '猫头鹰', category: 'others', level: 2 },
            { word: 'EMERALD', translation: '翡翠', category: 'others', level: 3 },
            { word: 'ROSE', translation: '玫瑰', category: 'others', level: 2 },
            { word: 'LOCK', translation: '锁', category: 'others', level: 1 },
            { word: 'KEY', translation: '钥匙', category: 'others', level: 1 },
            { word: 'YARN', translation: '纱线', category: 'others', level: 3 },
            { word: 'NUGGET', translation: '金块', category: 'others', level: 3 }
        ];

        // 游戏状态
        let score = 0;
        let timeLeft = 60;
        let gameRunning = false;
        let gameTimer = null;
        let wordCards = [];
        let connections = [];
        let selectedCard = null;
        let dragLine = null;
        let currentChain = [];
        let longestChain = [];
        let wordsLearned = new Set(); // 已学习的单词
        let categoryStats = {}; // 分类统计
        let difficultyLevel = 1; // 当前难度等级
        
        // DOM元素
        const gameCanvas = document.getElementById('game-canvas');
        const chainDisplay = document.getElementById('chain-display');
        
        // 初始化游戏
        function initGame() {
            score = 0;
            timeLeft = 60;
            connections = [];
            currentChain = [];
            longestChain = [];
            selectedCard = null;
            wordsLearned.clear();
            categoryStats = {};
            difficultyLevel = 1;
            
            generateWordCards();
            updateUI();
            updateLearningStats();
            setupEventListeners();
        }
        
        // 根据难度等级筛选单词
        function getWordsForLevel(level) {
            return gameWords.filter(wordData => wordData.level <= level);
        }
        
        // 生成单词卡片
        function generateWordCards() {
            gameCanvas.innerHTML = '';
            wordCards = [];
            
            // 根据当前难度等级选择单词
            const availableWords = getWordsForLevel(difficultyLevel);
            const shuffled = [...availableWords].sort(() => Math.random() - 0.5);
            const selectedWords = shuffled.slice(0, 12);
            
            selectedWords.forEach((wordData, index) => {
                const card = document.createElement('div');
                card.className = 'word-card';
                
                // 显示单词和翻译
                card.innerHTML = `
                    <div class="text-lg font-bold">${wordData.word}</div>
                    <div class="text-xs text-gray-600 mt-1">${wordData.translation}</div>
                    <div class="category-badge ${wordData.category}" title="${getCategoryName(wordData.category)}"></div>
                `;
                
                card.dataset.word = wordData.word;
                card.dataset.translation = wordData.translation;
                card.dataset.category = wordData.category;
                card.dataset.level = wordData.level;
                card.dataset.index = index;
                
                // 随机位置放置
                const x = Math.random() * (gameCanvas.offsetWidth - 120);
                const y = Math.random() * (gameCanvas.offsetHeight - 80);
                card.style.left = x + 'px';
                card.style.top = y + 'px';
                
                gameCanvas.appendChild(card);
                wordCards.push({
                    element: card,
                    word: wordData.word,
                    data: wordData,
                    x: x + 60, // 中心点
                    y: y + 40,
                    connected: false
                });
            });
        }
        
        // 获取分类名称
        function getCategoryName(category) {
            const names = {
                'animals': '动物',
                'nature': '自然',
                'objects': '物品',
                'food': '食物',
                'others': '其他'
            };
            return names[category] || '其他';
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            wordCards.forEach(cardData => {
                const card = cardData.element;
                card.addEventListener('mousedown', startDrag);
                card.addEventListener('touchstart', startDrag, {passive: false});
            });
        }
        
        // 开始拖拽
        function startDrag(e) {
            if (!gameRunning) return;
            
            e.preventDefault();
            const card = e.target;
            
            // 选中卡片
            if (selectedCard && selectedCard !== card) {
                // 尝试连接两个卡片
                tryConnect(selectedCard, card);
            } else {
                // 选中当前卡片
                selectCard(card);
                createDragLine(e);
            }
        }
        
        // 选中卡片
        function selectCard(card) {
            // 清除之前的选中状态
            if (selectedCard) {
                selectedCard.classList.remove('selected');
            }
            
            selectedCard = card;
            card.classList.add('selected');
        }
        
        // 创建拖拽线
        function createDragLine(e) {
            if (!selectedCard) return;
            
            const line = document.createElement('div');
            line.className = 'connection-line';
            line.id = 'drag-line';
            gameCanvas.appendChild(line);
            dragLine = line;
            
            const startRect = selectedCard.getBoundingClientRect();
            const canvasRect = gameCanvas.getBoundingClientRect();
            
            const startX = startRect.left - canvasRect.left + startRect.width / 2;
            const startY = startRect.top - canvasRect.top + startRect.height / 2;
            
            function updateLine(e) {
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                
                if (clientX && clientY) {
                    const endX = clientX - canvasRect.left;
                    const endY = clientY - canvasRect.top;
                    
                    const length = Math.sqrt((endX - startX) ** 2 + (endY - startY) ** 2);
                    const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                    
                    line.style.left = startX + 'px';
                    line.style.top = startY + 'px';
                    line.style.width = length + 'px';
                    line.style.transform = `rotate(${angle}deg)`;
                }
            }
            
            function stopDrag(e) {
                // 检查是否拖拽到另一个卡片
                const dropTarget = getCardUnderPoint(e);
                if (dropTarget && dropTarget !== selectedCard) {
                    tryConnect(selectedCard, dropTarget);
                }
                
                // 清理拖拽线
                if (dragLine) {
                    dragLine.remove();
                    dragLine = null;
                }
                
                document.removeEventListener('mousemove', updateLine);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchmove', updateLine);
                document.removeEventListener('touchend', stopDrag);
            }
            
            document.addEventListener('mousemove', updateLine);
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchmove', updateLine, {passive: false});
            document.addEventListener('touchend', stopDrag);
        }
        
        // 获取点击位置下的卡片
        function getCardUnderPoint(e) {
            const clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
            const clientY = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
            
            if (clientX && clientY) {
                const element = document.elementFromPoint(clientX, clientY);
                return element && element.classList.contains('word-card') ? element : null;
            }
            return null;
        }
        
        // 尝试连接两个卡片
        function tryConnect(card1, card2) {
            const word1 = card1.dataset.word;
            const word2 = card2.dataset.word;
            const translation1 = card1.dataset.translation;
            const translation2 = card2.dataset.translation;
            const category1 = card1.dataset.category;
            const category2 = card2.dataset.category;
            
            // 检查是否能接龙
            const canConnect = checkConnection(word1, word2);
            
            if (canConnect) {
                // 学习统计更新
                wordsLearned.add(word1);
                wordsLearned.add(word2);
                updateCategoryStats(category1);
                updateCategoryStats(category2);
                
                createConnection(card1, card2);
                updateChain(word1, word2, translation1, translation2);
                
                // 计算分数（包含分类加成和难度加成）
                let points = word1.length + word2.length;
                
                // 同类别单词连接加成
                if (category1 === category2) {
                    points += 10;
                    createScorePopup(card2, `+${points} 同类加成!`);
                } else {
                    createScorePopup(card2, `+${points}`);
                }
                
                score += points;
                createParticleEffect(card2);
                updateCurrentTarget();
                
                // 检查是否可以升级难度
                checkDifficultyUpgrade();
            } else {
                // 连接失败，显示错误
                card2.classList.add('wrong');
                setTimeout(() => {
                    card2.classList.remove('wrong');
                }, 500);
            }
            
            // 清除选中状态
            if (selectedCard) {
                selectedCard.classList.remove('selected');
                selectedCard = null;
            }
            
            updateUI();
            updateLearningStats();
        }
        
        // 检查两个单词是否能接龙
        function checkConnection(word1, word2) {
            const lastLetter = word1.charAt(word1.length - 1).toUpperCase();
            const firstLetter = word2.charAt(0).toUpperCase();
            
            return lastLetter === firstLetter;
        }
        
        // 创建连接线
        function createConnection(card1, card2) {
            const rect1 = card1.getBoundingClientRect();
            const rect2 = card2.getBoundingClientRect();
            const canvasRect = gameCanvas.getBoundingClientRect();
            
            const x1 = rect1.left - canvasRect.left + rect1.width / 2;
            const y1 = rect1.top - canvasRect.top + rect1.height / 2;
            const x2 = rect2.left - canvasRect.left + rect2.width / 2;
            const y2 = rect2.top - canvasRect.top + rect2.height / 2;
            
            const line = document.createElement('div');
            line.className = 'connection-line success';
            
            const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            
            line.style.left = x1 + 'px';
            line.style.top = y1 + 'px';
            line.style.width = length + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            
            gameCanvas.appendChild(line);
            
            // 标记卡片为已连接
            card1.classList.add('connected');
            card2.classList.add('connected');
            
            connections.push({
                line: line,
                card1: card1,
                card2: card2
            });
        }
        
        // 更新链条
        function updateChain(word1, word2, translation1, translation2) {
            if (currentChain.length === 0) {
                currentChain = [
                    { word: word1, translation: translation1 },
                    { word: word2, translation: translation2 }
                ];
            } else {
                // 找到合适的位置插入
                const lastWord = currentChain[currentChain.length - 1].word;
                const firstWord = currentChain[0].word;
                
                if (checkConnection(lastWord, word1)) {
                    currentChain.push({ word: word1, translation: translation1 });
                    if (word1 !== word2) {
                        currentChain.push({ word: word2, translation: translation2 });
                    }
                } else if (checkConnection(lastWord, word2)) {
                    currentChain.push({ word: word2, translation: translation2 });
                } else if (checkConnection(word2, firstWord)) {
                    currentChain.unshift({ word: word2, translation: translation2 });
                    if (word1 !== word2) {
                        currentChain.unshift({ word: word1, translation: translation1 });
                    }
                } else if (checkConnection(word1, firstWord)) {
                    currentChain.unshift({ word: word1, translation: translation1 });
                } else {
                    // 开始新链条
                    if (currentChain.length > longestChain.length) {
                        longestChain = [...currentChain];
                    }
                    currentChain = [
                        { word: word1, translation: translation1 },
                        { word: word2, translation: translation2 }
                    ];
                }
            }
            
            // 更新显示
            updateChainDisplay();
        }
        
        // 更新链条显示
        function updateChainDisplay() {
            chainDisplay.innerHTML = '';
            
            if (currentChain.length === 0) {
                chainDisplay.innerHTML = '<span class="text-gray-500">开始连接单词...</span>';
                return;
            }
            
            currentChain.forEach((wordData, index) => {
                const wordSpan = document.createElement('span');
                wordSpan.className = 'bg-purple-100 text-purple-800 px-3 py-2 rounded-lg font-bold border border-purple-200 inline-block text-center';
                wordSpan.innerHTML = `
                    <div class="font-bold">${wordData.word}</div>
                    <div class="text-xs text-purple-600 mt-1">${wordData.translation}</div>
                `;
                
                chainDisplay.appendChild(wordSpan);
                
                if (index < currentChain.length - 1) {
                    const arrow = document.createElement('span');
                    arrow.className = 'text-purple-600 mx-2 inline-flex items-center';
                    arrow.innerHTML = '<i class="fa fa-arrow-right text-lg"></i>';
                    chainDisplay.appendChild(arrow);
                }
            });
        }
        
        // 更新当前目标
        function updateCurrentTarget() {
            const targetElement = document.getElementById('current-target');
            
            if (currentChain.length === 0) {
                targetElement.textContent = '连接任意两个单词开始';
            } else {
                const lastWord = currentChain[currentChain.length - 1].word;
                const firstWord = currentChain[0].word;
                const lastLetter = lastWord.charAt(lastWord.length - 1);
                const firstLetter = firstWord.charAt(0);
                
                targetElement.textContent = `寻找以 ${lastLetter} 开头或以 ${firstLetter} 结尾的单词`;
            }
        }
        
        // 更新分类统计
        function updateCategoryStats(category) {
            if (!categoryStats[category]) {
                categoryStats[category] = 0;
            }
            categoryStats[category]++;
        }
        
        // 更新学习统计显示
        function updateLearningStats() {
            document.getElementById('words-learned').textContent = wordsLearned.size;
            document.getElementById('animals-count').textContent = categoryStats.animals || 0;
            document.getElementById('nature-count').textContent = categoryStats.nature || 0;
            document.getElementById('objects-count').textContent = categoryStats.objects || 0;
            document.getElementById('food-count').textContent = categoryStats.food || 0;
            
            // 更新难度显示
            const difficultyNames = ['初级', '中级', '高级'];
            document.getElementById('current-difficulty').textContent = difficultyNames[difficultyLevel - 1] || '初级';
        }
        
        // 检查难度升级
        function checkDifficultyUpgrade() {
            const totalLearned = wordsLearned.size;
            
            if (totalLearned >= 20 && difficultyLevel === 1) {
                difficultyLevel = 2;
                showUpgradeMessage('恭喜升级到中级难度！解锁更多高级单词！');
            } else if (totalLearned >= 35 && difficultyLevel === 2) {
                difficultyLevel = 3;
                showUpgradeMessage('太棒了！升级到高级难度！挑战最难的单词！');
            }
        }
        
        // 显示升级消息
        function showUpgradeMessage(message) {
            const popup = document.createElement('div');
            popup.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-8 py-4 rounded-2xl font-bold text-lg shadow-2xl z-50';
            popup.innerHTML = `
                <div class="text-center">
                    <div class="text-2xl mb-2">🎉</div>
                    <div>${message}</div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
                // 重新生成卡片以包含新难度的单词
                generateWordCards();
                setupEventListeners();
            }, 3000);
        }
        
        // 创建得分弹窗
        function createScorePopup(card, text) {
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.textContent = text;
            
            const rect = card.getBoundingClientRect();
            const canvasRect = gameCanvas.getBoundingClientRect();
            
            popup.style.left = (rect.left - canvasRect.left) + 'px';
            popup.style.top = (rect.top - canvasRect.top) + 'px';
            
            gameCanvas.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 1500);
        }
        
        // 创建粒子效果
        function createParticleEffect(card) {
            const rect = card.getBoundingClientRect();
            const canvasRect = gameCanvas.getBoundingClientRect();
            
            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const x = rect.left - canvasRect.left + rect.width / 2 + (Math.random() - 0.5) * 60;
                const y = rect.top - canvasRect.top + rect.height / 2 + (Math.random() - 0.5) * 60;
                
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.animationDelay = (i * 0.1) + 's';
                
                gameCanvas.appendChild(particle);
                
                setTimeout(() => {
                    particle.remove();
                }, 2000);
            }
        }
        
        // 更新UI
        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('time-left').textContent = timeLeft;
            document.getElementById('chain-length').textContent = currentChain.length;
        }
        
        // 开始游戏
        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            initGame();
            gameRunning = true;
            startTimer();
        }
        
        // 开始计时
        function startTimer() {
            gameTimer = setInterval(() => {
                timeLeft--;
                updateUI();
                
                if (timeLeft <= 0) {
                    gameOver();
                }
            }, 1000);
        }
        
        // 游戏结束
        function gameOver() {
            gameRunning = false;
            clearInterval(gameTimer);
            
            if (currentChain.length > longestChain.length) {
                longestChain = [...currentChain];
            }
            
            document.getElementById('final-score').textContent = score;
            document.getElementById('final-chain').textContent = `链长: ${currentChain.length}`;
            document.getElementById('longest-chain').textContent = longestChain.join(' → ');
            
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('complete-screen').classList.remove('hidden');
        }
        
        // 暂停游戏
        function pauseGame() {
            gameRunning = false;
            clearInterval(gameTimer);
            document.getElementById('pause-screen').classList.remove('hidden');
        }
        
        // 继续游戏
        function resumeGame() {
            document.getElementById('pause-screen').classList.add('hidden');
            gameRunning = true;
            startTimer();
        }
        
        // 重新开始
        function restartGame() {
            clearInterval(gameTimer);
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('pause-screen').classList.add('hidden');
            document.getElementById('complete-screen').classList.add('hidden');
            
            setTimeout(() => {
                startGame();
            }, 300);
        }
        
        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            console.log('英语接龙游戏初始化完成');
        });
    </script>
</body>
</html>