<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>单词记忆游戏 - 英文单词学习</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script defer src="./assets/achievements.js"></script>
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                        neutral: '#F7FFF7',
                        text: '#1F2937'
                    },
                    fontFamily: {
                        kids: ['"Comic Sans MS"', '"Marker Felt"', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            }
            .bounce-light {
                animation: bounce-light 0.5s ease infinite alternate;
            }
            .pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .scale-hover {
                transition: transform 0.2s;
            }
            .scale-hover:hover {
                transform: scale(1.05);
            }
            .correct-animation {
                animation: correct 0.6s ease-in-out;
            }
            .wrong-animation {
                animation: wrong 0.6s ease-in-out;
            }
            .level-complete {
                animation: levelComplete 1s ease-in-out;
            }
            @keyframes bounce-light {
                from { transform: translateY(0); }
                to { transform: translateY(-5px); }
            }
            @keyframes correct {
                0% { transform: scale(1); background-color: #10B981; }
                50% { transform: scale(1.1); background-color: #34D399; }
                100% { transform: scale(1); background-color: #10B981; }
            }
            @keyframes wrong {
                0% { transform: translateX(0); background-color: #EF4444; }
                25% { transform: translateX(-5px); background-color: #F87171; }
                75% { transform: translateX(5px); background-color: #F87171; }
                100% { transform: translateX(0); background-color: #EF4444; }
            }
            @keyframes levelComplete {
                0% { transform: scale(1) rotate(0deg); }
                25% { transform: scale(1.2) rotate(5deg); }
                75% { transform: scale(1.2) rotate(-5deg); }
                100% { transform: scale(1) rotate(0deg); }
            }
            @keyframes button-press {
                0% { transform: scale(1); }
                50% { transform: scale(0.95); }
                100% { transform: scale(1); }
            }
            
            .button-press {
                animation: button-press 0.2s ease-in-out;
            }
            
            .word-card {
                /* 固定方格尺寸，避免翻面后高度跳动 */
                aspect-ratio: 1 / 1;
                height: auto;
                overflow: hidden; /* 防止内部内容撑高导致网格高度变化 */
                min-width: 0; /* 避免网格项以内容最小宽度撑开列宽 */
                transition: all 0.3s ease;
                border: 3px solid transparent;
                display: flex;
                align-items: center; /* 垂直居中，确保文字始终在卡片中间 */
                justify-content: center; /* 水平居中 */
            }
            .word-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
            }
            .word-card.flipped {
                background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            }
            .word-card.matched {
                background: linear-gradient(135deg, #10B981 0%, #059669 100%);
                border-color: #10B981;
            }
            .word-card.wrong {
                background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
                border-color: #EF4444;
                animation: wrong 0.6s ease-in-out;
            }
            
            /* 移动端优化 */
            @media (max-width: 768px) {
                .word-card {
                    font-size: 1rem;
                    padding: 12px 8px;
                }
                .float-animation {
                    animation: none;
                }
            }
            
            @media (max-width: 480px) {
                .word-card {
                    font-size: 0.9rem;
                    padding: 10px 6px;
                }
            }
            .card-back { width: 100%; }
            /* 英文单词不换行，防止被强制拆分 */
            .card-back .word-en { white-space: nowrap; }
            /* 中文翻译尽量一行显示 */
            .card-back .translation { white-space: nowrap; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen font-kids text-text">
    
    <!-- 开始界面 -->
    <div id="start-screen" class="flex flex-col items-center justify-center min-h-screen p-8 relative">
        <!-- 返回首页按钮 -->
        <button onclick="window.location.href='index.html'" class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm px-4 py-2 rounded-full shadow-lg transition-all duration-300 hover:scale-105 active:scale-95 text-sm font-bold text-gray-600 hover:text-gray-800 z-40">
            <i class="fa fa-home mr-2"></i>首页
        </button>
        
        <div class="text-center w-full max-w-lg mx-auto bg-white rounded-3xl shadow-2xl p-6 transform transition-all duration-500">
            <h1 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary via-secondary to-accent mb-2">单词记忆</h1>
            <p class="text-sm mb-3 text-gray-600">翻牌配对游戏<br>记住单词配对！</p>
            
            <div class="flex justify-center mb-4">
                <div class="w-16 h-16 bg-gradient-to-br from-primary to-secondary rounded-full flex items-center justify-center text-white text-2xl shadow-lg relative overflow-hidden float-animation">
                    <i class="fa fa-puzzle-piece"></i>
                    <div class="absolute inset-0 bg-white opacity-20 rounded-full animate-ping"></div>
                </div>
            </div>
            
            <!-- 难度选择 -->
            <div class="mb-4">
                <h3 class="text-sm font-bold mb-2">选择难度</h3>
                <div class="flex justify-center gap-3">
                    <button onclick="selectDifficulty('easy')" 
                            class="difficulty-btn bg-secondary/10 border-2 border-secondary/20 hover:border-secondary/40 p-2 rounded-2xl text-center scale-hover transition-all duration-300">
                        <div class="flex items-center gap-2">
                            <div class="text-xl">🌟</div>
                            <div class="text-left">
                                <h4 class="font-bold text-secondary leading-tight">简单</h4>
                                <p class="text-[11px] text-gray-600">3×2 基础单词</p>
                                </div>
                        </div>
                    </button>
                    <button onclick="selectDifficulty('medium')" 
                            class="difficulty-btn bg-accent/10 border-2 border-accent/20 hover:border-accent/40 p-2 rounded-2xl text-center scale-hover transition-all duration-300">
                        <div class="flex items-center gap-2">
                            <div class="text-xl">⭐⭐</div>
                            <div class="text-left">
                                <h4 class="font-bold text-accent leading-tight">中等</h4>
                                <p class="text-[11px] text-gray-600">4×3 常用单词</p>
                                </div>
                        </div>
                    </button>
                    <button onclick="selectDifficulty('hard')" 
                            class="difficulty-btn bg-danger/10 border-2 border-danger/20 hover:border-danger/40 p-2 rounded-2xl text-center scale-hover transition-all duration-300">
                        <div class="flex items-center gap-2">
                            <div class="text-xl">⭐⭐⭐</div>
                            <div class="text-left">
                                <h4 class="font-bold text-danger leading-tight">困难</h4>
                                <p class="text-[11px] text-gray-600">4×4 进阶单词</p>
                                </div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- 关卡选择（按需隐藏：开始页不展示关卡进度与按钮） -->
            <div class="mb-5 hidden">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-base font-bold">选择关卡</h3>
                    <!-- 按需求：不在这里显示关数提示，移到游戏界面显示 -->
                    <span id="level-hint" class="hidden"></span>
                </div>
                <div id="level-select" class="grid grid-cols-5 gap-2"></div>
            </div>
            
            <!-- 倒计时开关 -->
            <div class="mb-4 flex items-center justify-center gap-3 bg-gray-50 rounded-2xl p-2">
                <i class="fa fa-clock-o text-gray-600"></i>
                <span class="text-gray-700 font-medium text-sm">倒计时模式</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="timer-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
                <span class="text-xs text-gray-500" id="timer-description">不限时游戏</span>
            </div>
            
            <!-- 徽章预览 -->
            <div id="badge-preview" class="mb-5">
                <h3 class="text-sm font-bold mb-2">我的徽章</h3>
                <div id="badge-preview-grid" class="flex justify-center gap-3 flex-wrap"></div>
                
            </div>
            
            <!-- 游戏说明 -->
            <div class="mb-5">
                <div class="bg-gradient-to-r from-primary/5 to-secondary/5 rounded-xl p-4 text-sm">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="flex items-center">
                            <span class="text-lg mr-2">👆</span>
                            <span class="text-gray-700">翻开卡片</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-lg mr-2">🎯</span>
                            <span class="text-gray-700">找到配对</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-lg mr-2">🔊</span>
                            <span class="text-gray-700">听发音</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-lg mr-2">🏆</span>
                            <span class="text-gray-700">完成挑战</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 开始游戏按钮 -->
            <button id="start-game-btn" onclick="startGame()" disabled
                    class="w-full bg-gradient-to-r from-primary to-secondary hover:from-secondary hover:to-primary text-white font-bold py-3 px-6 rounded-2xl shadow-lg transform transition-all duration-300 scale-hover disabled:opacity-50 disabled:cursor-not-allowed">
                开始游戏 <i class="fa fa-play ml-2"></i>
            </button>
        </div>
    </div>

    <script>
    (function(){
      const GAME_KEY = 'memory';
      const badgeDefs = [
        { id: 'first_match', name: '首配成功', icon: '🎯' },
        { id: 'combo_5', name: '连击达人', icon: '🔥' },
        { id: 'speed_clear', name: '极速通关', icon: '⚡' },
        { id: 'level_master', name: '关卡高手', icon: '🏆' },
        { id: 'perfect_board', name: '完美局', icon: '💎' }
      ];
      function getEarnedIds(){
        try { return JSON.parse(localStorage.getItem('earnedAchievements_' + GAME_KEY) || '[]'); } catch(_) { return []; }
      }
      function renderBadgePreview(){
        const grid = document.getElementById('badge-preview-grid');
        if(!grid) return;
        const owned = new Set(getEarnedIds());
        grid.innerHTML = badgeDefs.map(a => {
          const earned = owned.has(a.id);
          const base = earned ? 'from-yellow-100 to-orange-100 border-yellow-300 text-amber-900' : 'from-gray-50 to-gray-100 border-gray-200 text-gray-400 opacity-80';
          return `
            <div class="relative w-20 h-20 rounded-2xl border-2 bg-gradient-to-br ${base} shadow-sm flex flex-col items-center justify-center overflow-hidden" title="${a.name}">
              <div class="text-2xl mb-1">${a.icon}</div>
              <div class="text-[10px] font-bold text-center leading-tight px-1">${a.name}</div>
          ${earned ? '<div class=\"absolute right-1 top-1 bg-amber-400 text-white text-[10px] px-1 rounded-full shadow\">已获</div>' : '<div class=\"absolute right-1 top-1 bg-gray-400 text-white text-[10px] px-1 rounded-full shadow\">未获</div>'}
            </div>`;
        }).join('');
      }
      document.addEventListener('DOMContentLoaded', renderBadgePreview);
    })();
    </script>
    
    <!-- 游戏界面 -->
    <div id="game-screen" class="hidden flex flex-col min-h-screen p-4">
        <!-- 游戏头部（参考反义词单人版风格） -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-3 mb-4">
            <div class="flex justify-between items-center">
                <!-- 左：返回 + 难度/关卡胶囊 -->
                <div class="flex items-center gap-2">
                    <button onclick="backToStart()" class="bg-white/90 backdrop-blur-sm px-3 py-2 rounded-full shadow-md transition-all duration-300 hover:scale-105 active:scale-95 text-sm font-bold text-gray-600 hover:text-gray-800">
                        <i class="fa fa-arrow-left mr-1"></i><span class="hidden sm:inline">返回</span>
                </button>
                    <div id="hud-diff-pill" class="hidden sm:flex bg-gradient-to-r from-primary to-secondary text-white px-3 py-1 rounded-full text-xs font-bold shadow">
                        <span id="hud-difficulty">-</span>
                </div>
                    <div id="hud-level-pill" class="bg-secondary text-white px-3 py-1 rounded-full text-xs font-bold shadow">
                        第 <span id="hud-level">-</span> 关
                </div>
                    <span id="hud-progress" class="hidden"></span>
            </div>

                <!-- 中：倒计时胶囊 -->
                <div id="wm-timer-wrap" class="hidden bg-accent text-white px-6 py-2 rounded-full shadow-md flex items-center gap-2">
                    <i class="fa fa-clock-o"></i>
                    <span id="wm-countdown" class="text-lg font-bold">--:--</span>
                </div>

                <!-- 右：得分胶囊 -->
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 px-4 py-2 rounded-full text-white font-bold shadow-md flex items-center gap-2">
                    <i class="fa fa-star"></i>
                    <span id="game-score">0</span>
                </div>
                </div>

            <!-- 二级统计：已配对/总对数/翻牌次数 -->
            <div class="flex justify-center items-center gap-3 mt-2">
                <div class="bg-gray-100 px-3 py-1 rounded-full text-xs text-gray-700">
                    已配对 <span id="matched-pairs" class="text-secondary font-bold ml-1">0</span>
                </div>
                <div class="bg-gray-100 px-3 py-1 rounded-full text-xs text-gray-700">
                    总对数 <span id="total-pairs" class="text-gray-800 font-bold ml-1">0</span>
                </div>
                <div class="bg-gray-100 px-3 py-1 rounded-full text-xs text-gray-700">
                    翻牌次数 <span id="flip-count" class="text-accent font-bold ml-1">0</span>
                </div>
            </div>
        </div>
        
        <!-- 游戏区域 -->
        <div class="flex-1 flex items-center justify-center">
            <div class="absolute top-28 left-0 right-0 flex justify-center pointer-events-none">
                <div id="wm-feedback" class="pointer-events-none"></div>
            </div>
            <div id="game-board" class="grid gap-3 bg-white rounded-2xl shadow-lg p-6">
                <!-- 卡片将动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 结果界面 -->
    <div id="result-screen" class="hidden flex flex-col items-center justify-center min-h-screen p-4">
        <div class="text-center max-w-xl mx-auto bg-white rounded-3xl shadow-2xl p-8 transform transition-all duration-300">
            <div id="result-icon" class="text-8xl mb-6 level-complete">🎉</div>
            <h2 id="result-title" class="text-3xl font-bold text-primary mb-4">恭喜完成！</h2>
            
            <div class="bg-gradient-to-r from-primary/10 to-secondary/10 rounded-2xl p-6 mb-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-primary" id="final-score">0</p>
                        <p class="text-sm text-gray-600">最终得分</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-secondary" id="final-flips">0</p>
                        <p class="text-sm text-gray-600">翻牌次数</p>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <p id="performance-text" class="text-lg font-bold text-accent">表现优秀！</p>
                </div>
            </div>
            
            <div class="space-x-4">
                <button onclick="startGame()" 
                        class="bg-gradient-to-r from-primary to-secondary hover:from-secondary hover:to-primary text-white px-6 py-3 rounded-2xl scale-hover">
                    <i class="fa fa-refresh mr-2"></i>再玩一次
                </button>
                <button id="next-level-btn" onclick="nextLevel()" 
                        class="hidden bg-secondary hover:bg-emerald-600 text-white px-6 py-3 rounded-2xl scale-hover">
                    <i class="fa fa-step-forward mr-2"></i>下一关
                </button>
                <button onclick="backToStart()" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-2xl scale-hover">
                    <i class="fa fa-home mr-2"></i>返回开始
                </button>
            </div>
        </div>
    </div>

    <script>
        // 调试开关与工具
        const DEBUG = true; // 若要关闭日志，改为 false
        const resizeObserver = new ResizeObserver(entries => {
            for (const entry of entries) {
                const el = entry.target;
                logCardSize('resize', el);
            }
        });
        function logCardSize(tag, el){
            if (!DEBUG || !el) return;
            const rect = el.getBoundingClientRect();
            const cls = el.className;
            console.log(`[word-memory][${tag}] index=${el.dataset.index} word=${el.dataset.word} ` +
                `size=${Math.round(rect.width)}x${Math.round(rect.height)} classes="${cls}"`);
        }

        // 从“本地词典”生成单词池；若词典未加载，临时用内置少量兜底
        const fallbackWordData = {
            easy: ['cat','dog','egg','tea','sun','sky','sea','red','bus','car'],
            medium: ['chair','window','banana','butter','train','metro','music','dance','today','cloudy'],
            hard: ['computer','keyboard','television','mountain','biology','geometry','internet','website']
        };

        // 游戏状态
        let currentDifficulty = null;
        let currentLevel = 1;
        let gameBoard = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let totalPairs = 0;
        let score = 0;
        let flipCount = 0;
        let timerEnabled = true;
        let timerRef = null;
        let timeLeftSec = 0;

        // 关卡与进度
        const LEVELS_PER_DIFF = 10;
        const PROGRESS_KEY = 'wordMemoryProgress';
        function loadWMProgress(){
            try{
                const raw = JSON.parse(localStorage.getItem(PROGRESS_KEY) || '{}');
                ['easy','medium','hard'].forEach(d=>{
                    if(!raw[d]) raw[d] = { unlocked: 1, completed: {} };
                });
                return raw;
            }catch(_){
                return { easy:{unlocked:1,completed:{}}, medium:{unlocked:1,completed:{}}, hard:{unlocked:1,completed:{}} };
            }
        }
        function saveWMProgress(p){ localStorage.setItem(PROGRESS_KEY, JSON.stringify(p)); }
        function renderLevelButtons(){
            const container = document.getElementById('level-select');
            const hint = document.getElementById('level-hint');
            container.innerHTML = '';
            if(!currentDifficulty){ hint.textContent = '先选择难度'; return; }
            const progress = loadWMProgress();
            const unlocked = progress[currentDifficulty].unlocked || 1;
            hint.textContent = `已解锁到第 ${unlocked} 关`;
            for(let i=1;i<=LEVELS_PER_DIFF;i++){
                const btn = document.createElement('button');
                const isUnlocked = i <= unlocked;
                const isCompleted = !!progress[currentDifficulty].completed[i];
                btn.className = `px-3 py-2 rounded-xl text-sm font-bold border transition ${isUnlocked? 'bg-white hover:bg-gray-50 border-gray-200 text-gray-700':'bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed'} ${i===currentLevel? 'ring-2 ring-primary':''}`;
                btn.textContent = `${i}` + (isCompleted? '★':'');
                if(isUnlocked){
                    btn.onclick = ()=> selectLevel(i);
                }
                container.appendChild(btn);
            }
        }
        function selectLevel(level){
            currentLevel = level;
            renderLevelButtons();
            const startBtn = document.getElementById('start-game-btn');
            startBtn.disabled = false;
            startBtn.classList.remove('opacity-50','cursor-not-allowed');
        }

        // 游戏管理器
        class WordMemoryGame {
            constructor() {
                this.initSpeechSynthesis();
            }

            // 初始化语音合成
            initSpeechSynthesis() {
                this.voices = [];
                this.englishVoice = null;
                
                if ('speechSynthesis' in window) {
                    const loadVoices = () => {
                        this.voices = speechSynthesis.getVoices();
                        this.englishVoice = this.voices.find(voice => 
                            voice.lang.includes('en') && 
                            (voice.name.includes('English') || voice.lang === 'en-US')
                        ) || this.voices[0];
                        console.log('选择英语语音:', this.englishVoice?.name);
                    };

                    if (this.voices.length === 0) {
                        speechSynthesis.onvoiceschanged = loadVoices;
                    } else {
                        loadVoices();
                    }
                }
            }

            // 播放英文发音  
            speak(text, rate = 0.85) {
                if (!('speechSynthesis' in window)) return;
                // 尽量使用已加载的英语语音
                const speakNow = () => {
                    const utterance = new SpeechSynthesisUtterance(text.toLowerCase());
                    utterance.voice = this.englishVoice || null;
                    utterance.lang = 'en-US';
                    utterance.rate = rate;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.95;
                    try { speechSynthesis.cancel(); } catch(_){}
                    try { speechSynthesis.speak(utterance); } catch(e){ console.warn('TTS 播放失败', e); }
                };
                if (!this.englishVoice) {
                    // 等待voices加载再播，避免静音
                    const tryOnce = () => {
                        this.voices = speechSynthesis.getVoices();
                        this.englishVoice = this.voices.find(v => v.lang.includes('en') && (v.name.includes('English') || v.lang === 'en-US')) || this.voices[0];
                        speakNow();
                    };
                    if (speechSynthesis.getVoices().length === 0) {
                        speechSynthesis.onvoiceschanged = tryOnce;
                        // 超时兜底
                        setTimeout(speakNow, 300);
                    } else {
                        tryOnce();
                    }
                } else {
                    speakNow();
                }
            }

            // 记录学习进度
            recordProgress(completed) {
                if (completed) {
                    const points = Math.max(100 - flipCount * 2, 20); // 翻牌越少得分越高
                    score += points;
                    try { if (window.achievements) window.achievements.unlockAchievement('wm_first_clear'); } catch(_) {}
                }

                // 调用进度记录系统
                if (window.recordLearningProgress) {
                    window.recordLearningProgress('english', 'memory', score, 60);
                }
            }
        }

        const gameManager = new WordMemoryGame();
        // 简易翻译表（常见基础词）
        const translations = {
            // 动物与自然
            cat:'猫', dog:'狗', pig:'猪', cow:'牛', fox:'狐狸', rat:'老鼠', bat:'蝙蝠', bee:'蜜蜂', ant:'蚂蚁', bug:'虫子',
            owl:'猫头鹰', hen:'母鸡', yak:'牦牛', ape:'猿', fish:'鱼', bird:'鸟', horse:'马', sheep:'羊', goat:'山羊', duck:'鸭子',
            sun:'太阳', sky:'天空', sea:'海',

            // 食物
            egg:'鸡蛋', pie:'派', jam:'果酱', tea:'茶', ice:'冰', ham:'火腿', nut:'坚果', rice:'米饭', soup:'汤', bread:'面包',
            water:'水', juice:'果汁', milk:'牛奶', cookie:'饼干', pizza:'披萨', burger:'汉堡', salad:'沙拉', pasta:'意大利面', chicken:'鸡肉',
            butter:'黄油',

            // 交通
            car:'汽车', bus:'公交车', train:'火车', plane:'飞机', boat:'船', bike:'自行车', truck:'卡车', taxi:'出租车', metro:'地铁',

            // 家居/家庭
            house:'房子', table:'桌子', chair:'椅子', window:'窗户', kitchen:'厨房', bedroom:'卧室', garden:'花园', family:'家庭',
            mother:'母亲', father:'父亲', sister:'姐妹', brother:'兄弟', dinner:'晚餐', breakfast:'早餐', shower:'淋浴', toilet:'厕所',
            carpet:'地毯', picture:'图片', mirror:'镜子', drawer:'抽屉',

            // 学校/形状
            school:'学校', teacher:'老师', student:'学生', lesson:'课程', pencil:'铅笔', paper:'纸', ruler:'尺子', eraser:'橡皮',
            crayon:'蜡笔', marker:'记号笔', book:'书', page:'页', story:'故事', letter:'字母', number:'数字', color:'颜色',
            shape:'形状', circle:'圆形', square:'正方形', triangle:'三角形',

            // 颜色与水果
            red:'红色', blue:'蓝色', green:'绿色', apple:'苹果', orange:'橙子', grape:'葡萄', banana:'香蕉', cheese:'奶酪', cookie:'饼干', candy:'糖果', pizza:'披萨', burger:'汉堡', french:'法语/法国的', salad:'沙拉', soup:'汤', rice:'米饭',

            // 时间
            today:'今天', tomorrow:'明天', morning:'早晨', evening:'傍晚',

            // 天气
            sunny:'晴天', cloudy:'多云', rainy:'下雨', windy:'有风', snowy:'下雪', storm:'暴风雨',

            // 动物扩展
            mouse:'老鼠', rabbit:'兔子', tiger:'老虎', lion:'狮子',

            // 运动娱乐
            game:'游戏', sport:'运动', music:'音乐', dance:'跳舞', sing:'唱歌', play:'玩耍', run:'跑步', jump:'跳跃', swim:'游泳', climb:'攀爬'
        };

        // 额外：可选本地字典（assets/en-zh-basic.json）。
        // 说明：浏览器无法直接调用系统词典，因此使用内置 JSON 文件作为“本地词典”。
        let DICT = {};
        let dictLoaded = false;
        // 按难度分组的词典缓存
        const DICT_BY_DIFF = { easy: {}, medium: {}, hard: {} };
        async function loadLocalDictionary(){
            try{
                const res = await fetch('assets/en-zh-basic.json', { cache: 'no-cache' });
                if(res.ok){
                    DICT = await res.json();
                    dictLoaded = true;
                    // 将词典按词长粗分难度：<=4 为 easy，5-7 为 medium，其余为 hard
                    Object.keys(DICT).forEach(w => {
                        const len = w.length;
                        const key = len <= 4 ? 'easy' : (len <= 7 ? 'medium' : 'hard');
                        DICT_BY_DIFF[key][w] = DICT[w];
                    });
                    if (DEBUG) console.log('[word-memory] local dictionary loaded, size=', Object.keys(DICT).length);
                }
            }catch(e){
                if (DEBUG) console.warn('[word-memory] load dictionary failed:', e);
            }
        }
        function getZh(word){
            const k = (word||'').toLowerCase();
            return translations[k] || DICT[k] || '';
        }
        
        // 倒计时开关逻辑
        document.getElementById('timer-toggle').addEventListener('change', function() {
            const description = document.getElementById('timer-description');
            if (this.checked) {
                description.textContent = '根据难度限时';
                timerEnabled = true;
            } else {
                description.textContent = '不限时游戏';
                timerEnabled = false;
            }
        });

        // 初始同步开关状态 → 计时逻辑
        document.addEventListener('DOMContentLoaded', () => {
            const toggleEl = document.getElementById('timer-toggle');
            const description = document.getElementById('timer-description');
            if (toggleEl) {
                timerEnabled = !!toggleEl.checked;
                description.textContent = toggleEl.checked ? '根据难度限时' : '不限时游戏';
            }
        });

        // 选择难度
        function selectDifficulty(difficulty) {
            currentDifficulty = difficulty;
            // 默认选中当前难度下已解锁的最高关
            const progress = loadWMProgress();
            currentLevel = progress[difficulty]?.unlocked || 1;
            
            // 重置所有按钮样式
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-primary');
            });
            
            // 高亮选中的按钮
            event.target.closest('.difficulty-btn').classList.add('ring-4', 'ring-primary');
            
            // 启用开始按钮
            const startBtn = document.getElementById('start-game-btn');
            startBtn.disabled = false;
            startBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // 渲染关卡按钮
            renderLevelButtons();
        }

        // 开始游戏
        function startGame() {
            if (!currentDifficulty) {
                alert('请先选择难度和关卡！');
                return;
            }

            // 读取开始页开关最终状态
            const toggleEl = document.getElementById('timer-toggle');
            timerEnabled = toggleEl ? !!toggleEl.checked : true;

            // 重置游戏状态
            flippedCards = [];
            matchedPairs = 0;
            score = 0;
            flipCount = 0;

            // 生成游戏板
            generateGameBoard();
            
            // 切换界面
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            updateGameStats();

            // 异步加载本地词典（若未加载）
            if (!dictLoaded) loadLocalDictionary();

            // 更新 HUD 难度与关卡
            const dmap = { easy:'简单', medium:'中等', hard:'困难' };
            document.getElementById('hud-difficulty').textContent = dmap[currentDifficulty] || '-';
            document.getElementById('hud-level').textContent = String(currentLevel);
            document.getElementById('hud-progress').textContent = `${currentLevel}/${LEVELS_PER_DIFF}`;

            // 启动倒计时
            startLevelTimer();
        }

        // 从单词库中随机选择单词
        function getRandomWords(difficulty, count) {
            let pool = [];
            if (dictLoaded && DICT_BY_DIFF[difficulty]) {
                pool = Object.keys(DICT_BY_DIFF[difficulty]);
            } else {
                pool = fallbackWordData[difficulty] || [];
            }
            const shuffled = [...pool].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count);
        }
        
        // 生成游戏板
        function generateGameBoard() {
            const boardSize = {
                easy: { cols: 3, rows: 2 },
                medium: { cols: 4, rows: 3 },
                hard: { cols: 4, rows: 4 }
            };

            const { cols, rows } = boardSize[currentDifficulty];
            totalPairs = (cols * rows) / 2;
            
            // 从单词库随机选择需要的单词数量
            const selectedWords = getRandomWords(currentDifficulty, totalPairs);
            
            // 创建卡片对
            const cardPairs = [];
            selectedWords.forEach(word => {
                cardPairs.push(word, word); // 每个单词创建两张卡片
            });
            
            // 打乱卡片
            gameBoard = cardPairs.sort(() => Math.random() - 0.5);
            
            // 创建游戏板DOM
            const board = document.getElementById('game-board');
            board.innerHTML = '';
            board.className = `grid gap-3 bg-white rounded-2xl shadow-lg p-6 grid-cols-${cols}`;
            // 先用 fr 布局渲染一帧，随后用像素锁定尺寸，避免抖动
            board.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
            
            gameBoard.forEach((word, index) => {
                const card = document.createElement('div');
                // 移除 scale-hover，避免 hover 时视觉缩放造成“尺寸变化”的观感
                card.className = 'word-card bg-gradient-to-br from-primary to-purple-600 text-white rounded-xl cursor-pointer flex flex-col items-center justify-center p-4 text-center';
                card.innerHTML = `
                    <div class="card-front flex flex-col items-center justify-center h-full">
                        <i class="fa fa-question text-3xl mb-2"></i>
                        <p class="text-sm">点击翻开</p>
                    </div>
                    <div class="card-back hidden flex-col items-center justify-center h-full">
                        <p class="word-en text-2xl font-bold mb-2 leading-tight">${word}</p>
                        <p class="translation hidden text-white/90 text-sm mb-1"></p>
                        <button onclick="event.stopPropagation(); gameManager.speak('${word}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full p-1 text-sm" aria-label="播放读音">
                            <i class="fa fa-volume-up"></i>
                        </button>
                    </div>
                `;
                card.dataset.word = word;
                card.dataset.index = index;
                card.onclick = () => flipCard(index);
                board.appendChild(card);

                // 初始尺寸日志
                if (DEBUG) logCardSize('init', card);
                // 监听尺寸变化
                if (DEBUG) resizeObserver.observe(card);
            });

            // 锁定卡片尺寸，避免运行中抖动；为避免文字换行，适度提高单元格尺寸（加上边距系数）
            requestAnimationFrame(() => lockCardSizes(cols, 1.12));
        }

        // 翻牌
        function flipCard(index) {
            if (flippedCards.length >= 2) return;
            
            const card = document.querySelector(`[data-index="${index}"]`);
            if (card.classList.contains('flipped') || card.classList.contains('matched')) return;
            
            // 翻开卡片
            if (DEBUG) logCardSize('before-flip', card);
            card.classList.add('flipped');
            card.querySelector('.card-front').classList.add('hidden');
            card.querySelector('.card-back').classList.remove('hidden');
            if (DEBUG) logCardSize('after-flip', card);
            flippedCards.push({ index, word: gameBoard[index], element: card });
            
            flipCount++;
            updateGameStats();
            
            // 不自动播放，让用户点击卡片上的播放按钮
            
            // 检查配对
            if (flippedCards.length === 2) {
                setTimeout(checkMatch, 1000);
            }
        }

        // 检查配对
        function checkMatch() {
            const [card1, card2] = flippedCards;
            
            if (card1.word === card2.word) {
                // 配对成功
                card1.element.classList.add('matched', 'correct-animation');
                card2.element.classList.add('matched', 'correct-animation');
                if (DEBUG) { logCardSize('matched-1', card1.element); logCardSize('matched-2', card2.element); }
                
                matchedPairs++;
                score += Math.max(50 - flipCount, 10);
                showWMFeedback(`太棒了！+${Math.max(50 - flipCount, 10)} 分`, 'success');
                
                // 不自动播放成功音效
                // 显示中文翻译
                [card1, card2].forEach(c => {
                    const t = c.element.querySelector('.translation');
                    if (t) {
                        const zh = getZh(c.word);
                        if (zh) {
                            t.textContent = zh;
                            t.classList.remove('hidden');
                            if (DEBUG) logCardSize('show-translation', c.element);
                        }
                    }
                });
                
                // 检查游戏结束
                if (matchedPairs === totalPairs) {
                    // 进入“回看单词”短暂停留，再进入结果页（7秒）
                    startReviewCountdown(7);
                }
            } else {
                // 配对失败
                card1.element.classList.add('wrong-animation');
                card2.element.classList.add('wrong-animation');
                
                setTimeout(() => {
                    // 翻回去
                    if (DEBUG) { logCardSize('before-unflip-1', card1.element); logCardSize('before-unflip-2', card2.element); }
                    card1.element.classList.remove('flipped', 'wrong-animation');
                    card1.element.querySelector('.card-front').classList.remove('hidden');
                    card1.element.querySelector('.card-back').classList.add('hidden');
                    
                    card2.element.classList.remove('flipped', 'wrong-animation');
                    card2.element.querySelector('.card-front').classList.remove('hidden');
                    card2.element.querySelector('.card-back').classList.add('hidden');
                    if (DEBUG) { logCardSize('after-unflip-1', card1.element); logCardSize('after-unflip-2', card2.element); }
                }, 800);
                showWMFeedback('再想想！', 'error');
            }
            
            flippedCards = [];
            updateGameStats();
        }

        // 计时：按难度/关卡设定总时长（可调整）
        function getLevelTimeLimitSec(){
            // 基线：easy 90s, medium 120s, hard 150s；后续关适当增加
            const base = { easy: 90, medium: 120, hard: 150 }[currentDifficulty] || 120;
            const bonus = Math.min(currentLevel-1, 9) * 5; // 每关+5秒上限+45
            return base + bonus;
        }
        function startLevelTimer(){
            clearInterval(timerRef);
            const wrap = document.getElementById('wm-timer-wrap');
            const cd = document.getElementById('wm-countdown');
            if(!timerEnabled){
                wrap.classList.add('hidden');
                return;
            }
            wrap.classList.remove('hidden');
            timeLeftSec = getLevelTimeLimitSec();
            updateCountdownText();
            timerRef = setInterval(()=>{
                timeLeftSec -= 1;
                updateCountdownText();
                if(timeLeftSec <= 10){ wrap.classList.add('animate-pulse'); }
                if(timeLeftSec <= 0){
                    clearInterval(timerRef);
                    showWMFeedback('时间到！', 'error');
                    setTimeout(gameComplete, 800);
                }
            }, 1000);
        }
        function updateCountdownText(){
            const m = Math.floor(Math.max(0,timeLeftSec)/60).toString().padStart(1,'0');
            const s = Math.floor(Math.max(0,timeLeftSec)%60).toString().padStart(2,'0');
            const cd = document.getElementById('wm-countdown');
            if(cd) cd.textContent = `${m}:${s}`;
        }
        function stopLevelTimer(){ clearInterval(timerRef); }
        
        // 顶部激励反馈（参考反义词单人版风格）
        function showWMFeedback(text, type){
            const box = document.getElementById('wm-feedback');
            if(!box) return;
            box.className = '';
            box.textContent = text;
            box.classList.add('rounded-full','px-4','py-2','text-sm','font-bold','shadow-lg');
            if(type==='success') box.classList.add('bg-green-500','text-white');
            else if(type==='error') box.classList.add('bg-red-500','text-white');
            else box.classList.add('bg-blue-500','text-white');
            setTimeout(()=>{ box.textContent=''; box.className=''; }, 1200);
        }

        // 回看单词：完成后停留 N 秒再显示结果
        function startReviewCountdown(seconds){
            stopLevelTimer();
            // 显示提示
            showWMFeedback(`先看一看这些单词（${seconds}s）`, 'info');
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 flex items-start justify-center pt-24 pointer-events-none';
            overlay.innerHTML = `<div class="bg-white/80 backdrop-blur-sm px-4 py-2 rounded-full text-gray-700 text-sm shadow">正在回顾...</div>`;
            document.body.appendChild(overlay);
            // 确保所有卡片保持翻开状态
            document.querySelectorAll('#game-board .word-card').forEach(el=>{
                if(!el.classList.contains('flipped')){
                    el.classList.add('flipped');
                    el.querySelector('.card-front')?.classList.add('hidden');
                    el.querySelector('.card-back')?.classList.remove('hidden');
                }
            });
            setTimeout(()=>{
                overlay.remove();
                gameComplete();
            }, Math.max(1, seconds)*1000);
        }

        // 更新游戏统计
        function updateGameStats() {
            document.getElementById('game-score').textContent = score;
            document.getElementById('matched-pairs').textContent = matchedPairs;
            document.getElementById('total-pairs').textContent = totalPairs;
            document.getElementById('flip-count').textContent = flipCount;
        }

        // 计算并锁定卡片像素尺寸，避免由于容器宽度细微变动引起的跳动
        function lockCardSizes(cols, scaleFactor = 1){
            const board = document.getElementById('game-board');
            if (!board) return;
            const styles = getComputedStyle(board);
            const paddingLeft = parseFloat(styles.paddingLeft) || 0;
            const paddingRight = parseFloat(styles.paddingRight) || 0;
            const columnGap = parseFloat(styles.columnGap || styles.gap) || 0;
            const boardWidth = board.clientWidth;
            const usable = boardWidth - paddingLeft - paddingRight - columnGap * (cols - 1);
            let cell = Math.floor(usable / cols);
            cell = Math.floor(cell * scaleFactor); // 放大一点，避免英文/中文被挤换行
            board.style.gridTemplateColumns = `repeat(${cols}, ${cell}px)`;
            document.querySelectorAll('#game-board .word-card').forEach(el => {
                el.style.width = cell + 'px';
                el.style.height = cell + 'px';
                if (DEBUG) logCardSize('lock-size', el);
            });
            if (DEBUG) console.log(`[word-memory][lock-size] boardWidth=${boardWidth}, usable=${usable}, cell=${cell}`);
        }

        // 监听窗口大小变化，重新锁定（防抖）
        let resizeTimer = null;
        window.addEventListener('resize', () => {
            if (resizeTimer) clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                const cols = document.querySelectorAll('#game-board .word-card').length ?
                    getComputedStyle(document.getElementById('game-board')).gridTemplateColumns.split(' ').length : 0;
                if (cols > 0) lockCardSizes(cols, 1.12);
            }, 120);
        });

        // 游戏完成
        function gameComplete() {
            stopLevelTimer();
            gameManager.recordProgress(true);
            
            // 显示结果
            document.getElementById('final-score').textContent = score;
            document.getElementById('final-flips').textContent = flipCount;
            
            // 评估表现
            let performance = '';
            const efficiency = flipCount / (totalPairs * 2); // 理想翻牌次数的比率
            
            if (efficiency <= 1.2) {
                performance = '完美！记忆力超强！';
                document.getElementById('result-icon').textContent = '🏆';
            } else if (efficiency <= 1.5) {
                performance = '优秀！表现很棒！';
                document.getElementById('result-icon').textContent = '🌟';
            } else if (efficiency <= 2.0) {
                performance = '良好！继续练习！';
                document.getElementById('result-icon').textContent = '👍';
            } else {
                performance = '加油！多练习记忆力！';
                document.getElementById('result-icon').textContent = '💪';
            }
            
            document.getElementById('performance-text').textContent = performance;
            
            // 切换到结果界面
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');

            // 记录关卡进度并显示“下一关”
            const progress = loadWMProgress();
            progress[currentDifficulty].completed[currentLevel] = true;
            if(currentLevel < LEVELS_PER_DIFF){
                progress[currentDifficulty].unlocked = Math.max(progress[currentDifficulty].unlocked, currentLevel + 1);
                document.getElementById('next-level-btn').classList.remove('hidden');
            } else {
                document.getElementById('next-level-btn').classList.add('hidden');
            }
            saveWMProgress(progress);
        }

        // 返回开始界面
        function backToStart() {
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            renderLevelButtons();
        }

        // 下一关
        function nextLevel(){
            const progress = loadWMProgress();
            const unlocked = progress[currentDifficulty]?.unlocked || 1;
            if(currentLevel < LEVELS_PER_DIFF && currentLevel < unlocked){
                currentLevel += 1;
            }
            document.getElementById('next-level-btn').classList.add('hidden');
            startGame();
        }
    </script>
</body>
</html>