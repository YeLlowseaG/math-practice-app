<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ä¹ è¿›åº¦ä¸­å¿ƒ - æ™ºèƒ½åˆ†æä¸å»ºè®®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script defer src="./wellness.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dasharray 0.35s;
            transform-origin: 50% 50%;
        }
        .ai-suggestion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }
        .achievement-badge {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            margin: 5px;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
        }
        .skill-bar {
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
            margin: 10px 0;
        }
        .skill-progress {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 10px;
            transition: width 1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-6xl mx-auto">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <div class="card p-6 mb-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <button onclick="window.location.href='index.html'" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-full mr-4">
                        <i class="fa fa-home mr-2"></i>è¿”å›é¦–é¡µ
                    </button>
                    <h1 class="text-3xl font-bold text-gray-800">ğŸ“Š å­¦ä¹ è¿›åº¦ä¸­å¿ƒ</h1>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">ä»Šæ—¥å­¦ä¹ æ—¶é—´</p>
                    <p class="text-2xl font-bold text-blue-600" id="today-study-time">0åˆ†é’Ÿ</p>
                </div>
            </div>
        </div>

        <!-- æˆå°±å¾½ç« å±•ç¤ºï¼ˆç§»åˆ°é¡¶éƒ¨ï¼‰ -->
        <div class="card p-6 mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ† æˆå°±å¾½ç« </h3>
            <div class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4" id="achievements-container">
                <!-- å¾½ç« å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- AI å­¦ä¹ å»ºè®®å¡ç‰‡ -->
        <div class="ai-suggestion mb-6">
            <div class="flex items-center mb-4">
                <i class="fa fa-robot text-3xl mr-3"></i>
                <h2 class="text-xl font-bold">ğŸ¤– AI å­¦ä¹ å»ºè®®</h2>
            </div>
            <div id="ai-suggestions">
                <p>æ­£åœ¨åˆ†ææ‚¨çš„å­¦ä¹ æ•°æ®ï¼Œç”Ÿæˆä¸ªæ€§åŒ–å»ºè®®...</p>
            </div>
        </div>

        <!-- æ•°æ®ç»Ÿè®¡é¢æ¿ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <!-- æ€»ä½“è¿›åº¦ -->
            <div class="card p-6 text-center">
                <div class="relative w-24 h-24 mx-auto mb-4">
                    <svg class="progress-ring w-full h-full">
                        <circle cx="48" cy="48" r="40" stroke="#f0f0f0" stroke-width="8" fill="none"/>
                        <circle id="overall-progress-circle" cx="48" cy="48" r="40" stroke="#4facfe" 
                                stroke-width="8" fill="none" stroke-dasharray="0 251.2"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span id="overall-percentage" class="text-xl font-bold text-blue-600">0%</span>
                    </div>
                </div>
                <h3 class="font-bold text-gray-700">æ€»ä½“è¿›åº¦</h3>
                <p class="text-sm text-gray-500">æ‰€æœ‰ç§‘ç›®å¹³å‡</p>
            </div>

            <!-- è¿ç»­å­¦ä¹ å¤©æ•° -->
            <div class="card p-6 text-center">
                <i class="fa fa-fire text-4xl text-orange-500 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-700" id="streak-days">0</h3>
                <p class="text-sm text-gray-500">è¿ç»­å­¦ä¹ å¤©æ•°</p>
            </div>

            <!-- æœ¬å‘¨æ­£ç¡®ç‡ -->
            <div class="card p-6 text-center">
                <i class="fa fa-bullseye text-4xl text-green-500 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-700" id="weekly-accuracy">0%</h3>
                <p class="text-sm text-gray-500">æœ¬å‘¨æ­£ç¡®ç‡</p>
            </div>

            <!-- è·å¾—å¾½ç«  -->
            <div class="card p-6 text-center">
                <i class="fa fa-trophy text-4xl text-yellow-500 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-700" id="total-badges">0</h3>
                <p class="text-sm text-gray-500">è·å¾—å¾½ç« </p>
            </div>
        </div>

        <!-- å­¦ç§‘è¿›åº¦è¯¦æƒ… -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- è¯­æ–‡ç±»å­¦ä¹ è¿›åº¦ -->
            <div class="card p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ è¯­æ–‡ç±»å­¦ä¹ è¿›åº¦</h3>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">æ‹¼éŸ³å­¦ä¹ </span>
                        <span id="pinyin-score">å¹³å‡åˆ†: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="pinyin-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">åä¹‰è¯æŒ‘æˆ˜</span>
                        <span id="antonyms-score">å¹³å‡åˆ†: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="antonyms-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">è¯—è¯æ‹¼å›¾</span>
                        <span id="poetry-score">å¹³å‡åˆ†: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="poetry-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-blue-800">
                        <i class="fa fa-book mr-2"></i>
                        <span id="chinese-tip">è¯­æ–‡å­¦ä¹ è¦å¤šè¯»å¤šç»ƒï¼Œæ—¥ç§¯æœˆç´¯ï¼</span>
                    </p>
                </div>
            </div>

            <!-- æ•°ç†æ€ç»´ç±»å­¦ä¹ è¿›åº¦ -->
            <div class="card p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ§  æ•°ç†æ€ç»´ç±»å­¦ä¹ è¿›åº¦</h3>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">åŠ æ³•ç»ƒä¹ </span>
                        <span id="addition-score">å¹³å‡åˆ†: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="addition-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">å‡æ³•ç»ƒä¹ </span>
                        <span id="subtraction-score">å¹³å‡åˆ†: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="subtraction-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">é€»è¾‘æ€ç»´</span>
                        <span id="puzzle-score">å¹³å‡åˆ†: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="puzzle-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-green-800">
                        <i class="fa fa-cogs mr-2"></i>
                        <span id="math-tip">æ•°ç†æ€ç»´éœ€è¦å¾ªåºæ¸è¿›ï¼Œå¤šæ€è€ƒå¤šå®è·µï¼</span>
                    </p>
                </div>
            </div>
            
            <!-- è‹±è¯­ç±»å­¦ä¹ è¿›åº¦ -->
            <div class="card p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸŒ è‹±è¯­ç±»å­¦ä¹ è¿›åº¦</h3>
            
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">å­—æ¯è®¤çŸ¥</span>
                        <span id="letters-score">å¹³å‡åˆ†: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="letters-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">å•è¯è®°å¿†</span>
                        <span id="memory-score">å¹³å‡åˆ†: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="memory-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">å•è¯è¿çº¿</span>
                        <span id="wordconnect-score">å¹³å‡åˆ†: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="wordconnect-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="bg-purple-50 p-4 rounded-lg">
                    <p class="text-sm text-purple-800">
                        <i class="fa fa-globe mr-2"></i>
                        <span id="english-tip">è‹±è¯­å­¦ä¹ è¦å¤šå¬å¤šç»ƒï¼Œå¾ªåºæ¸è¿›ï¼</span>
                    </p>
                </div>
            </div>
        </div>

        


        <!-- å¿«é€Ÿå¼€å§‹å­¦ä¹  -->
        <div class="card p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸš€ ç»§ç»­å­¦ä¹ </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <button onclick="window.location.href='pinyin-game.html'" 
                        class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg transition-colors">
                    <i class="fa fa-book text-2xl mb-2"></i>
                    <p class="font-bold">æ‹¼éŸ³ç»ƒä¹ </p>
                    <p class="text-sm opacity-90">ç»§ç»­å­¦ä¹ å£°æ¯éŸµæ¯</p>
                </button>
                <button onclick="window.location.href='math-practice.html'" 
                        class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg transition-colors">
                    <i class="fa fa-calculator text-2xl mb-2"></i>
                    <p class="font-bold">æ•°å­¦ç»ƒä¹ </p>
                    <p class="text-sm opacity-90">åŠ å‡æ³•è®¡ç®—è®­ç»ƒ</p>
                </button>
                <button onclick="window.location.href='word-connect.html'" 
                        class="bg-teal-500 hover:bg-teal-600 text-white p-4 rounded-lg transition-colors">
                    <i class="fa fa-link text-2xl mb-2"></i>
                    <p class="font-bold">å•è¯è¿çº¿</p>
                    <p class="text-sm opacity-90">è¿æ¥å­—æ¯ç»„æˆå•è¯</p>
                </button>
                <button onclick="window.location.href='antonym-solo.html'" 
                        class="bg-orange-500 hover:bg-orange-600 text-white p-4 rounded-lg transition-colors">
                    <i class="fa fa-user text-2xl mb-2"></i>
                    <p class="font-bold">åä¹‰è¯æŒ‘æˆ˜</p>
                    <p class="text-sm opacity-90">å•äººé—¯å…³æ¨¡å¼</p>
                </button>
                <button onclick="window.location.href='poem-puzzle-solo.html'" 
                        class="bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-lg transition-colors">
                    <i class="fa fa-puzzle-piece text-2xl mb-2"></i>
                    <p class="font-bold">è¯—è¯æ‹¼å›¾</p>
                    <p class="text-sm opacity-90">æ‹–æ‹½æ‹¼å›¾å­¦å¤è¯—</p>
                </button>
                <button onclick="window.location.href='antonym-game.html'" 
                        class="bg-red-500 hover:bg-red-600 text-white p-4 rounded-lg transition-colors">
                    <i class="fa fa-users text-2xl mb-2"></i>
                    <p class="font-bold">åä¹‰è¯å¯¹æˆ˜</p>
                    <p class="text-sm opacity-90">åŒäººç«æŠ€æ¨¡å¼</p>
                </button>
            </div>
        </div>

        <!-- æŠ¤çœ¼æé†’è®¾ç½®ï¼ˆç§»åŠ¨åˆ°åº•éƒ¨ï¼‰ -->
        <div class="ai-suggestion mb-6 mt-6">
            <div class="flex items-center mb-4">
                <i class="fa fa-eye text-3xl mr-3"></i>
                <h2 class="text-xl font-bold">æŠ¤çœ¼æé†’è®¾ç½®</h2>
            </div>
            <div class="mt-2 bg-white/15 rounded-xl p-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="font-bold">å¯ç”¨/å…³é—­</div>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="eye-enabled" class="sr-only">
                        <div id="eye-enabled-track" class="w-10 h-5 bg-white/30 rounded-full relative">
                            <div id="eye-enabled-dot" class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform"></div>
                        </div>
                        <span class="ml-2 text-sm">å¯ç”¨</span>
                    </label>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-white/90">
                    <div>
                        <div class="mb-1">è¿ç»­ä½¿ç”¨åˆ†é’Ÿï¼ˆæ¯æ¬¡æé†’é—´éš”ï¼‰</div>
                        <input id="eye-interval" type="range" min="10" max="40" step="5" class="w-full">
                        <div class="mt-1" id="eye-interval-val">20 åˆ†é’Ÿ</div>
                    </div>
                    <div>
                        <div class="mb-1">ä¼‘æ¯æ—¶é•¿</div>
                        <input id="eye-break" type="range" min="1" max="5" step="1" class="w-full">
                        <div class="mt-1" id="eye-break-val">2 åˆ†é’Ÿ</div>
                    </div>
                    <div>
                        <div class="mb-1">ç¨åæé†’ï¼ˆå»¶åï¼‰</div>
                        <input id="eye-snooze" type="range" min="3" max="10" step="1" class="w-full">
                        <div class="mt-1" id="eye-snooze-val">5 åˆ†é’Ÿ</div>
                    </div>
                </div>
                <div class="text-right mt-3">
                    <button id="eye-reset" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-md text-sm">æ¢å¤é»˜è®¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // T0: unified achievements API
        (function(){
          var s=document.createElement('script');
          s.src='assets/achievements.js?_='+Date.now();
          document.head.appendChild(s);
        })();
        // å­¦ä¹ æ•°æ®ç®¡ç†ç±»
        class LearningProgressManager {
            constructor() {
                this.data = this.loadData();
                this.init();
            }

            // åŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®
            loadData() {
                const defaultData = {
                    totalStudyTime: 0,
                    todayStudyTime: 0,
                    lastStudyDate: null,
                    streakDays: 0,
                    subjects: {
                        pinyin: {
                            consonants: { completed: [], totalScore: 0, attempts: 0 },
                            vowels: { completed: [], totalScore: 0, attempts: 0 }
                        },
                        math: {
                            addition: { totalScore: 0, attempts: 0, bestStreak: 0 },
                            subtraction: { totalScore: 0, attempts: 0, bestStreak: 0 }
                        },
                        vocabulary: {
                            antonyms: { totalScore: 0, attempts: 0, wordsLearned: [] }
                        },
                        english: {
                            letters: { totalScore: 0, attempts: 0, lettersLearned: [] },
                            memory: { totalScore: 0, attempts: 0, wordsRemembered: [] },
                            wordConnect: { totalScore: 0, attempts: 0, wordsFound: [] }
                        }
                    },
                    achievements: [],
                    dailyHistory: {}
                };

                const stored = localStorage.getItem('learningProgress');
                return stored ? { ...defaultData, ...JSON.parse(stored) } : defaultData;
            }

            // ä¿å­˜æ•°æ®
            saveData() {
                localStorage.setItem('learningProgress', JSON.stringify(this.data));
            }

            // åˆå§‹åŒ–ç•Œé¢
            init() {
                this.updateTodayTime();
                this.calculateOverallProgress();
                this.updateStreakDays();
                this.updateSubjectProgress();
                this.generateAchievements();
                this.generateAISuggestions();
            }

            // æ›´æ–°ä»Šæ—¥å­¦ä¹ æ—¶é—´
            updateTodayTime() {
                const today = new Date().toDateString();
                const lastDate = this.data.lastStudyDate;
                
                if (lastDate !== today) {
                    this.data.todayStudyTime = 0;
                    this.data.lastStudyDate = today;
                }

                document.getElementById('today-study-time').textContent = 
                    Math.round(this.data.todayStudyTime / 60) + 'åˆ†é’Ÿ';
            }

            // è®¡ç®—æ€»ä½“è¿›åº¦
            calculateOverallProgress() {
                let totalProgress = 0;
                let categories = 0;

                const subjects = this.data.subjects;

                // è¯­æ–‡ç±»è¿›åº¦
                const chinese = subjects.chinese || {};
                if (chinese.pinyin?.attempts > 0 || chinese.antonyms?.attempts > 0 || chinese.poetry?.attempts > 0) {
                    let chineseProgress = 0;
                    let chineseCount = 0;
                    
                    if (chinese.pinyin?.attempts > 0) {
                        chineseProgress += chinese.pinyin.totalScore / chinese.pinyin.attempts;
                        chineseCount++;
                    }
                    if (chinese.antonyms?.attempts > 0) {
                        chineseProgress += chinese.antonyms.totalScore / chinese.antonyms.attempts;
                        chineseCount++;
                    }
                    if (chinese.poetry?.attempts > 0) {
                        chineseProgress += chinese.poetry.totalScore / chinese.poetry.attempts;
                        chineseCount++;
                    }
                    
                    if (chineseCount > 0) {
                        totalProgress += (chineseProgress / chineseCount);
                        categories++;
                    }
                }

                // æ•°ç†æ€ç»´ç±»è¿›åº¦
                const math = subjects.math || {};
                if (math.addition?.attempts > 0 || math.subtraction?.attempts > 0 || math.puzzle?.attempts > 0) {
                    let mathProgress = 0;
                    let mathCount = 0;
                    
                    if (math.addition?.attempts > 0) {
                        mathProgress += math.addition.totalScore / math.addition.attempts;
                        mathCount++;
                    }
                    if (math.subtraction?.attempts > 0) {
                        mathProgress += math.subtraction.totalScore / math.subtraction.attempts;
                        mathCount++;
                    }
                    if (math.puzzle?.attempts > 0) {
                        mathProgress += math.puzzle.totalScore / math.puzzle.attempts;
                        mathCount++;
                    }
                    
                    if (mathCount > 0) {
                        totalProgress += (mathProgress / mathCount);
                        categories++;
                    }
                }

                // è‹±è¯­ç±»è¿›åº¦
                const english = subjects.english || {};
                if (english.letters?.attempts > 0 || english.memory?.attempts > 0 || english.wordConnect?.attempts > 0) {
                    let englishProgress = 0;
                    let englishCount = 0;
                    
                    if (english.letters?.attempts > 0) {
                        englishProgress += english.letters.totalScore / english.letters.attempts;
                        englishCount++;
                    }
                    if (english.memory?.attempts > 0) {
                        englishProgress += english.memory.totalScore / english.memory.attempts;
                        englishCount++;
                    }
                    if (english.wordConnect?.attempts > 0) {
                        englishProgress += english.wordConnect.totalScore / english.wordConnect.attempts;
                        englishCount++;
                    }
                    
                    if (englishCount > 0) {
                        totalProgress += (englishProgress / englishCount);
                        categories++;
                    }
                }

                const overallProgress = categories > 0 ? (totalProgress / categories) : 0;
                
                // æ›´æ–°ç¯å½¢è¿›åº¦æ¡
                this.updateCircularProgress('overall-progress-circle', overallProgress);
                document.getElementById('overall-percentage').textContent = 
                    Math.round(overallProgress) + '%';
            }

            // æ›´æ–°ç¯å½¢è¿›åº¦æ¡
            updateCircularProgress(elementId, percentage) {
                const circle = document.getElementById(elementId);
                const radius = 40;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (percentage / 100 * circumference);
                circle.style.strokeDasharray = `${circumference} ${circumference}`;
                circle.style.strokeDashoffset = offset;
            }

            // æ›´æ–°è¿ç»­å­¦ä¹ å¤©æ•°
            updateStreakDays() {
                // è®¡ç®—è¿ç»­å­¦ä¹ å¤©æ•°çš„é€»è¾‘
                document.getElementById('streak-days').textContent = this.data.streakDays;
                
                // è®¡ç®—æœ¬å‘¨æ­£ç¡®ç‡
                const weeklyAccuracy = this.calculateWeeklyAccuracy();
                document.getElementById('weekly-accuracy').textContent = Math.round(weeklyAccuracy) + '%';
            }

            // è®¡ç®—æœ¬å‘¨æ­£ç¡®ç‡ï¼ˆä¿®å¤è®¡ç®—é”™è¯¯ï¼‰
            calculateWeeklyAccuracy() {
                let totalScore = 0;
                let totalAttempts = 0;
                let totalMaxScore = 0;

                Object.values(this.data.subjects).forEach(subject => {
                    Object.values(subject).forEach(activity => {
                        if (activity.totalScore !== undefined && activity.attempts > 0) {
                            totalScore += activity.totalScore;
                            totalAttempts += activity.attempts;
                            // å‡è®¾æ¯æ¬¡æ¸¸æˆæ»¡åˆ†100åˆ†
                            totalMaxScore += activity.attempts * 100;
                        }
                    });
                });

                return totalMaxScore > 0 ? (totalScore / totalMaxScore) * 100 : 0;
            }

            // æ›´æ–°å­¦ç§‘è¿›åº¦
            updateSubjectProgress() {
                // è¯­æ–‡ç±»è¿›åº¦
                const chinese = this.data.subjects.chinese || {};
                
                // æ‹¼éŸ³å­¦ä¹ 
                const pinyinData = chinese.pinyin || {};
                const pinyinAvgScore = pinyinData.attempts > 0 ? (pinyinData.totalScore / pinyinData.attempts) : 0;
                this.updateProgressBar('pinyin', pinyinAvgScore, `å¹³å‡åˆ†: ${Math.round(pinyinAvgScore)}`);
                
                // åä¹‰è¯æŒ‘æˆ˜
                const antonymsData = chinese.antonyms || {};
                const antonymsAvgScore = antonymsData.attempts > 0 ? (antonymsData.totalScore / antonymsData.attempts) : 0;
                this.updateProgressBar('antonyms', antonymsAvgScore, `å¹³å‡åˆ†: ${Math.round(antonymsAvgScore)}`);
                
                // è¯—è¯æ‹¼å›¾
                const poetryData = chinese.poetry || {};
                const poetryAvgScore = poetryData.attempts > 0 ? (poetryData.totalScore / poetryData.attempts) : 0;
                this.updateProgressBar('poetry', poetryAvgScore, `å¹³å‡åˆ†: ${Math.round(poetryAvgScore)}`);

                // æ•°ç†æ€ç»´ç±»è¿›åº¦
                const math = this.data.subjects.math || {};
                
                // åŠ æ³•ç»ƒä¹ 
                const additionData = math.addition || {};
                const additionAvgScore = additionData.attempts > 0 ? (additionData.totalScore / additionData.attempts) : 0;
                this.updateProgressBar('addition', additionAvgScore, `å¹³å‡åˆ†: ${Math.round(additionAvgScore)}`);
                
                // å‡æ³•ç»ƒä¹ 
                const subtractionData = math.subtraction || {};
                const subtractionAvgScore = subtractionData.attempts > 0 ? (subtractionData.totalScore / subtractionData.attempts) : 0;
                this.updateProgressBar('subtraction', subtractionAvgScore, `å¹³å‡åˆ†: ${Math.round(subtractionAvgScore)}`);
                
                // é€»è¾‘æ€ç»´
                const puzzleData = math.puzzle || {};
                const puzzleAvgScore = puzzleData.attempts > 0 ? (puzzleData.totalScore / puzzleData.attempts) : 0;
                this.updateProgressBar('puzzle', puzzleAvgScore, `å¹³å‡åˆ†: ${Math.round(puzzleAvgScore)}`);

                // è‹±è¯­ç±»è¿›åº¦
                const english = this.data.subjects.english || {};
                
                // å­—æ¯è®¤çŸ¥
                const lettersData = english.letters || {};
                const lettersAvgScore = lettersData.attempts > 0 ? (lettersData.totalScore / lettersData.attempts) : 0;
                this.updateProgressBar('letters', lettersAvgScore, `å¹³å‡åˆ†: ${Math.round(lettersAvgScore)}`);
                
                // å•è¯è®°å¿†
                const memoryData = english.memory || {};
                const memoryAvgScore = memoryData.attempts > 0 ? (memoryData.totalScore / memoryData.attempts) : 0;
                this.updateProgressBar('memory', memoryAvgScore, `å¹³å‡åˆ†: ${Math.round(memoryAvgScore)}`);
                
                // å•è¯è¿çº¿
                const wordConnectData = english.wordConnect || {};
                const wordConnectAvgScore = wordConnectData.attempts > 0 ? (wordConnectData.totalScore / wordConnectData.attempts) : 0;
                this.updateProgressBar('wordconnect', wordConnectAvgScore, `å¹³å‡åˆ†: ${Math.round(wordConnectAvgScore)}`);
            }

            // æ›´æ–°è¿›åº¦æ¡çš„è¾…åŠ©æ–¹æ³•
            updateProgressBar(id, avgScore, scoreText) {
                const percentage = Math.min(avgScore, 100);
                const scoreElement = document.getElementById(`${id}-score`);
                const progressElement = document.getElementById(`${id}-progress`);
                
                if (scoreElement) scoreElement.textContent = scoreText;
                if (progressElement) {
                    progressElement.style.width = percentage + '%';
                    progressElement.textContent = Math.round(percentage) + '%';
                }
            }

            // ç”Ÿæˆæˆå°±å¾½ç« ï¼ˆç»Ÿä¸€APIï¼šä»…å±•ç¤ºç³»ç»Ÿçº§/globalï¼‰
            generateAchievements() {
                var self = this;
                function render() {
                    if (!window.achievements || !window.achievements.getAll) {
                        setTimeout(render, 150);
                        return;
                    }
                    // åœ¨å±•ç¤ºå‰ï¼Œæ ¹æ®å½“å‰å­¦ä¹ æ•°æ®åŒæ­¥è§£é”ç³»ç»Ÿçº§æˆå°±
                    try {
                        var subjects = self.data.subjects || {};
                        var chinese = subjects.chinese || {};
                        var math = subjects.math || {};
                        var english = subjects.english || {};
                        var chineseAttempts = (chinese.pinyin?.attempts || 0) + (chinese.antonyms?.attempts || 0) + (chinese.poetry?.attempts || 0);
                        var mathAttempts = (math.addition?.attempts || 0) + (math.subtraction?.attempts || 0) + (math.puzzle?.attempts || 0);
                        var englishAttempts = (english.letters?.attempts || 0) + (english.memory?.attempts || 0) + (english.wordConnect?.attempts || 0);
                        var totalAttempts = chineseAttempts + mathAttempts + englishAttempts;
                        if (totalAttempts > 0) window.achievements.unlockAchievement('global_first_game');
                        if (self.data.streakDays >= 3) window.achievements.unlockAchievement('global_streak_3');
                        if (self.data.streakDays >= 7) window.achievements.unlockAchievement('global_streak_7');
                        if (chineseAttempts > 0 && mathAttempts > 0 && englishAttempts > 0) {
                            window.achievements.unlockAchievement('global_super_learner');
                        }
                    } catch (_) {}
                    const all = window.achievements.getAll();
                    const globals = all.filter(function(a){ return a.scope === 'global'; });
                    const nonGlobals = all.filter(function(a){ return a.scope !== 'global'; });
                    const container = document.getElementById('achievements-container');
                    container.innerHTML = '';
                    // ç³»ç»Ÿçº§
                    globals.forEach(function(a){
                        const earned = !!a.earned;
                        const badge = document.createElement('div');
                        badge.className = `flex flex-col items-center p-3 rounded-xl transition-all duration-300 ${earned ? 'bg-gradient-to-br from-yellow-100 to-orange-100 border-2 border-yellow-300' : 'bg-gray-100 border-2 border-gray-200 opacity-60'}`;
                        badge.innerHTML = `
                            <div class="text-2xl mb-1">${a.icon}</div>
                            <div class="text-xs font-bold text-center text-gray-700">${a.name}</div>
                            <div class="text-xs text-gray-500 text-center mt-1" style="font-size: 10px;">${a.desc}</div>
                        `;
                        badge.title = `${a.name}: ${a.desc} ${earned ? 'âœ… å·²è·å¾—' : 'âŒ æœªè·å¾—'}`;
                        container.appendChild(badge);
                    });
                    var earnedCount = globals.filter(function(a){ return a.earned; }).length;
                    document.getElementById('total-badges').textContent = earnedCount;

                    // å„æ¸¸æˆæˆå°±ï¼ˆé¢„è§ˆï¼‰
                    var host = container.parentElement; // å½“å‰ç½‘æ ¼å¤–å±‚
                    var title = document.createElement('h3');
                    title.className = 'text-xl font-bold text-gray-800 mt-8 mb-4';
                    title.textContent = 'ğŸ® å„æ¸¸æˆæˆå°±ï¼ˆé¢„è§ˆï¼‰';
                    host.appendChild(title);
                    var gameGrid = document.createElement('div');
                    gameGrid.id = 'achievements-games';
                    gameGrid.className = 'grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4';
                    host.appendChild(gameGrid);
                    nonGlobals.forEach(function(a){
                        const earned = !!a.earned;
                        const badge = document.createElement('div');
                        badge.className = `flex flex-col items-center p-3 rounded-xl transition-all duration-300 ${earned ? 'bg-gradient-to-br from-blue-100 to-cyan-100 border-2 border-blue-300' : 'bg-gray-100 border-2 border-gray-200 opacity-60'}`;
                        badge.innerHTML = `
                            <div class="text-2xl mb-1">${a.icon}</div>
                            <div class="text-xs font-bold text-center text-gray-700">${a.name}</div>
                            <div class="text-xs text-gray-500 text-center mt-1" style="font-size: 10px;">${a.desc}</div>
                        `;
                        badge.title = `${a.name}: ${a.desc} ${earned ? 'âœ… å·²è·å¾—' : 'âŒ æœªè·å¾—'}`;
                        gameGrid.appendChild(badge);
                    });
                }
                render();
                try {
                    document.addEventListener('achievement-unlocked', function(){ setTimeout(render, 50); });
                } catch(_) {}
            }

            // ç”ŸæˆAIå­¦ä¹ å»ºè®®
            generateAISuggestions() {
                const suggestions = [];
                const subjects = this.data.subjects;
                
                // è¯­æ–‡ç±»å»ºè®®
                const chinese = subjects.chinese || {};
                let chineseTotal = 0;
                let chineseCount = 0;
                
                if (chinese.pinyin?.attempts > 0) {
                    const pinyinAvg = chinese.pinyin.totalScore / chinese.pinyin.attempts;
                    chineseTotal += pinyinAvg;
                    chineseCount++;
                    if (pinyinAvg < 70) {
                        suggestions.push("ğŸ“ æ‹¼éŸ³å­¦ä¹ éœ€è¦åŠ å¼ºï¼Œå»ºè®®å¤šç»ƒä¹ å£°æ¯éŸµæ¯çš„ç»„åˆã€‚");
                    }
                }
                
                if (chinese.antonyms?.attempts > 0) {
                    const antonymsAvg = chinese.antonyms.totalScore / chinese.antonyms.attempts;
                    chineseTotal += antonymsAvg;
                    chineseCount++;
                    if (antonymsAvg < 70) {
                        suggestions.push("ğŸ”„ åä¹‰è¯ç»ƒä¹ è¿˜éœ€åŠªåŠ›ï¼Œå»ºè®®å¤šè¯»è¯¾å¤–ä¹¦ç§¯ç´¯è¯æ±‡ã€‚");
                    }
                }
                
                if (chinese.poetry?.attempts > 0) {
                    const poetryAvg = chinese.poetry.totalScore / chinese.poetry.attempts;
                    chineseTotal += poetryAvg;
                    chineseCount++;
                    if (poetryAvg < 70) {
                        suggestions.push("ğŸ­ è¯—è¯æ‹¼å›¾éœ€è¦å¤šç»ƒï¼Œå»ºè®®èƒŒè¯µä¸€äº›ç®€å•çš„å¤è¯—ã€‚");
                    }
                }

                // æ•°ç†æ€ç»´ç±»å»ºè®®
                const math = subjects.math || {};
                let mathTotal = 0;
                let mathCount = 0;
                
                if (math.addition?.attempts > 0) {
                    const additionAvg = math.addition.totalScore / math.addition.attempts;
                    mathTotal += additionAvg;
                    mathCount++;
                    if (additionAvg < 70) {
                        suggestions.push("â• åŠ æ³•ç»ƒä¹ éœ€è¦æ›´å¤šæ—¶é—´ï¼Œå»ºè®®ä»å°æ•°å­—å¼€å§‹ç»ƒä¹ ã€‚");
                    }
                }
                
                if (math.subtraction?.attempts > 0) {
                    const subtractionAvg = math.subtraction.totalScore / math.subtraction.attempts;
                    mathTotal += subtractionAvg;
                    mathCount++;
                    if (subtractionAvg < 70) {
                        suggestions.push("â– å‡æ³•ç»ƒä¹ éœ€è¦åŠ å¼ºï¼Œå¯ä»¥ç”¨å®ç‰©å¸®åŠ©ç†è§£ã€‚");
                    }
                }
                
                if (math.puzzle?.attempts > 0) {
                    const puzzleAvg = math.puzzle.totalScore / math.puzzle.attempts;
                    mathTotal += puzzleAvg;
                    mathCount++;
                    if (puzzleAvg < 70) {
                        suggestions.push("ğŸ§© é€»è¾‘æ€ç»´è®­ç»ƒéœ€è¦åšæŒï¼Œå¤šåšç›Šæ™ºæ¸¸æˆæœ‰å¸®åŠ©ã€‚");
                    }
                }

                // è‹±è¯­ç±»å»ºè®®
                const english = subjects.english || {};
                let englishTotal = 0;
                let englishCount = 0;
                
                if (english.letters?.attempts > 0) {
                    const lettersAvg = english.letters.totalScore / english.letters.attempts;
                    englishTotal += lettersAvg;
                    englishCount++;
                    if (lettersAvg < 70) {
                        suggestions.push("ğŸ”¤ å­—æ¯è®¤çŸ¥éœ€è¦å·©å›ºï¼Œå»ºè®®æ¯å¤©ç»ƒä¹ å­—æ¯ä¹¦å†™ã€‚");
                    }
                }
                
                if (english.memory?.attempts > 0) {
                    const memoryAvg = english.memory.totalScore / english.memory.attempts;
                    englishTotal += memoryAvg;
                    englishCount++;
                    if (memoryAvg < 70) {
                        suggestions.push("ğŸ§  å•è¯è®°å¿†éœ€è¦æ–¹æ³•ï¼Œå¯ä»¥å°è¯•è”æƒ³è®°å¿†æ³•ã€‚");
                    }
                }
                
                if (english.wordConnect?.attempts > 0) {
                    const wordConnectAvg = english.wordConnect.totalScore / english.wordConnect.attempts;
                    englishTotal += wordConnectAvg;
                    englishCount++;
                    if (wordConnectAvg < 70) {
                        suggestions.push("ğŸ”— å•è¯è¿çº¿ç»ƒä¹ éœ€è¦åŠ å¼ºï¼Œå¤šç©è‹±è¯­å°æ¸¸æˆã€‚");
                    }
                }

                // ç»¼åˆå»ºè®®
                const chineseAvg = chineseCount > 0 ? chineseTotal / chineseCount : 0;
                const mathAvg = mathCount > 0 ? mathTotal / mathCount : 0;
                const englishAvg = englishCount > 0 ? englishTotal / englishCount : 0;
                
                // åŸºäºå­¦ä¹ é¢‘ç‡çš„å»ºè®®
                if (this.data.streakDays < 2) {
                    suggestions.push("ğŸ“… å»ºè®®å»ºç«‹æ¯æ—¥å­¦ä¹ ä¹ æƒ¯ï¼Œæ¯å¤©15-20åˆ†é’Ÿæ•ˆæœæœ€ä½³ã€‚");
                }

                // ä¸ªæ€§åŒ–é¼“åŠ±
                if (chineseAvg > mathAvg && chineseAvg > englishAvg && chineseAvg > 80) {
                    suggestions.push("âœ¨ ä½ çš„è¯­æ–‡è¡¨ç°å¾ˆæ£’ï¼å¯ä»¥å°è¯•æ›´æœ‰æŒ‘æˆ˜æ€§çš„è¯­æ–‡æ¸¸æˆã€‚");
                } else if (mathAvg > chineseAvg && mathAvg > englishAvg && mathAvg > 80) {
                    suggestions.push("ğŸ¯ æ•°ç†æ€ç»´å¾ˆå¼ºï¼å»ºè®®å°è¯•æ›´å¤æ‚çš„æ•°å­¦é¢˜ç›®ã€‚");
                } else if (englishAvg > chineseAvg && englishAvg > mathAvg && englishAvg > 80) {
                    suggestions.push("ğŸŒŸ è‹±è¯­å­¦ä¹ è¿›æ­¥æ˜æ˜¾ï¼å¯ä»¥å°è¯•å¬è‹±è¯­æ­Œæ›²ã€‚");
                }

                // é»˜è®¤å»ºè®®
                if (suggestions.length === 0) {
                    suggestions.push("ğŸŒŸ å­¦ä¹ è¿›åº¦è‰¯å¥½ï¼å»ºè®®ä¿æŒå½“å‰çš„å­¦ä¹ èŠ‚å¥ï¼Œç»§ç»­åŠ æ²¹ï¼");
                    suggestions.push("ğŸ“š å¯ä»¥å°è¯•ä¸‰å¤§ç±»å­¦ä¹ å†…å®¹çš„å‡è¡¡å‘å±•ï¼Œå…¨é¢æå‡ï¼");
                }

                const container = document.getElementById('ai-suggestions');
                container.innerHTML = suggestions.map(s => 
                    `<div class="mb-2 p-3 bg-white bg-opacity-20 rounded-lg">${s}</div>`
                ).join('');
            }

            // åˆ›å»ºå­¦ä¹ å†å²å›¾è¡¨
            createLearningChart() {
                const container = document.getElementById('chart-container');
                container.innerHTML = '';
                
                // ç”Ÿæˆæœ€è¿‘7å¤©çš„æ¨¡æ‹Ÿæ•°æ®
                const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
                const data = [20, 35, 15, 40, 25, 30, 45]; // åˆ†é’Ÿæ•°

                days.forEach((day, index) => {
                    const bar = document.createElement('div');
                    const height = Math.max(data[index] * 4, 10); // æœ€å°é«˜åº¦10px
                    
                    bar.className = 'flex flex-col items-center';
                    bar.innerHTML = `
                        <div style="height: ${height}px; width: 30px;" 
                             class="bg-gradient-to-t from-blue-400 to-blue-600 rounded-t-lg mb-2 flex items-end justify-center text-white text-xs font-bold pb-1">
                            ${data[index]}
                        </div>
                        <span class="text-xs text-gray-600">${day}</span>
                    `;
                    
                    container.appendChild(bar);
                });
            }

            // è®°å½•å­¦ä¹ æ´»åŠ¨
            recordActivity(subject, activity, score, timeSpent = 0) {
                console.log(`Recording activity: ${subject}.${activity}, score: ${score}, time: ${timeSpent}`);
                
                // ç¡®ä¿ä¸»ä½“æ•°æ®ç»“æ„å­˜åœ¨
                if (!this.data.subjects[subject]) {
                    this.data.subjects[subject] = {};
                }
                
                // ç¡®ä¿æ´»åŠ¨æ•°æ®ç»“æ„å­˜åœ¨
                if (!this.data.subjects[subject][activity]) {
                    this.data.subjects[subject][activity] = {
                        totalScore: 0,
                        attempts: 0
                    };
                }
                
                const activityData = this.data.subjects[subject][activity];
                activityData.totalScore += score;
                activityData.attempts += 1;
                
                // ç‰¹æ®Šå¤„ç†ï¼šè®°å½•å­¦åˆ°çš„å†…å®¹
                if (activity === 'letters' && !activityData.lettersLearned) {
                    activityData.lettersLearned = [];
                } else if (activity === 'memory' && !activityData.wordsRemembered) {
                    activityData.wordsRemembered = [];
                } else if (activity === 'wordConnect' && !activityData.wordsFound) {
                    activityData.wordsFound = [];
                } else if (activity === 'antonyms' && !activityData.wordsLearned) {
                    activityData.wordsLearned = [];
                } else if (activity === 'poetry' && !activityData.poemsCompleted) {
                    activityData.poemsCompleted = [];
                } else if (activity === 'pinyin' && !activityData.consonantsLearned) {
                    activityData.consonantsLearned = [];
                    activityData.vowelsLearned = [];
                } else if (activity === 'puzzle' && !activityData.levelsCompleted) {
                    activityData.levelsCompleted = [];
                }
                
                // æ›´æ–°å­¦ä¹ æ—¶é—´
                this.data.totalStudyTime += timeSpent;
                this.data.todayStudyTime += timeSpent;
                
                // æ›´æ–°è¿ç»­å­¦ä¹ å¤©æ•°
                this.updateStreakDaysOnActivity();
                
                // ä¿å­˜æ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
                this.saveData();
                this.init();
            }
            
            // åœ¨å­¦ä¹ æ´»åŠ¨æ—¶æ›´æ–°è¿ç»­å­¦ä¹ å¤©æ•°
            updateStreakDaysOnActivity() {
                const today = new Date().toDateString();
                const lastDate = this.data.lastStudyDate;
                
                if (lastDate !== today) {
                    if (lastDate) {
                        const lastStudyDate = new Date(lastDate);
                        const todayDate = new Date(today);
                        const diffTime = todayDate - lastStudyDate;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 1) {
                            // è¿ç»­å­¦ä¹ 
                            this.data.streakDays += 1;
                        } else if (diffDays > 1) {
                            // ä¸­æ–­äº†ï¼Œé‡æ–°å¼€å§‹
                            this.data.streakDays = 1;
                        }
                    } else {
                        // ç¬¬ä¸€æ¬¡å­¦ä¹ 
                        this.data.streakDays = 1;
                    }
                    
                    this.data.lastStudyDate = today;
                }
            }
        }

        // å…¨å±€è¿›åº¦ç®¡ç†å™¨å®ä¾‹
        let progressManager;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            progressManager = new LearningProgressManager();
            
            // æ¨¡æ‹Ÿä¸€äº›å­¦ä¹ æ•°æ®ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰
            if (!progressManager.data.subjects.chinese) {
                // æ·»åŠ ä¸€äº›ç¤ºä¾‹æ•°æ®
                progressManager.data.subjects = {
                    chinese: {
                        pinyin: { totalScore: 320, attempts: 4, consonantsLearned: ['b', 'p', 'm', 'f'], vowelsLearned: ['a', 'o', 'e'] },
                        antonyms: { totalScore: 450, attempts: 6, wordsLearned: [] },
                        poetry: { totalScore: 180, attempts: 2, poemsCompleted: [] }
                    },
                    math: {
                        addition: { totalScore: 850, attempts: 12, bestStreak: 5 },
                        subtraction: { totalScore: 420, attempts: 6, bestStreak: 3 },
                        puzzle: { totalScore: 200, attempts: 3, levelsCompleted: [] }
                    },
                    english: {
                        letters: { totalScore: 160, attempts: 2, lettersLearned: [] },
                        memory: { totalScore: 240, attempts: 3, wordsRemembered: [] },
                        wordConnect: { totalScore: 180, attempts: 2, wordsFound: [] }
                    }
                };
                progressManager.data.streakDays = 3;
                progressManager.data.todayStudyTime = 900; // 15åˆ†é’Ÿ
                progressManager.saveData();
                progressManager.init();
            }
        });

        // å¯¼å‡ºç»™å…¶ä»–é¡µé¢ä½¿ç”¨çš„å‡½æ•°
        window.recordLearningProgress = function(subject, activity, score, timeSpent = 0) {
            if (progressManager) {
                progressManager.recordActivity(subject, activity, score, timeSpent);
            }
        };

        // æŠ¤çœ¼æé†’è®¾ç½®ä¸ wellness.js äº¤äº’
        (function(){
            const STORAGE_KEY = 'eyeCareSettings';
            const DEFAULTS = { enabled: true, intervalMin: 20, breakMin: 2, snoozeMin: 5 };
            function load(){ try{return { ...DEFAULTS, ...(JSON.parse(localStorage.getItem(STORAGE_KEY))||{})}; }catch(_){return { ...DEFAULTS };}}
            function save(s){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(_){} }
            function updateUI(s){
                const enabled = document.getElementById('eye-enabled');
                const dot = document.getElementById('eye-enabled-dot');
                const track = document.getElementById('eye-enabled-track');
                const interval = document.getElementById('eye-interval');
                const intervalVal = document.getElementById('eye-interval-val');
                const brk = document.getElementById('eye-break');
                const brkVal = document.getElementById('eye-break-val');
                const snooze = document.getElementById('eye-snooze');
                const snoozeVal = document.getElementById('eye-snooze-val');
                if(!enabled) return;
                enabled.checked = !!s.enabled; 
                dot.style.transform = enabled.checked ? 'translateX(20px)' : 'translateX(0)';
                if (track) track.style.background = enabled.checked ? '#10B981' : 'rgba(255,255,255,.3)';
                interval.value = s.intervalMin; intervalVal.textContent = `${s.intervalMin} åˆ†é’Ÿ`;
                brk.value = s.breakMin; brkVal.textContent = `${s.breakMin} åˆ†é’Ÿ`;
                snooze.value = s.snoozeMin; snoozeVal.textContent = `${s.snoozeMin} åˆ†é’Ÿ`;
            }
            function dispatch(s){ document.dispatchEvent(new CustomEvent('eye-care-settings-updated',{ detail: s })); }
            document.addEventListener('DOMContentLoaded', () => {
                let s = load(); updateUI(s);
                const enabled = document.getElementById('eye-enabled');
                const interval = document.getElementById('eye-interval');
                const brk = document.getElementById('eye-break');
                const snooze = document.getElementById('eye-snooze');
                const reset = document.getElementById('eye-reset');
                const dot = document.getElementById('eye-enabled-dot');
                const track = document.getElementById('eye-enabled-track');
                enabled.addEventListener('change', ()=>{ s.enabled = enabled.checked; dot.style.transform = enabled.checked ? 'translateX(20px)':'translateX(0)'; if (track) track.style.background = enabled.checked ? '#10B981' : 'rgba(255,255,255,.3)'; save(s); updateUI(s); dispatch(s); });
                interval.addEventListener('input', ()=>{ s.intervalMin = Number(interval.value); save(s); updateUI(s); dispatch(s); });
                brk.addEventListener('input', ()=>{ s.breakMin = Number(brk.value); save(s); updateUI(s); dispatch(s); });
                snooze.addEventListener('input', ()=>{ s.snoozeMin = Number(snooze.value); save(s); updateUI(s); dispatch(s); });
                reset.addEventListener('click', ()=>{ s = { enabled:true, intervalMin:20, breakMin:2, snoozeMin:5 }; save(s); updateUI(s); dispatch(s); });
            });
        })();
    </script>
</body>
</html>