<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学习进度中心 - 智能分析与建议</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script defer src="./wellness.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dasharray 0.35s;
            transform-origin: 50% 50%;
        }
        .ai-suggestion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }
        .achievement-badge {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            margin: 5px;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
        }
        .skill-bar {
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
            margin: 10px 0;
        }
        .skill-progress {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 10px;
            transition: width 1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-6xl mx-auto">
        <!-- 头部导航 -->
        <div class="card p-6 mb-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <button onclick="window.location.href='index.html'" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-full mr-4">
                        <i class="fa fa-home mr-2"></i>返回首页
                    </button>
                    <h1 class="text-3xl font-bold text-gray-800">📊 学习进度中心</h1>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">今日学习时间</p>
                    <p class="text-2xl font-bold text-blue-600" id="today-study-time">0分钟</p>
                </div>
            </div>
        </div>

        <!-- 成就徽章展示（移到顶部） -->
        <div class="card p-6 mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">🏆 成就徽章</h3>
            <div class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4" id="achievements-container">
                <!-- 徽章将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- AI 学习建议卡片 -->
        <div class="ai-suggestion mb-6">
            <div class="flex items-center mb-4">
                <i class="fa fa-robot text-3xl mr-3"></i>
                <h2 class="text-xl font-bold">🤖 AI 学习建议</h2>
            </div>
            <div id="ai-suggestions">
                <p>正在分析您的学习数据，生成个性化建议...</p>
            </div>
        </div>

        <!-- 数据统计面板 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <!-- 总体进度 -->
            <div class="card p-6 text-center">
                <div class="relative w-24 h-24 mx-auto mb-4">
                    <svg class="progress-ring w-full h-full">
                        <circle cx="48" cy="48" r="40" stroke="#f0f0f0" stroke-width="8" fill="none"/>
                        <circle id="overall-progress-circle" cx="48" cy="48" r="40" stroke="#4facfe" 
                                stroke-width="8" fill="none" stroke-dasharray="0 251.2"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span id="overall-percentage" class="text-xl font-bold text-blue-600">0%</span>
                    </div>
                </div>
                <h3 class="font-bold text-gray-700">总体进度</h3>
                <p class="text-sm text-gray-500">所有科目平均</p>
            </div>

            <!-- 连续学习天数 -->
            <div class="card p-6 text-center">
                <i class="fa fa-fire text-4xl text-orange-500 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-700" id="streak-days">0</h3>
                <p class="text-sm text-gray-500">连续学习天数</p>
            </div>

            <!-- 本周正确率 -->
            <div class="card p-6 text-center">
                <i class="fa fa-bullseye text-4xl text-green-500 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-700" id="weekly-accuracy">0%</h3>
                <p class="text-sm text-gray-500">本周正确率</p>
            </div>

            <!-- 获得徽章 -->
            <div class="card p-6 text-center">
                <i class="fa fa-trophy text-4xl text-yellow-500 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-700" id="total-badges">0</h3>
                <p class="text-sm text-gray-500">获得徽章</p>
            </div>
        </div>

        <!-- 学科进度详情 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- 语文类学习进度 -->
            <div class="card p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">📝 语文类学习进度</h3>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">拼音学习</span>
                        <span id="pinyin-score">平均分: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="pinyin-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">反义词挑战</span>
                        <span id="antonyms-score">平均分: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="antonyms-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">诗词拼图</span>
                        <span id="poetry-score">平均分: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="poetry-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-blue-800">
                        <i class="fa fa-book mr-2"></i>
                        <span id="chinese-tip">语文学习要多读多练，日积月累！</span>
                    </p>
                </div>
            </div>

            <!-- 数理思维类学习进度 -->
            <div class="card p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">🧠 数理思维类学习进度</h3>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">加法练习</span>
                        <span id="addition-score">平均分: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="addition-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">减法练习</span>
                        <span id="subtraction-score">平均分: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="subtraction-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">逻辑思维</span>
                        <span id="puzzle-score">平均分: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="puzzle-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-green-800">
                        <i class="fa fa-cogs mr-2"></i>
                        <span id="math-tip">数理思维需要循序渐进，多思考多实践！</span>
                    </p>
                </div>
            </div>
            
            <!-- 英语类学习进度 -->
            <div class="card p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">🌍 英语类学习进度</h3>
            
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">字母认知</span>
                        <span id="letters-score">平均分: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="letters-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">单词记忆</span>
                        <span id="memory-score">平均分: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="memory-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">单词连线</span>
                        <span id="wordconnect-score">平均分: 0</span>
                    </div>
                    <div class="skill-bar">
                        <div id="wordconnect-progress" class="skill-progress" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div class="bg-purple-50 p-4 rounded-lg">
                    <p class="text-sm text-purple-800">
                        <i class="fa fa-globe mr-2"></i>
                        <span id="english-tip">英语学习要多听多练，循序渐进！</span>
                    </p>
                </div>
            </div>
        </div>

        


        <!-- 快速开始学习 -->
        <div class="card p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">🚀 继续学习</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <button onclick="window.location.href='pinyin-game.html'" 
                        class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg transition-colors">
                    <i class="fa fa-book text-2xl mb-2"></i>
                    <p class="font-bold">拼音练习</p>
                    <p class="text-sm opacity-90">继续学习声母韵母</p>
                </button>
                <button onclick="window.location.href='math-practice.html'" 
                        class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg transition-colors">
                    <i class="fa fa-calculator text-2xl mb-2"></i>
                    <p class="font-bold">数学练习</p>
                    <p class="text-sm opacity-90">加减法计算训练</p>
                </button>
                <button onclick="window.location.href='word-connect.html'" 
                        class="bg-teal-500 hover:bg-teal-600 text-white p-4 rounded-lg transition-colors">
                    <i class="fa fa-link text-2xl mb-2"></i>
                    <p class="font-bold">单词连线</p>
                    <p class="text-sm opacity-90">连接字母组成单词</p>
                </button>
                <button onclick="window.location.href='antonym-solo.html'" 
                        class="bg-orange-500 hover:bg-orange-600 text-white p-4 rounded-lg transition-colors">
                    <i class="fa fa-user text-2xl mb-2"></i>
                    <p class="font-bold">反义词挑战</p>
                    <p class="text-sm opacity-90">单人闯关模式</p>
                </button>
                <button onclick="window.location.href='poem-puzzle-solo.html'" 
                        class="bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-lg transition-colors">
                    <i class="fa fa-puzzle-piece text-2xl mb-2"></i>
                    <p class="font-bold">诗词拼图</p>
                    <p class="text-sm opacity-90">拖拽拼图学古诗</p>
                </button>
                <button onclick="window.location.href='antonym-game.html'" 
                        class="bg-red-500 hover:bg-red-600 text-white p-4 rounded-lg transition-colors">
                    <i class="fa fa-users text-2xl mb-2"></i>
                    <p class="font-bold">反义词对战</p>
                    <p class="text-sm opacity-90">双人竞技模式</p>
                </button>
            </div>
        </div>

        <!-- 护眼提醒设置（移动到底部） -->
        <div class="ai-suggestion mb-6 mt-6">
            <div class="flex items-center mb-4">
                <i class="fa fa-eye text-3xl mr-3"></i>
                <h2 class="text-xl font-bold">护眼提醒设置</h2>
            </div>
            <div class="mt-2 bg-white/15 rounded-xl p-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="font-bold">启用/关闭</div>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="eye-enabled" class="sr-only">
                        <div id="eye-enabled-track" class="w-10 h-5 bg-white/30 rounded-full relative">
                            <div id="eye-enabled-dot" class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform"></div>
                        </div>
                        <span class="ml-2 text-sm">启用</span>
                    </label>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-white/90">
                    <div>
                        <div class="mb-1">连续使用分钟（每次提醒间隔）</div>
                        <input id="eye-interval" type="range" min="10" max="40" step="5" class="w-full">
                        <div class="mt-1" id="eye-interval-val">20 分钟</div>
                    </div>
                    <div>
                        <div class="mb-1">休息时长</div>
                        <input id="eye-break" type="range" min="1" max="5" step="1" class="w-full">
                        <div class="mt-1" id="eye-break-val">2 分钟</div>
                    </div>
                    <div>
                        <div class="mb-1">稍后提醒（延后）</div>
                        <input id="eye-snooze" type="range" min="3" max="10" step="1" class="w-full">
                        <div class="mt-1" id="eye-snooze-val">5 分钟</div>
                    </div>
                </div>
                <div class="text-right mt-3">
                    <button id="eye-reset" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-md text-sm">恢复默认</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // T0: unified achievements API
        (function(){
          var s=document.createElement('script');
          s.src='assets/achievements.js?_='+Date.now();
          document.head.appendChild(s);
        })();
        // 学习数据管理类
        class LearningProgressManager {
            constructor() {
                this.data = this.loadData();
                this.init();
            }

            // 加载本地存储数据
            loadData() {
                const defaultData = {
                    totalStudyTime: 0,
                    todayStudyTime: 0,
                    lastStudyDate: null,
                    streakDays: 0,
                    subjects: {
                        pinyin: {
                            consonants: { completed: [], totalScore: 0, attempts: 0 },
                            vowels: { completed: [], totalScore: 0, attempts: 0 }
                        },
                        math: {
                            addition: { totalScore: 0, attempts: 0, bestStreak: 0 },
                            subtraction: { totalScore: 0, attempts: 0, bestStreak: 0 }
                        },
                        vocabulary: {
                            antonyms: { totalScore: 0, attempts: 0, wordsLearned: [] }
                        },
                        english: {
                            letters: { totalScore: 0, attempts: 0, lettersLearned: [] },
                            memory: { totalScore: 0, attempts: 0, wordsRemembered: [] },
                            wordConnect: { totalScore: 0, attempts: 0, wordsFound: [] }
                        }
                    },
                    achievements: [],
                    dailyHistory: {}
                };

                const stored = localStorage.getItem('learningProgress');
                return stored ? { ...defaultData, ...JSON.parse(stored) } : defaultData;
            }

            // 保存数据
            saveData() {
                localStorage.setItem('learningProgress', JSON.stringify(this.data));
            }

            // 初始化界面
            init() {
                this.updateTodayTime();
                this.calculateOverallProgress();
                this.updateStreakDays();
                this.updateSubjectProgress();
                this.generateAchievements();
                this.generateAISuggestions();
            }

            // 更新今日学习时间
            updateTodayTime() {
                const today = new Date().toDateString();
                const lastDate = this.data.lastStudyDate;
                
                if (lastDate !== today) {
                    this.data.todayStudyTime = 0;
                    this.data.lastStudyDate = today;
                }

                document.getElementById('today-study-time').textContent = 
                    Math.round(this.data.todayStudyTime / 60) + '分钟';
            }

            // 计算总体进度
            calculateOverallProgress() {
                let totalProgress = 0;
                let categories = 0;

                const subjects = this.data.subjects;

                // 语文类进度
                const chinese = subjects.chinese || {};
                if (chinese.pinyin?.attempts > 0 || chinese.antonyms?.attempts > 0 || chinese.poetry?.attempts > 0) {
                    let chineseProgress = 0;
                    let chineseCount = 0;
                    
                    if (chinese.pinyin?.attempts > 0) {
                        chineseProgress += chinese.pinyin.totalScore / chinese.pinyin.attempts;
                        chineseCount++;
                    }
                    if (chinese.antonyms?.attempts > 0) {
                        chineseProgress += chinese.antonyms.totalScore / chinese.antonyms.attempts;
                        chineseCount++;
                    }
                    if (chinese.poetry?.attempts > 0) {
                        chineseProgress += chinese.poetry.totalScore / chinese.poetry.attempts;
                        chineseCount++;
                    }
                    
                    if (chineseCount > 0) {
                        totalProgress += (chineseProgress / chineseCount);
                        categories++;
                    }
                }

                // 数理思维类进度
                const math = subjects.math || {};
                if (math.addition?.attempts > 0 || math.subtraction?.attempts > 0 || math.puzzle?.attempts > 0) {
                    let mathProgress = 0;
                    let mathCount = 0;
                    
                    if (math.addition?.attempts > 0) {
                        mathProgress += math.addition.totalScore / math.addition.attempts;
                        mathCount++;
                    }
                    if (math.subtraction?.attempts > 0) {
                        mathProgress += math.subtraction.totalScore / math.subtraction.attempts;
                        mathCount++;
                    }
                    if (math.puzzle?.attempts > 0) {
                        mathProgress += math.puzzle.totalScore / math.puzzle.attempts;
                        mathCount++;
                    }
                    
                    if (mathCount > 0) {
                        totalProgress += (mathProgress / mathCount);
                        categories++;
                    }
                }

                // 英语类进度
                const english = subjects.english || {};
                if (english.letters?.attempts > 0 || english.memory?.attempts > 0 || english.wordConnect?.attempts > 0) {
                    let englishProgress = 0;
                    let englishCount = 0;
                    
                    if (english.letters?.attempts > 0) {
                        englishProgress += english.letters.totalScore / english.letters.attempts;
                        englishCount++;
                    }
                    if (english.memory?.attempts > 0) {
                        englishProgress += english.memory.totalScore / english.memory.attempts;
                        englishCount++;
                    }
                    if (english.wordConnect?.attempts > 0) {
                        englishProgress += english.wordConnect.totalScore / english.wordConnect.attempts;
                        englishCount++;
                    }
                    
                    if (englishCount > 0) {
                        totalProgress += (englishProgress / englishCount);
                        categories++;
                    }
                }

                const overallProgress = categories > 0 ? (totalProgress / categories) : 0;
                
                // 更新环形进度条
                this.updateCircularProgress('overall-progress-circle', overallProgress);
                document.getElementById('overall-percentage').textContent = 
                    Math.round(overallProgress) + '%';
            }

            // 更新环形进度条
            updateCircularProgress(elementId, percentage) {
                const circle = document.getElementById(elementId);
                const radius = 40;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (percentage / 100 * circumference);
                circle.style.strokeDasharray = `${circumference} ${circumference}`;
                circle.style.strokeDashoffset = offset;
            }

            // 更新连续学习天数
            updateStreakDays() {
                // 计算连续学习天数的逻辑
                document.getElementById('streak-days').textContent = this.data.streakDays;
                
                // 计算本周正确率
                const weeklyAccuracy = this.calculateWeeklyAccuracy();
                document.getElementById('weekly-accuracy').textContent = Math.round(weeklyAccuracy) + '%';
            }

            // 计算本周正确率（修复计算错误）
            calculateWeeklyAccuracy() {
                let totalScore = 0;
                let totalAttempts = 0;
                let totalMaxScore = 0;

                Object.values(this.data.subjects).forEach(subject => {
                    Object.values(subject).forEach(activity => {
                        if (activity.totalScore !== undefined && activity.attempts > 0) {
                            totalScore += activity.totalScore;
                            totalAttempts += activity.attempts;
                            // 假设每次游戏满分100分
                            totalMaxScore += activity.attempts * 100;
                        }
                    });
                });

                return totalMaxScore > 0 ? (totalScore / totalMaxScore) * 100 : 0;
            }

            // 更新学科进度
            updateSubjectProgress() {
                // 语文类进度
                const chinese = this.data.subjects.chinese || {};
                
                // 拼音学习
                const pinyinData = chinese.pinyin || {};
                const pinyinAvgScore = pinyinData.attempts > 0 ? (pinyinData.totalScore / pinyinData.attempts) : 0;
                this.updateProgressBar('pinyin', pinyinAvgScore, `平均分: ${Math.round(pinyinAvgScore)}`);
                
                // 反义词挑战
                const antonymsData = chinese.antonyms || {};
                const antonymsAvgScore = antonymsData.attempts > 0 ? (antonymsData.totalScore / antonymsData.attempts) : 0;
                this.updateProgressBar('antonyms', antonymsAvgScore, `平均分: ${Math.round(antonymsAvgScore)}`);
                
                // 诗词拼图
                const poetryData = chinese.poetry || {};
                const poetryAvgScore = poetryData.attempts > 0 ? (poetryData.totalScore / poetryData.attempts) : 0;
                this.updateProgressBar('poetry', poetryAvgScore, `平均分: ${Math.round(poetryAvgScore)}`);

                // 数理思维类进度
                const math = this.data.subjects.math || {};
                
                // 加法练习
                const additionData = math.addition || {};
                const additionAvgScore = additionData.attempts > 0 ? (additionData.totalScore / additionData.attempts) : 0;
                this.updateProgressBar('addition', additionAvgScore, `平均分: ${Math.round(additionAvgScore)}`);
                
                // 减法练习
                const subtractionData = math.subtraction || {};
                const subtractionAvgScore = subtractionData.attempts > 0 ? (subtractionData.totalScore / subtractionData.attempts) : 0;
                this.updateProgressBar('subtraction', subtractionAvgScore, `平均分: ${Math.round(subtractionAvgScore)}`);
                
                // 逻辑思维
                const puzzleData = math.puzzle || {};
                const puzzleAvgScore = puzzleData.attempts > 0 ? (puzzleData.totalScore / puzzleData.attempts) : 0;
                this.updateProgressBar('puzzle', puzzleAvgScore, `平均分: ${Math.round(puzzleAvgScore)}`);

                // 英语类进度
                const english = this.data.subjects.english || {};
                
                // 字母认知
                const lettersData = english.letters || {};
                const lettersAvgScore = lettersData.attempts > 0 ? (lettersData.totalScore / lettersData.attempts) : 0;
                this.updateProgressBar('letters', lettersAvgScore, `平均分: ${Math.round(lettersAvgScore)}`);
                
                // 单词记忆
                const memoryData = english.memory || {};
                const memoryAvgScore = memoryData.attempts > 0 ? (memoryData.totalScore / memoryData.attempts) : 0;
                this.updateProgressBar('memory', memoryAvgScore, `平均分: ${Math.round(memoryAvgScore)}`);
                
                // 单词连线
                const wordConnectData = english.wordConnect || {};
                const wordConnectAvgScore = wordConnectData.attempts > 0 ? (wordConnectData.totalScore / wordConnectData.attempts) : 0;
                this.updateProgressBar('wordconnect', wordConnectAvgScore, `平均分: ${Math.round(wordConnectAvgScore)}`);
            }

            // 更新进度条的辅助方法
            updateProgressBar(id, avgScore, scoreText) {
                const percentage = Math.min(avgScore, 100);
                const scoreElement = document.getElementById(`${id}-score`);
                const progressElement = document.getElementById(`${id}-progress`);
                
                if (scoreElement) scoreElement.textContent = scoreText;
                if (progressElement) {
                    progressElement.style.width = percentage + '%';
                    progressElement.textContent = Math.round(percentage) + '%';
                }
            }

            // 生成成就徽章（统一API：仅展示系统级/global）
            generateAchievements() {
                var self = this;
                function render() {
                    if (!window.achievements || !window.achievements.getAll) {
                        setTimeout(render, 150);
                        return;
                    }
                    // 在展示前，根据当前学习数据同步解锁系统级成就
                    try {
                        var subjects = self.data.subjects || {};
                        var chinese = subjects.chinese || {};
                        var math = subjects.math || {};
                        var english = subjects.english || {};
                        var chineseAttempts = (chinese.pinyin?.attempts || 0) + (chinese.antonyms?.attempts || 0) + (chinese.poetry?.attempts || 0);
                        var mathAttempts = (math.addition?.attempts || 0) + (math.subtraction?.attempts || 0) + (math.puzzle?.attempts || 0);
                        var englishAttempts = (english.letters?.attempts || 0) + (english.memory?.attempts || 0) + (english.wordConnect?.attempts || 0);
                        var totalAttempts = chineseAttempts + mathAttempts + englishAttempts;
                        if (totalAttempts > 0) window.achievements.unlockAchievement('global_first_game');
                        if (self.data.streakDays >= 3) window.achievements.unlockAchievement('global_streak_3');
                        if (self.data.streakDays >= 7) window.achievements.unlockAchievement('global_streak_7');
                        if (chineseAttempts > 0 && mathAttempts > 0 && englishAttempts > 0) {
                            window.achievements.unlockAchievement('global_super_learner');
                        }
                    } catch (_) {}
                    const all = window.achievements.getAll();
                    const globals = all.filter(function(a){ return a.scope === 'global'; });
                    const nonGlobals = all.filter(function(a){ return a.scope !== 'global'; });
                    const container = document.getElementById('achievements-container');
                    container.innerHTML = '';
                    // 系统级
                    globals.forEach(function(a){
                        const earned = !!a.earned;
                        const badge = document.createElement('div');
                        badge.className = `flex flex-col items-center p-3 rounded-xl transition-all duration-300 ${earned ? 'bg-gradient-to-br from-yellow-100 to-orange-100 border-2 border-yellow-300' : 'bg-gray-100 border-2 border-gray-200 opacity-60'}`;
                        badge.innerHTML = `
                            <div class="text-2xl mb-1">${a.icon}</div>
                            <div class="text-xs font-bold text-center text-gray-700">${a.name}</div>
                            <div class="text-xs text-gray-500 text-center mt-1" style="font-size: 10px;">${a.desc}</div>
                        `;
                        badge.title = `${a.name}: ${a.desc} ${earned ? '✅ 已获得' : '❌ 未获得'}`;
                        container.appendChild(badge);
                    });
                    var earnedCount = globals.filter(function(a){ return a.earned; }).length;
                    document.getElementById('total-badges').textContent = earnedCount;

                    // 各游戏成就（预览）
                    var host = container.parentElement; // 当前网格外层
                    var title = document.createElement('h3');
                    title.className = 'text-xl font-bold text-gray-800 mt-8 mb-4';
                    title.textContent = '🎮 各游戏成就（预览）';
                    host.appendChild(title);
                    var gameGrid = document.createElement('div');
                    gameGrid.id = 'achievements-games';
                    gameGrid.className = 'grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4';
                    host.appendChild(gameGrid);
                    nonGlobals.forEach(function(a){
                        const earned = !!a.earned;
                        const badge = document.createElement('div');
                        badge.className = `flex flex-col items-center p-3 rounded-xl transition-all duration-300 ${earned ? 'bg-gradient-to-br from-blue-100 to-cyan-100 border-2 border-blue-300' : 'bg-gray-100 border-2 border-gray-200 opacity-60'}`;
                        badge.innerHTML = `
                            <div class="text-2xl mb-1">${a.icon}</div>
                            <div class="text-xs font-bold text-center text-gray-700">${a.name}</div>
                            <div class="text-xs text-gray-500 text-center mt-1" style="font-size: 10px;">${a.desc}</div>
                        `;
                        badge.title = `${a.name}: ${a.desc} ${earned ? '✅ 已获得' : '❌ 未获得'}`;
                        gameGrid.appendChild(badge);
                    });
                }
                render();
                try {
                    document.addEventListener('achievement-unlocked', function(){ setTimeout(render, 50); });
                } catch(_) {}
            }

            // 生成AI学习建议
            generateAISuggestions() {
                const suggestions = [];
                const subjects = this.data.subjects;
                
                // 语文类建议
                const chinese = subjects.chinese || {};
                let chineseTotal = 0;
                let chineseCount = 0;
                
                if (chinese.pinyin?.attempts > 0) {
                    const pinyinAvg = chinese.pinyin.totalScore / chinese.pinyin.attempts;
                    chineseTotal += pinyinAvg;
                    chineseCount++;
                    if (pinyinAvg < 70) {
                        suggestions.push("📝 拼音学习需要加强，建议多练习声母韵母的组合。");
                    }
                }
                
                if (chinese.antonyms?.attempts > 0) {
                    const antonymsAvg = chinese.antonyms.totalScore / chinese.antonyms.attempts;
                    chineseTotal += antonymsAvg;
                    chineseCount++;
                    if (antonymsAvg < 70) {
                        suggestions.push("🔄 反义词练习还需努力，建议多读课外书积累词汇。");
                    }
                }
                
                if (chinese.poetry?.attempts > 0) {
                    const poetryAvg = chinese.poetry.totalScore / chinese.poetry.attempts;
                    chineseTotal += poetryAvg;
                    chineseCount++;
                    if (poetryAvg < 70) {
                        suggestions.push("🎭 诗词拼图需要多练，建议背诵一些简单的古诗。");
                    }
                }

                // 数理思维类建议
                const math = subjects.math || {};
                let mathTotal = 0;
                let mathCount = 0;
                
                if (math.addition?.attempts > 0) {
                    const additionAvg = math.addition.totalScore / math.addition.attempts;
                    mathTotal += additionAvg;
                    mathCount++;
                    if (additionAvg < 70) {
                        suggestions.push("➕ 加法练习需要更多时间，建议从小数字开始练习。");
                    }
                }
                
                if (math.subtraction?.attempts > 0) {
                    const subtractionAvg = math.subtraction.totalScore / math.subtraction.attempts;
                    mathTotal += subtractionAvg;
                    mathCount++;
                    if (subtractionAvg < 70) {
                        suggestions.push("➖ 减法练习需要加强，可以用实物帮助理解。");
                    }
                }
                
                if (math.puzzle?.attempts > 0) {
                    const puzzleAvg = math.puzzle.totalScore / math.puzzle.attempts;
                    mathTotal += puzzleAvg;
                    mathCount++;
                    if (puzzleAvg < 70) {
                        suggestions.push("🧩 逻辑思维训练需要坚持，多做益智游戏有帮助。");
                    }
                }

                // 英语类建议
                const english = subjects.english || {};
                let englishTotal = 0;
                let englishCount = 0;
                
                if (english.letters?.attempts > 0) {
                    const lettersAvg = english.letters.totalScore / english.letters.attempts;
                    englishTotal += lettersAvg;
                    englishCount++;
                    if (lettersAvg < 70) {
                        suggestions.push("🔤 字母认知需要巩固，建议每天练习字母书写。");
                    }
                }
                
                if (english.memory?.attempts > 0) {
                    const memoryAvg = english.memory.totalScore / english.memory.attempts;
                    englishTotal += memoryAvg;
                    englishCount++;
                    if (memoryAvg < 70) {
                        suggestions.push("🧠 单词记忆需要方法，可以尝试联想记忆法。");
                    }
                }
                
                if (english.wordConnect?.attempts > 0) {
                    const wordConnectAvg = english.wordConnect.totalScore / english.wordConnect.attempts;
                    englishTotal += wordConnectAvg;
                    englishCount++;
                    if (wordConnectAvg < 70) {
                        suggestions.push("🔗 单词连线练习需要加强，多玩英语小游戏。");
                    }
                }

                // 综合建议
                const chineseAvg = chineseCount > 0 ? chineseTotal / chineseCount : 0;
                const mathAvg = mathCount > 0 ? mathTotal / mathCount : 0;
                const englishAvg = englishCount > 0 ? englishTotal / englishCount : 0;
                
                // 基于学习频率的建议
                if (this.data.streakDays < 2) {
                    suggestions.push("📅 建议建立每日学习习惯，每天15-20分钟效果最佳。");
                }

                // 个性化鼓励
                if (chineseAvg > mathAvg && chineseAvg > englishAvg && chineseAvg > 80) {
                    suggestions.push("✨ 你的语文表现很棒！可以尝试更有挑战性的语文游戏。");
                } else if (mathAvg > chineseAvg && mathAvg > englishAvg && mathAvg > 80) {
                    suggestions.push("🎯 数理思维很强！建议尝试更复杂的数学题目。");
                } else if (englishAvg > chineseAvg && englishAvg > mathAvg && englishAvg > 80) {
                    suggestions.push("🌟 英语学习进步明显！可以尝试听英语歌曲。");
                }

                // 默认建议
                if (suggestions.length === 0) {
                    suggestions.push("🌟 学习进度良好！建议保持当前的学习节奏，继续加油！");
                    suggestions.push("📚 可以尝试三大类学习内容的均衡发展，全面提升！");
                }

                const container = document.getElementById('ai-suggestions');
                container.innerHTML = suggestions.map(s => 
                    `<div class="mb-2 p-3 bg-white bg-opacity-20 rounded-lg">${s}</div>`
                ).join('');
            }

            // 创建学习历史图表
            createLearningChart() {
                const container = document.getElementById('chart-container');
                container.innerHTML = '';
                
                // 生成最近7天的模拟数据
                const days = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
                const data = [20, 35, 15, 40, 25, 30, 45]; // 分钟数

                days.forEach((day, index) => {
                    const bar = document.createElement('div');
                    const height = Math.max(data[index] * 4, 10); // 最小高度10px
                    
                    bar.className = 'flex flex-col items-center';
                    bar.innerHTML = `
                        <div style="height: ${height}px; width: 30px;" 
                             class="bg-gradient-to-t from-blue-400 to-blue-600 rounded-t-lg mb-2 flex items-end justify-center text-white text-xs font-bold pb-1">
                            ${data[index]}
                        </div>
                        <span class="text-xs text-gray-600">${day}</span>
                    `;
                    
                    container.appendChild(bar);
                });
            }

            // 记录学习活动
            recordActivity(subject, activity, score, timeSpent = 0) {
                console.log(`Recording activity: ${subject}.${activity}, score: ${score}, time: ${timeSpent}`);
                
                // 确保主体数据结构存在
                if (!this.data.subjects[subject]) {
                    this.data.subjects[subject] = {};
                }
                
                // 确保活动数据结构存在
                if (!this.data.subjects[subject][activity]) {
                    this.data.subjects[subject][activity] = {
                        totalScore: 0,
                        attempts: 0
                    };
                }
                
                const activityData = this.data.subjects[subject][activity];
                activityData.totalScore += score;
                activityData.attempts += 1;
                
                // 特殊处理：记录学到的内容
                if (activity === 'letters' && !activityData.lettersLearned) {
                    activityData.lettersLearned = [];
                } else if (activity === 'memory' && !activityData.wordsRemembered) {
                    activityData.wordsRemembered = [];
                } else if (activity === 'wordConnect' && !activityData.wordsFound) {
                    activityData.wordsFound = [];
                } else if (activity === 'antonyms' && !activityData.wordsLearned) {
                    activityData.wordsLearned = [];
                } else if (activity === 'poetry' && !activityData.poemsCompleted) {
                    activityData.poemsCompleted = [];
                } else if (activity === 'pinyin' && !activityData.consonantsLearned) {
                    activityData.consonantsLearned = [];
                    activityData.vowelsLearned = [];
                } else if (activity === 'puzzle' && !activityData.levelsCompleted) {
                    activityData.levelsCompleted = [];
                }
                
                // 更新学习时间
                this.data.totalStudyTime += timeSpent;
                this.data.todayStudyTime += timeSpent;
                
                // 更新连续学习天数
                this.updateStreakDaysOnActivity();
                
                // 保存数据并更新显示
                this.saveData();
                this.init();
            }
            
            // 在学习活动时更新连续学习天数
            updateStreakDaysOnActivity() {
                const today = new Date().toDateString();
                const lastDate = this.data.lastStudyDate;
                
                if (lastDate !== today) {
                    if (lastDate) {
                        const lastStudyDate = new Date(lastDate);
                        const todayDate = new Date(today);
                        const diffTime = todayDate - lastStudyDate;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 1) {
                            // 连续学习
                            this.data.streakDays += 1;
                        } else if (diffDays > 1) {
                            // 中断了，重新开始
                            this.data.streakDays = 1;
                        }
                    } else {
                        // 第一次学习
                        this.data.streakDays = 1;
                    }
                    
                    this.data.lastStudyDate = today;
                }
            }
        }

        // 全局进度管理器实例
        let progressManager;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            progressManager = new LearningProgressManager();
            
            // 模拟一些学习数据（仅用于演示）
            if (!progressManager.data.subjects.chinese) {
                // 添加一些示例数据
                progressManager.data.subjects = {
                    chinese: {
                        pinyin: { totalScore: 320, attempts: 4, consonantsLearned: ['b', 'p', 'm', 'f'], vowelsLearned: ['a', 'o', 'e'] },
                        antonyms: { totalScore: 450, attempts: 6, wordsLearned: [] },
                        poetry: { totalScore: 180, attempts: 2, poemsCompleted: [] }
                    },
                    math: {
                        addition: { totalScore: 850, attempts: 12, bestStreak: 5 },
                        subtraction: { totalScore: 420, attempts: 6, bestStreak: 3 },
                        puzzle: { totalScore: 200, attempts: 3, levelsCompleted: [] }
                    },
                    english: {
                        letters: { totalScore: 160, attempts: 2, lettersLearned: [] },
                        memory: { totalScore: 240, attempts: 3, wordsRemembered: [] },
                        wordConnect: { totalScore: 180, attempts: 2, wordsFound: [] }
                    }
                };
                progressManager.data.streakDays = 3;
                progressManager.data.todayStudyTime = 900; // 15分钟
                progressManager.saveData();
                progressManager.init();
            }
        });

        // 导出给其他页面使用的函数
        window.recordLearningProgress = function(subject, activity, score, timeSpent = 0) {
            if (progressManager) {
                progressManager.recordActivity(subject, activity, score, timeSpent);
            }
        };

        // 护眼提醒设置与 wellness.js 交互
        (function(){
            const STORAGE_KEY = 'eyeCareSettings';
            const DEFAULTS = { enabled: true, intervalMin: 20, breakMin: 2, snoozeMin: 5 };
            function load(){ try{return { ...DEFAULTS, ...(JSON.parse(localStorage.getItem(STORAGE_KEY))||{})}; }catch(_){return { ...DEFAULTS };}}
            function save(s){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(_){} }
            function updateUI(s){
                const enabled = document.getElementById('eye-enabled');
                const dot = document.getElementById('eye-enabled-dot');
                const track = document.getElementById('eye-enabled-track');
                const interval = document.getElementById('eye-interval');
                const intervalVal = document.getElementById('eye-interval-val');
                const brk = document.getElementById('eye-break');
                const brkVal = document.getElementById('eye-break-val');
                const snooze = document.getElementById('eye-snooze');
                const snoozeVal = document.getElementById('eye-snooze-val');
                if(!enabled) return;
                enabled.checked = !!s.enabled; 
                dot.style.transform = enabled.checked ? 'translateX(20px)' : 'translateX(0)';
                if (track) track.style.background = enabled.checked ? '#10B981' : 'rgba(255,255,255,.3)';
                interval.value = s.intervalMin; intervalVal.textContent = `${s.intervalMin} 分钟`;
                brk.value = s.breakMin; brkVal.textContent = `${s.breakMin} 分钟`;
                snooze.value = s.snoozeMin; snoozeVal.textContent = `${s.snoozeMin} 分钟`;
            }
            function dispatch(s){ document.dispatchEvent(new CustomEvent('eye-care-settings-updated',{ detail: s })); }
            document.addEventListener('DOMContentLoaded', () => {
                let s = load(); updateUI(s);
                const enabled = document.getElementById('eye-enabled');
                const interval = document.getElementById('eye-interval');
                const brk = document.getElementById('eye-break');
                const snooze = document.getElementById('eye-snooze');
                const reset = document.getElementById('eye-reset');
                const dot = document.getElementById('eye-enabled-dot');
                const track = document.getElementById('eye-enabled-track');
                enabled.addEventListener('change', ()=>{ s.enabled = enabled.checked; dot.style.transform = enabled.checked ? 'translateX(20px)':'translateX(0)'; if (track) track.style.background = enabled.checked ? '#10B981' : 'rgba(255,255,255,.3)'; save(s); updateUI(s); dispatch(s); });
                interval.addEventListener('input', ()=>{ s.intervalMin = Number(interval.value); save(s); updateUI(s); dispatch(s); });
                brk.addEventListener('input', ()=>{ s.breakMin = Number(brk.value); save(s); updateUI(s); dispatch(s); });
                snooze.addEventListener('input', ()=>{ s.snoozeMin = Number(snooze.value); save(s); updateUI(s); dispatch(s); });
                reset.addEventListener('click', ()=>{ s = { enabled:true, intervalMin:20, breakMin:2, snoozeMin:5 }; save(s); updateUI(s); dispatch(s); });
            });
        })();
    </script>
</body>
</html>