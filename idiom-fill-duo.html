<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆè¯­å¡«ç©ºå¤§æŒ‘æˆ˜ - åŒäººå¯¹æˆ˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script defer src="./assets/achievements.js"></script>
    <script defer src="./wellness.js"></script>
</head>
<body class="bg-gradient-to-b from-blue-50 to-indigo-50 min-h-screen font-sans text-gray-800 overflow-hidden">
    <!-- å¼€å§‹ç•Œé¢ -->
    <div id="start-screen" class="flex flex-col items-center justify-center h-screen p-6">
        <button onclick="window.location.href='index.html'" class="absolute top-4 right-4 bg-white/90 px-4 py-2 rounded-full shadow-lg text-sm font-bold text-gray-600">
            <i class="fa fa-home mr-2"></i>é¦–é¡µ
        </button>
        
        <div class="text-center max-w-lg mx-auto bg-white rounded-3xl shadow-2xl p-8">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-cyan-500 mb-4">æˆè¯­å¡«ç©ºå¤§æŒ‘æˆ˜</h1>
            <p class="text-lg mb-6">ä¸¤ä¸ªäººï¼Œä¸€äººä¸€è¾¹<br>æ‰¾å‡ºæ­£ç¡®çš„æˆè¯­ï¼Œçœ‹è°æ›´å¿«ï¼</p>
            
            <div class="flex justify-center mb-8">
                <div class="w-24 h-24 bg-red-500 rounded-full flex items-center justify-center text-white text-4xl shadow-lg">
                    <i class="fa fa-user"></i>
                </div>
                <div class="mx-4 text-2xl flex items-center">VS</div>
                <div class="w-24 h-24 bg-cyan-500 rounded-full flex items-center justify-center text-white text-4xl shadow-lg">
                    <i class="fa fa-user"></i>
                </div>
            </div>
            
            <div class="mb-6 flex items-center justify-center gap-4 bg-gray-50 rounded-2xl p-4">
                <i class="fa fa-clock-o text-gray-600"></i>
                <span class="text-gray-700 font-medium">å€’è®¡æ—¶æ¨¡å¼</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="timer-toggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
                <span class="text-xs text-gray-500" id="timer-description">æ¯é¢˜10ç§’é™æ—¶</span>
            </div>
            
            <div id="badge-preview" class="mt-6">
                <h3 class="text-sm font-bold mb-2">æˆ‘çš„å¾½ç« </h3>
                <div id="badge-preview-grid" class="flex justify-center gap-3 flex-wrap"></div>
            </div>

            <button id="start-btn" class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold py-3 px-8 rounded-full text-xl shadow-lg transition-all duration-300 hover:scale-105 active:scale-95">
                å¼€å§‹æ¸¸æˆ <i class="fa fa-play ml-2"></i>
            </button>

            <div class="mt-6 text-sm text-gray-500">
                <p>é€‚åˆå¹´é¾„ï¼š6-9å²</p>
            </div>
        </div>
        
        <div class="absolute top-10 left-10 text-5xl text-red-500/30">
            <i class="fa fa-star"></i>
        </div>
        <div class="absolute bottom-10 right-10 text-5xl text-cyan-500/30">
            <i class="fa fa-heart"></i>
        </div>
    </div>

    <!-- æ¸¸æˆç•Œé¢ -->
    <div id="game-screen" class="hidden h-screen flex flex-col">
        <div class="flex justify-between items-center p-4 bg-white/80 shadow-md">
            <div class="flex items-center gap-3">
                <button onclick="window.location.href='index.html'" class="bg-white/90 px-3 py-2 rounded-full shadow-md text-sm font-bold text-gray-600">
                    <i class="fa fa-home mr-1"></i>é¦–é¡µ
                </button>
                <div class="bg-yellow-400 px-4 py-2 rounded-full text-sm font-bold shadow-md">
                    <span id="round-counter">ç¬¬1è½®</span> / å…±10è½®
                </div>
            </div>
            
            <div id="timer" class="text-2xl font-bold text-yellow-500 bg-white/90 px-6 py-2 rounded-full shadow-md">
                <i class="fa fa-clock-o mr-2"></i><span id="countdown">10</span>
            </div>
        </div>

        <div class="flex-1 flex flex-col lg:flex-row">
            <!-- ç©å®¶1åŒºåŸŸ -->
            <div class="flex-1 flex flex-col items-center justify-center p-6 bg-gradient-to-br from-red-50 to-pink-50">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center text-white text-3xl shadow-lg mb-3">
                        <i class="fa fa-user"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-red-500">ç©å®¶1</h3>
                    <div class="text-4xl font-bold text-red-500 mt-2" id="score-player1">0</div>
                </div>
                
                <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                    <div class="text-2xl font-bold text-gray-800 mb-4" id="idiom-player1">å®ˆ_å¾…å…”</div>
                    <div class="text-lg text-gray-600 mb-6" id="pinyin-player1">shÇ’u _ dÃ i tÃ¹</div>
                    <div class="text-sm text-gray-500 mb-4" id="hint-player1">ç­‰å¾…å…”å­æ’åˆ°æ ‘ä¸Š</div>
                    
                    <div id="options-player1" class="grid grid-cols-2 gap-3">
                    </div>
                </div>
            </div>

            <div class="hidden lg:block w-1 bg-gradient-to-b from-transparent via-yellow-400 to-transparent"></div>

            <!-- ç©å®¶2åŒºåŸŸ -->
            <div class="flex-1 flex flex-col items-center justify-center p-6 bg-gradient-to-br from-cyan-50 to-blue-50">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-cyan-500 rounded-full flex items-center justify-center text-white text-3xl shadow-lg mb-3">
                        <i class="fa fa-user"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-cyan-500">ç©å®¶2</h3>
                    <div class="text-4xl font-bold text-cyan-500 mt-2" id="score-player2">0</div>
                </div>
                
                <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                    <div class="text-2xl font-bold text-gray-800 mb-4" id="idiom-player2">å®ˆ_å¾…å…”</div>
                    <div class="text-lg text-gray-600 mb-6" id="pinyin-player2">shÇ’u _ dÃ i tÃ¹</div>
                    <div class="text-sm text-gray-500 mb-4" id="hint-player2">ç­‰å¾…å…”å­æ’åˆ°æ ‘ä¸Š</div>
                    
                    <div id="options-player2" class="grid grid-cols-2 gap-3">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»“æœç•Œé¢ -->
    <div id="result-screen" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full mx-4 text-center">
            <div class="text-6xl mb-4" id="result-icon">ğŸ†</div>
            <h2 class="text-3xl font-bold mb-4" id="result-title">æ¸¸æˆç»“æŸï¼</h2>
            <div class="text-xl mb-6">
                <div class="mb-2">ç©å®¶1: <span class="font-bold text-red-500" id="final-score-player1">0</span>åˆ†</div>
                <div class="mb-2">ç©å®¶2: <span class="font-bold text-cyan-500" id="final-score-player2">0</span>åˆ†</div>
                <div class="text-2xl font-bold mt-4" id="winner-text">å¹³å±€ï¼</div>
            </div>
            <div class="flex gap-4 justify-center">
                <button onclick="restartGame()" class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 hover:scale-105 active:scale-95">
                    å†æ¥ä¸€å±€
                </button>
                <button onclick="window.location.href='index.html'" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 hover:scale-105 active:scale-95">
                    è¿”å›é¦–é¡µ
                </button>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            currentRound: 1,
            totalRounds: 10,
            scores: { player1: 0, player2: 0 },
            currentQuestions: { player1: null, player2: null },
            isTimerEnabled: true,
            timeLeft: 10,
            timer: null
        };

        // æˆè¯­æ•°æ®åº“
        const idiomDatabase = [
            { idiom: 'å®ˆæ ªå¾…å…”', missing: 'æ ª', pinyin: 'shÇ’u zhÅ« dÃ i tÃ¹', hint: 'ç­‰å¾…å…”å­æ’åˆ°æ ‘ä¸Š' },
            { idiom: 'ç”»è›‡æ·»è¶³', missing: 'è¶³', pinyin: 'huÃ  shÃ© tiÄn zÃº', hint: 'å¤šæ­¤ä¸€ä¸¾' },
            { idiom: 'å¯¹ç‰›å¼¹ç´', missing: 'ç´', pinyin: 'duÃ¬ niÃº tÃ¡n qÃ­n', hint: 'å¯¹ä¸æ‡‚çš„äººè¯´æ·±å¥¥çš„è¯' },
            { idiom: 'äº¡ç¾Šè¡¥ç‰¢', missing: 'ç‰¢', pinyin: 'wÃ¡ng yÃ¡ng bÇ” lÃ¡o', hint: 'åŠæ—¶è¡¥æ•‘' },
            { idiom: 'äº•åº•ä¹‹è›™', missing: 'è›™', pinyin: 'jÇng dÇ zhÄ« wÄ', hint: 'è§è¯†çŸ­æµ…' },
            { idiom: 'å­¦è€Œä¸åŒ', missing: 'åŒ', pinyin: 'xuÃ© Ã©r bÃ¹ yÃ n', hint: 'å­¦ä¹ æ°¸ä¸æ»¡è¶³' },
            { idiom: 'æ¸©æ•…çŸ¥æ–°', missing: 'æ–°', pinyin: 'wÄ“n gÃ¹ zhÄ« xÄ«n', hint: 'å¤ä¹ æ—§çŸ¥è¯†å¾—åˆ°æ–°ç†è§£' },
            { idiom: 'ä¸è€»ä¸‹é—®', missing: 'é—®', pinyin: 'bÃ¹ chÇ xiÃ  wÃ¨n', hint: 'è™šå¿ƒå‘åˆ«äººè¯·æ•™' }
        ];

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            gameState.currentRound = 1;
            gameState.scores = { player1: 0, player2: 0 };
            
            generateNewQuestions();
            updateDisplay();
            
            if (gameState.isTimerEnabled) {
                startTimer();
            }
        }

        // ç”Ÿæˆæ–°é¢˜ç›®
        function generateNewQuestions() {
            const shuffled = [...idiomDatabase].sort(() => Math.random() - 0.5);
            gameState.currentQuestions.player1 = shuffled[0];
            gameState.currentQuestions.player2 = shuffled[1] || shuffled[0];
            
            displayQuestion('player1');
            displayQuestion('player2');
        }

        // æ˜¾ç¤ºé¢˜ç›®
        function displayQuestion(player) {
            const question = gameState.currentQuestions[player];
            if (!question) return;
            
            const idiomEl = document.getElementById(`idiom-${player}`);
            const pinyinEl = document.getElementById(`pinyin-${player}`);
            const hintEl = document.getElementById(`hint-${player}`);
            const optionsEl = document.getElementById(`options-${player}`);
            
            const idiom = question.idiom;
            const missing = question.missing;
            const missingIndex = idiom.indexOf(missing);
            
            let displayText = '';
            for (let i = 0; i < idiom.length; i++) {
                if (i === missingIndex) {
                    displayText += '<span class="text-orange-400 border-b-2 border-transparent px-1">_</span>';
                } else {
                    displayText += idiom[i];
                }
            }
            idiomEl.innerHTML = displayText;
            
            const pinyin = question.pinyin;
            let displayPinyin = '';
            for (let i = 0; i < pinyin.split(' ').length; i++) {
                if (i === missingIndex) {
                    displayPinyin += '<span class="text-orange-400 border-b-2 border-transparent px-1">_</span>';
                } else {
                    displayPinyin += pinyin.split(' ')[i];
                }
                if (i < pinyin.split(' ').length - 1) {
                    displayPinyin += ' ';
                }
            }
            pinyinEl.innerHTML = displayPinyin;
            
            hintEl.textContent = question.hint;
            generateOptions(player, question);
        }

        // ç”Ÿæˆé€‰é¡¹
        function generateOptions(player, question) {
            const optionsEl = document.getElementById(`options-${player}`);
            const correctAnswer = question.missing;
            
            const allChars = 'å¤©åœ°äººå±±æ°´ç«æœ¨é‡‘åœŸæ—¥æœˆæ˜Ÿè¾°é£äº‘é›¨é›ªèŠ±è‰æ ‘æœ¨é¸Ÿå…½è™«é±¼';
            let wrongOptions = [];
            while (wrongOptions.length < 3) {
                const char = allChars[Math.floor(Math.random() * allChars.length)];
                if (char !== correctAnswer && !wrongOptions.includes(char)) {
                    wrongOptions.push(char);
                }
            }
            
            const allOptions = [...wrongOptions, correctAnswer].sort(() => Math.random() - 0.5);
            
            optionsEl.innerHTML = allOptions.map(option => `
                <button class="bg-white border-2 border-gray-200 rounded-2xl p-4 text-center cursor-pointer transition-all duration-300 text-xl font-bold text-gray-800 shadow-lg hover:shadow-xl hover:scale-105" 
                        onclick="selectOption('${player}', '${option}', this)">
                    ${option}
                </button>
            `).join('');
        }

        // é€‰æ‹©é€‰é¡¹
        function selectOption(player, selected, optionEl) {
            const question = gameState.currentQuestions[player];
            const correctAnswer = question.missing;
            const isCorrect = selected === correctAnswer;
            
            if (isCorrect) {
                optionEl.style.backgroundColor = '#10B981';
                optionEl.style.color = 'white';
                
                const timeBonus = Math.max(0, Math.floor(gameState.timeLeft / 2));
                const score = 10 + timeBonus;
                gameState.scores[player] += score;
                
                if (window.achievements) {
                    if (gameState.scores[player] >= 50) {
                        window.achievements.unlockAchievement('combo_duo');
                    }
                    if (gameState.currentRound === 1 && gameState.scores[player] > 0) {
                        window.achievements.unlockAchievement('first_win');
                    }
                }
            } else {
                optionEl.style.backgroundColor = '#EF4444';
                optionEl.style.color = 'white';
            }
            
            const optionsEl = document.getElementById(`options-${player}`);
            optionsEl.querySelectorAll('button').forEach(btn => {
                btn.disabled = true;
                btn.style.cursor = 'not-allowed';
            });
            
            updateDisplay();
            
            if (bothPlayersAnswered()) {
                setTimeout(() => {
                    nextRound();
                }, 1500);
            }
        }

        // æ£€æŸ¥ä¸¤ä¸ªç©å®¶æ˜¯å¦éƒ½ç­”å®Œäº†
        function bothPlayersAnswered() {
            const player1Answered = document.querySelector('#options-player1 button:disabled');
            const player2Answered = document.querySelector('#options-player2 button:disabled');
            return player1Answered && player2Answered;
        }

        // ä¸‹ä¸€è½®
        function nextRound() {
            gameState.currentRound++;
            
            if (gameState.currentRound > gameState.totalRounds) {
                endGame();
                return;
            }
            
            generateNewQuestions();
            updateDisplay();
            
            if (gameState.isTimerEnabled) {
                resetTimer();
                startTimer();
            }
        }

        // ç»“æŸæ¸¸æˆ
        function endGame() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            document.getElementById('final-score-player1').textContent = gameState.scores.player1;
            document.getElementById('final-score-player2').textContent = gameState.scores.player2;
            
            const winnerText = document.getElementById('winner-text');
            if (gameState.scores.player1 > gameState.scores.player2) {
                winnerText.textContent = 'ç©å®¶1è·èƒœï¼';
                winnerText.className = 'text-2xl font-bold mt-4 text-red-500';
            } else if (gameState.scores.player2 > gameState.scores.player1) {
                winnerText.textContent = 'ç©å®¶2è·èƒœï¼';
                winnerText.className = 'text-2xl font-bold mt-4 text-cyan-500';
            } else {
                winnerText.textContent = 'å¹³å±€ï¼';
                winnerText.className = 'text-2xl font-bold mt-4 text-gray-600';
            }
            
            if (window.recordLearningProgress) {
                const totalScore = gameState.scores.player1 + gameState.scores.player2;
                const avgScore = Math.round(totalScore / 2);
                window.recordLearningProgress('chinese', 'idioms', avgScore, gameState.totalRounds * 10);
            }
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            document.getElementById('result-screen').classList.add('hidden');
            startGame();
        }

        // å¼€å§‹è®¡æ—¶
        function startTimer() {
            if (!gameState.isTimerEnabled) return;
            
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('countdown').textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    setTimeout(() => {
                        nextRound();
                    }, 1000);
                }
            }, 1000);
        }

        // é‡ç½®è®¡æ—¶å™¨
        function resetTimer() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            gameState.timeLeft = 10;
            document.getElementById('countdown').textContent = gameState.timeLeft;
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            document.getElementById('score-player1').textContent = gameState.scores.player1;
            document.getElementById('score-player2').textContent = gameState.scores.player2;
            document.getElementById('round-counter').textContent = `ç¬¬${gameState.currentRound}è½®`;
        }

        // å€’è®¡æ—¶å¼€å…³
        document.getElementById('timer-toggle').addEventListener('change', function() {
            gameState.isTimerEnabled = this.checked;
            const description = document.getElementById('timer-description');
            if (gameState.isTimerEnabled) {
                description.textContent = 'æ¯é¢˜10ç§’é™æ—¶';
            } else {
                description.textContent = 'æ— æ—¶é—´é™åˆ¶';
            }
        });

        // å¼€å§‹æŒ‰é’®äº‹ä»¶
        document.getElementById('start-btn').addEventListener('click', startGame);

        // å¾½ç« é¢„è§ˆ
        (function(){
            const GAME_KEY = 'idiom_fill_duo';
            const badgeDefs = [
                { id: 'first_win', name: 'é¦–èƒœè¾¾æˆ', icon: 'ğŸ¯' },
                { id: 'combo_duo', name: 'è¿å‡»è¾¾äºº', icon: 'ğŸ”¥' },
                { id: 'speed_duel', name: 'æé€Ÿå¯¹å†³', icon: 'âš¡' },
                { id: 'round_master', name: 'å›åˆå¤§å¸ˆ', icon: 'ğŸ†' },
                { id: 'perfect_round', name: 'å®Œç¾å›åˆ', icon: 'ğŸ’' }
            ];
            function getEarnedIds(){
                try { return JSON.parse(localStorage.getItem('earnedAchievements_' + GAME_KEY) || '[]'); } catch(_) { return []; }
            }
            function renderBadgePreview(){
                const grid = document.getElementById('badge-preview-grid');
                if(!grid) return;
                const owned = new Set(getEarnedIds());
                grid.innerHTML = badgeDefs.map(a => {
                    const earned = owned.has(a.id);
                    const base = earned ? 'from-yellow-100 to-orange-100 border-yellow-300 text-amber-900' : 'from-gray-50 to-gray-100 border-gray-200 text-gray-400 opacity-80';
                    return `
                        <div class="relative w-20 h-20 rounded-2xl border-2 bg-gradient-to-br ${base} shadow-sm flex flex-col items-center justify-center overflow-hidden" title="${a.name}">
                            <div class="text-2xl mb-1">${a.icon}</div>
                            <div class="text-[10px] font-bold text-center leading-tight px-1">${a.name}</div>
                            ${earned ? '<div class="absolute right-1 top-1 bg-amber-400 text-white text-[10px] px-1 rounded-full shadow">å·²è·</div>' : '<div class="absolute right-1 top-1 bg-gray-400 text-white text-[10px] px-1 rounded-full shadow">æœªè·</div>'}
                        </div>`;
                }).join('');
            }
            document.addEventListener('DOMContentLoaded', renderBadgePreview);
        })();
    </script>
</body>
</html> 